
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../lexicon/">
      
      
        <link rel="next" href="../recipes/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Lifetime of a session - Sozu Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lifetime-of-a-session" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Sozu Documentation" class="md-header__button md-logo" aria-label="Sozu Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sozu Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lifetime of a session
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/forkdo/sozu.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    forkdo/sozu
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Sozu Documentation" class="md-nav__button md-logo" aria-label="Sozu Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Sozu Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/forkdo/sozu.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    forkdo/sozu
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    English Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    English Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to use
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configure_cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_configuration_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration Example
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design_motivation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Motivation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging_strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging Strategies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexicon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lexicon
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Lifetime of a session
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifetime of a session
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-does-mio-do" class="md-nav__link">
    <span class="md-ellipsis">
      
        What does mio do?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keep-track-of-sessions-with-the-sessionmanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keep track of sessions with the SessionManager
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-proxys" class="md-nav__link">
    <span class="md-ellipsis">
      
        What are Proxys?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#accepting-a-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Accepting a connection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Accepting a connection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-event-loop-on-tcp-sockets" class="md-nav__link">
    <span class="md-ellipsis">
      
        An event loop on TCP sockets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consuming-the-accept-queue" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consuming the accept queue
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating sessions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-zombie-sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check for zombie sessions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-a-session-reads-data-from-the-front-socket" class="md-nav__link">
    <span class="md-ellipsis">
      
        How a Session reads data from the front socket
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How a Session reads data from the front socket">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bring-in-the-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bring in the state machine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-the-backend" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find the backend
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect-to-the-backend-servers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect to the backend servers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Connect to the backend servers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keep-a-session-alive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keep a session alive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sticky-session-stick-a-front-to-one-backend-only" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sticky session: stick a front to one backend only
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sending-data-to-the-back-socket" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sending data to the back socket
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-big-u-turn-forwarding-from-backend-to-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      
        The big U-turn: forwarding from backend to frontend
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-end-of-a-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        The end of a session
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recipes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools_libraries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tools and Libraries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_you_should_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why you should use Sozu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Main README
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Chinese Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Chinese Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概述
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    入门
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何使用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configure_cli_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI 配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_configuration_example_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI 配置示例
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    架构
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design_motivation_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    设计动机
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基准测试
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging_strategies_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    调试策略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexicon_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    词汇表
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifetime_of_a_session_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    会话生命周期
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    配方
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools_libraries_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    工具和库
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_you_should_use_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    为何使用 Sozu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../README_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    主 README
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-does-mio-do" class="md-nav__link">
    <span class="md-ellipsis">
      
        What does mio do?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keep-track-of-sessions-with-the-sessionmanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keep track of sessions with the SessionManager
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-are-proxys" class="md-nav__link">
    <span class="md-ellipsis">
      
        What are Proxys?
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#accepting-a-connection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Accepting a connection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Accepting a connection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#an-event-loop-on-tcp-sockets" class="md-nav__link">
    <span class="md-ellipsis">
      
        An event loop on TCP sockets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consuming-the-accept-queue" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consuming the accept queue
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating sessions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-for-zombie-sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check for zombie sessions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-a-session-reads-data-from-the-front-socket" class="md-nav__link">
    <span class="md-ellipsis">
      
        How a Session reads data from the front socket
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="How a Session reads data from the front socket">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bring-in-the-state-machine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Bring in the state machine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-the-backend" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find the backend
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect-to-the-backend-servers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect to the backend servers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Connect to the backend servers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keep-a-session-alive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Keep a session alive
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sticky-session-stick-a-front-to-one-backend-only" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sticky session: stick a front to one backend only
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sending-data-to-the-back-socket" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sending data to the back socket
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-big-u-turn-forwarding-from-backend-to-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      
        The big U-turn: forwarding from backend to frontend
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-end-of-a-session" class="md-nav__link">
    <span class="md-ellipsis">
      
        The end of a session
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lifetime-of-a-session">Lifetime of a session</h1>
<p>A session is the core unit of Sōzu's business logic: forwarding traffic from a
frontend to a backend and vice-versa.</p>
<p>In this document, we will explore what happens to a client session, from the
creation of the socket, to its shutdown, with all the steps describing how the
HTTP request and response can happen</p>
<p>Before we dive into the creation, lifetime and death of sessions, we need to
understand two concepts that are entirely segregated in Sōzu:</p>
<ul>
<li>the socket handling with the <a href="https://docs.rs/mio/0.7.13/mio/">mio</a> crate</li>
<li>the <code>SessionManager</code> that keeps track of all sessions</li>
</ul>
<h3 id="what-does-mio-do">What does mio do?</h3>
<p>Mio allows us to listen on socket events. For instance we may use TCP sockets to
wait for connection and mio informs us when that socket is readable or when a socket has
data to read, or was closed by the peer, or a timer triggered...</p>
<p>Mio provides an abstraction over the linux syscall <a href="https://man7.org/linux/man-pages/man7/epoll.7.html">epoll</a>.
This epoll syscall allows us to register file descriptors, so that the kernel notifies
us whenever something happens to those file descriptors</p>
<p>At the end of the day, sockets are just raw file descriptors. We use the mio
<code>TcpListener</code>, <code>TcpStream</code> wrappers around these file descriptors. A <code>TcpListener</code>
listens for connections on a specific port. For each new connection it creates a
<code>TcpStream</code> on which subsequent traffic will be redirected (both from and to the client).</p>
<p>This is all what we use mio for. "Subscribing" to file descriptors events.</p>
<h3 id="keep-track-of-sessions-with-the-sessionmanager">Keep track of sessions with the SessionManager</h3>
<p>Each subscription in mio is associated with a Token (a u64 identifier). The SessionManager's
job is to link a Token to a <code>ProxySession</code> that will make use of the subscription.
This is done with a <a href="">Slab</a>, a key-value data structure which optimizes memory usage:</p>
<ul>
<li>as a key: the Token provided by mio</li>
<li>as a value: a reference to a <code>ProxySession</code></li>
</ul>
<p>That being said let's dive into the lifetime of a session.</p>
<h3 id="what-are-proxys">What are Proxys?</h3>
<p>A Sōzu worker internally has 3 proxys, one for each supported protocol:</p>
<ul>
<li>TCP</li>
<li>HTTP</li>
<li>HTTPS</li>
</ul>
<p>A proxy manages listeners, frontends, backends and the business logic associated
with each protocol (buffering, parsing, error handling...).</p>
<h2 id="accepting-a-connection">Accepting a connection</h2>
<p>Sōzu uses TCP listener sockets to get new connections. It will typically listen
on ports 80 (HTTP) and 443 (HTTPS), but could have other ports for TCP proxying,
or even HTTP/HTTPS proxys on other ports.</p>
<p>For each frontend, Sōzu:</p>
<ol>
<li>generate a new Token <em>token</em></li>
<li>uses mio to register a <code>TcpListener</code> as <em>token</em></li>
<li>adds a matching <code>ListenSession</code> in the <code>SessionManager</code> with key <em>token</em></li>
<li>stores the <code>TcpListener</code> in the appropriate Proxy (TCP/HTTP/HTTPS) with key <em>token</em></li>
</ol>
<h3 id="an-event-loop-on-tcp-sockets">An event loop on TCP sockets</h3>
<p>Sōzu is hot reconfigurable. We can add listeners and frontends at runtime. For each added listener,
the SessionManager will store a <code>ListenSession</code> in its Slab.</p>
<p>The <a href="">event loop</a> uses mio to check for any activity, on all sockets.
Whenever mio detects activity on a socket, it returns an event that is passed to the <code>SessionManager</code>.</p>
<p>Whenever a client connects to a frontend:
1. it reaches a listener
2. Sōzu is notified by mio that a <code>readable</code> event was received on a specific Token
3. using the SessionManager, Sōzu gets the corresponding <code>ListenSession</code>
4. Sōzu determines the protocol that was used
5. the Token is passed down to the appropriate proxy (TCP/HTTP/HTTPS)
6. using the Token, the proxy determines which <code>TcpListener</code> triggered the event
7. the proxy starts accepting new connections from it in a loop (as their might be more than one)</p>
<p>Accepting a connection means to store it as a <code>TcpStream</code> in the accept queue, until either:</p>
<ul>
<li>there are no more connections to accept</li>
<li>or the accept queue is full: https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/server.rs#L1204-L1258</li>
</ul>
<h3 id="consuming-the-accept-queue">Consuming the accept queue</h3>
<p>We create sessions from the accept queue, starting from
the most recent session, and dropping sockets that are too old.</p>
<p>When we accept a new connection (<code>TcpStream</code>), it might have waited a bit already in the
listener queue. The kernel might even already have some data available,
like an HTTP request. If we are too slow in handling that request, the client might
have dropped the connection (timeout) by the time we forward the request to the
backend and the backend responds.</p>
<p>If the maximum number of client connections (provided by <code>max_connections</code> in the configuration)
is reached, new ones stay in the queue.
And if the queue is full, we drop newly accepted connections.
By specifying a maximum number of concurrent connections, we make sure that the
server does not get overloaded and keep latencies manageable for existing
connections.</p>
<h3 id="creating-sessions">Creating sessions</h3>
<p>A session's goal is to forward traffic from a frontend to a backend and vice-versa.
The <code>Session</code> struct holds the data associated
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L65-L83">with a session</a>:
tokens, current timeout state, protocol state, client address...
The created session is wrapped in a
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L1544"><code>Rc&lt;RefCell&lt;...&gt;&gt;</code></a></p>
<p>The proxies create one session for each item of the accept queue,
using the <code>TcpStream</code> provided in the item.
The <code>TcpStream</code> is registered in mio with a new Token (called frontend_token).
The Session is added in the SessionManager with the same Token.</p>
<h3 id="check-for-zombie-sessions">Check for zombie sessions</h3>
<p>Because bugs can occur when sessions are created and removed, and some of them
could be "forgotten", there's a regular task called
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/server.rs#L446-L496">"zombie checker"</a>
that checks on the sessions in the list and kills those that are stuck or too old.</p>
<h2 id="how-a-session-reads-data-from-the-front-socket">How a Session reads data from the front socket</h2>
<p>When data arrives from the network on the <code>TcpStream</code>, it is stored in a kernel
buffer, and the kernel notifies the event loop that the socket is readable.</p>
<p>As with listen sockets, the token associated with the TCP socket will get a
"readable" event, and we will use the token to lookup which session it is
associated with. We then call
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/server.rs#L1431"><code>Session::update_readiness</code></a>
to notify it of the new
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L810-L820">socket state</a>.</p>
<p>Then we call
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L822-L827"><code>Session::ready</code></a>
to let it read data, parse, etc.
That method will run in a loop (https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L548-L692),</p>
<h3 id="bring-in-the-state-machine">Bring in the state machine</h3>
<p>The <a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L309-L339"><code>Session::readable</code> method</a>
of the session is called. It will then call that same method of the underlying
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L58-L63">state machine</a>.</p>
<p>The state machine is where the protocols are implemented. A session might need
to recognize different protocols over its lifetime, depending on its configuration,
and <a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L165">upgrade</a> between them. They are all in the <a href="https://github.com/sozu-proxy/sozu/tree/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol">protocol directory</a>.</p>
<p>Example:
- an HTTPS session could start in a state called <code>ExpectProxyProtocol</code>
- once the expect protocol has run its course, the session upgrades to the TLS handshake state: <code>HandShake</code>
- once the handshake is done, we have a TLS stream, and the session upgrades to the <code>HTTP</code> state
- if required by the client, the session can then switch to a WebSocket connection: <code>WebSocket</code></p>
<p>Now, let's assume we are currently using the HTTP 1 protocol. The session called
the <a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol/http/mod.rs#L609"><code>readable()</code> method</a>.</p>
<h3 id="find-the-backend">Find the backend</h3>
<p>We need to parse the HTTP request to find out its:</p>
<ol>
<li>hostname</li>
<li>path</li>
<li>HTTP verb</li>
</ol>
<p>We will first try to
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol/http/mod.rs#L646-L667">read data from the socket</a>
in the front buffer. If there were no errors (closed socket, etc), we will then handle that data in
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol/http/mod.rs#L728"><code>readable_parse()</code></a>.</p>
<p>The HTTP implementation holds
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol/http/mod.rs#L86-L87">two smaller state machines</a>,
<code>RequestState</code> and <code>ResponseState</code>, that indicate where we are in parsing the
request or response, and store data about them.</p>
<p>When we receive the first byte from the client, both are at the <code>Initial</code> state.
We <a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol/http/mod.rs#L734-L737">parse data from the front buffer</a>
until we reach a request state where the headers are entirely parsed. If there
was not enough data, we'll wait for more data to come on the socket and restart
parsing.</p>
<p>Once we're done parsing the headers, and find what we were looking for, we will
<a href="https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/protocol/http/mod.rs#L751-L759">return SessionResult::ConnectBackend</a>
to notify the session that it should find a backend server to send the data.</p>
<h2 id="connect-to-the-backend-servers">Connect to the backend servers</h2>
<p>The Session:
1. finds which cluster to connect to
2. asks the SessionManager for a new valid Token named <code>back_token</code>
3. asks for a connection to the cluster
   - the appropriate Proxy finds a backend (add details)
4. registers the new <code>TcpStream</code> in mio with <code>back_token</code>
5. inserts itself in the SessionManager with <code>back_token</code></p>
<p>The same session is now stored twice in the SessionManager:</p>
<ol>
<li>once with the front token as key</li>
<li>secondly with the back token as key</li>
</ol>
<p>If Sōzu can't find a cluster it responds with a default HTTP 404 Not Found response to the client.
A session can try to connect to a backend 3 times. If all attempts fail, Sōzu responds with a default
HTTP 503 Service Unavailable response. This happens if Sōzu found a cluster, but all corresponding
backends are down (or not responding).</p>
<h3 id="keep-a-session-alive">Keep a session alive</h3>
<p>In case an HTTP request comes with the Connection header set at Keep-Alive,
the underlying TCP connection can be kept after receiving the response,
to send more requests. Since Sōzu supports routing on the URL along with the
hostname, the next request might go to a different cluster.
So when we get the cluster id from the request, we check if it is the same
as the previous one, and if it is the same, we test if the back socket is still
valid. If it is, we can reuse it. Otherwise, we will replace the back socket
with a new one.</p>
<h3 id="sticky-session-stick-a-front-to-one-backend-only">Sticky session: stick a front to one backend only</h3>
<p>This is a routing mechanism where we look at a cookie in the request. All requests
coming with the same id in that cookie will be sent to the same backend server.</p>
<p>That look up will return a result depending on which backend server are
considered valid (if they're answering properly) and on the load balancing
policies configured for the cluster.
If a backend was found, we open a TCP connection to the backend server,
otherwise we return a HTTP 503 response.</p>
<h2 id="sending-data-to-the-back-socket">Sending data to the back socket</h2>
<p>Then we wait for a writable event from the backend connection, then we can start
to forward the pending request to it.
In case of an error, we retry to connect to another backend server in the same Cluster.</p>
<h2 id="the-big-u-turn-forwarding-from-backend-to-frontend">The big U-turn: forwarding from backend to frontend</h2>
<p>As explained above, we have a small state machine called <code>ResponseState</code> in order to
parse the traffic from the backend. The whole logic is basically the same.</p>
<p>We monitor backend readability and frontend writability, and transfer traffic from
one to the other.</p>
<h2 id="the-end-of-a-session">The end of a session</h2>
<p>Once the <code>ResponseState</code> reaches a "completed" state and every byte has been sent
back to the client, the full life cycle of a request ends. The session
reaches the <code>CloseSession</code> state and is removed from the <code>SessionManager</code>'s slab
and its sockets are deregistered from mio.</p>
<p>If the request had a Keep-Alive header, however, the session will be reused
and await a new request. This is the "reset" of a session.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>