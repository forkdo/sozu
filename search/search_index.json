{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"S\u014dzu","text":""},{"location":"#what-is-sozu","title":"What is S\u014dzu?","text":"<p>S\u014dzu is a reverse proxy for load balancing, written in Rust. Its main job is to balance inbound requests across two or more clusters backends to spread the load.</p> <ul> <li> <p>It serves as a termination point for TLS sessions. So the workload of dealing with the encryption is offloaded from the backend.</p> </li> <li> <p>It can protect the backends by preventing direct access from the network.</p> </li> <li> <p>It returns some metrics related to the traffic between clients and backends clusters behind it.</p> </li> </ul>"},{"location":"#introduction","title":"Introduction","text":"<ul> <li> <p>Getting started</p> </li> <li> <p>Configure S\u014dzu</p> </li> <li> <p>How to use it</p> </li> <li> <p>Why you should use S\u014dzu</p> </li> <li> <p>Design Motivation</p> </li> <li> <p>Recipes</p> </li> </ul>"},{"location":"#overview","title":"Overview","text":"<ul> <li> <p>Architecture Overview</p> </li> <li> <p>Tools &amp; Libraries</p> </li> </ul>"},{"location":"#going-deeper","title":"Going deeper","text":"<ul> <li>Lifetime of a session</li> </ul>"},{"location":"#release-notes","title":"Release Notes","text":"<p>TODO</p>"},{"location":"#presentations-slides","title":"Presentations &amp; Slides","text":"<ul> <li> <p>S\u014dzu, a hot reconfigurable reverse HTTP proxy by Geoffroy Couprie</p> </li> <li> <p>(FR) Refondre le reverse proxy en 2017 pour faire de l\u2019immutable infrastructure. by Quentin Adam</p> </li> </ul>"},{"location":"README_zh/","title":"S\u014dzu","text":""},{"location":"README_zh/#sozu_1","title":"S\u014dzu \u662f\u4ec0\u4e48\uff1f","text":"<p>S\u014dzu \u662f\u4e00\u4e2a\u7528 Rust \u7f16\u5199\u7684\u7528\u4e8e\u8d1f\u8f7d\u5747\u8861\u7684\u53cd\u5411\u4ee3\u7406\u3002\u5b83\u7684\u4e3b\u8981\u5de5\u4f5c\u662f\u5728\u4e24\u4e2a\u6216\u591a\u4e2a\u96c6\u7fa4\u540e\u7aef\u4e4b\u95f4\u5e73\u8861\u5165\u7ad9\u8bf7\u6c42\u4ee5\u5206\u6563\u8d1f\u8f7d\u3002</p> <ul> <li> <p>\u5b83\u5145\u5f53 TLS \u4f1a\u8bdd\u7684\u7ec8\u6b62\u70b9\u3002\u56e0\u6b64\uff0c\u5904\u7406\u52a0\u5bc6\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ece\u540e\u7aef\u5378\u8f7d\u3002</p> </li> <li> <p>\u5b83\u53ef\u4ee5\u901a\u8fc7\u9632\u6b62\u4ece\u7f51\u7edc\u76f4\u63a5\u8bbf\u95ee\u6765\u4fdd\u62a4\u540e\u7aef\u3002</p> </li> <li> <p>\u5b83\u8fd4\u56de\u4e00\u4e9b\u4e0e\u5ba2\u6237\u7aef\u548c\u5176\u540e\u9762\u7684\u540e\u7aef\u96c6\u7fa4\u4e4b\u95f4\u7684\u6d41\u91cf\u76f8\u5173\u7684\u6307\u6807\u3002</p> </li> </ul>"},{"location":"README_zh/#_1","title":"\u4ecb\u7ecd","text":"<ul> <li> <p>\u5165\u95e8</p> </li> <li> <p>\u914d\u7f6e S\u014dzu</p> </li> <li> <p>\u5982\u4f55\u4f7f\u7528\u5b83</p> </li> <li> <p>\u4e3a\u4ec0\u4e48\u4f60\u5e94\u8be5\u4f7f\u7528 S\u014dzu</p> </li> <li> <p>\u8bbe\u8ba1\u52a8\u673a</p> </li> <li> <p>\u98df\u8c31</p> </li> </ul>"},{"location":"README_zh/#_2","title":"\u6982\u8ff0","text":"<ul> <li> <p>\u67b6\u6784\u6982\u8ff0</p> </li> <li> <p>\u5de5\u5177\u548c\u5e93</p> </li> </ul>"},{"location":"README_zh/#_3","title":"\u6df1\u5165","text":"<ul> <li>\u4f1a\u8bdd\u7684\u751f\u547d\u5468\u671f</li> </ul>"},{"location":"README_zh/#_4","title":"\u53d1\u884c\u8bf4\u660e","text":"<p>\u5f85\u529e\u4e8b\u9879</p>"},{"location":"README_zh/#_5","title":"\u6f14\u793a\u548c\u5e7b\u706f\u7247","text":"<ul> <li> <p>S\u014dzu, a hot reconfigurable reverse HTTP proxy by Geoffroy Couprie</p> </li> <li> <p>(FR) Refondre le reverse proxy en 2017 pour faire de l\u2019immutable infrastructure. by Quentin Adam</p> </li> </ul>"},{"location":"architecture/","title":"Architecture","text":"<p>This part is mostly for people who want to understand how s\u014dzu works.</p>"},{"location":"architecture/#mainworker-model","title":"Main/worker model","text":"<p>S\u014dzu works with one main process and multiple worker processes. This allows it to keep running if a worker encounters an issue and crashes, and upgrading workers one by one when necessary.</p>"},{"location":"architecture/#single-thread-shared-nothing-architecture","title":"Single thread, shared nothing architecture","text":"<p>Each worker runs a single thread with an epoll based event loop. To avoid synchronization issues, every worker has a copy of the entire routing configuration. Every modification of the routing comes through configuration messages. Logging and metrics are sent by each worker individually, leaving to an external service the work of aggregating and serializing the events. All of the listening TCP sockets are opened with the SO_REUSEPORT option, allowing multiple process to listen on the same address.</p>"},{"location":"architecture/#configuration","title":"Configuration","text":"<p>External tools interact with the main process through a unix socket, and configuration change messages will be dispatched to the workers by the main. The configuration messages are \"diffs\", like \"add a backend server\", or \"remove a HTTP frontend\", instead of changing the whole configuration at once. This allows s\u014dzu to be smarter about handling the configuration changes while under traffic.</p> <p>The configuration messages are transmitted in protobuf binary format, and they are defined in the command library. There are three possible message answers: processing (meaning the message has been received but the change is not active yet), failure or ok.</p> <p>The main exposes a unix socket for configuration instead of a HTTP server on localhost because unix socket access can be secured through file system permissions.</p>"},{"location":"architecture/#proxying","title":"Proxying","text":""},{"location":"architecture/#event-loop-with-mio","title":"Event loop with mio","text":"<p>Every worker runs an event looped based on epoll (on Linux) or kqueue (on OSX and BSD), using the mio library.</p> <p>Mio provides a cross platform abstraction allowing callers to receive events, like a socket becoming readable (meaning it received some data).</p> <p>S\u014dzu asks mio to send all the events of a socket in edge triggered mode. That way, it only receives an event once, and stores it in a <code>Readiness</code> struct. It will then use that information and the \"interest\" (indicating if the current protocol state machine wants to read or write on the socket).</p> <p>Each socket event is returned with a <code>Token</code> indicating its index in a <code>Slab</code> data structure. A client session can have multiple sockets (typically, a front socket and a back socket).</p>"},{"location":"architecture/#protocols","title":"Protocols","text":"<p>Each proxy implementation (HTTP, HTTPS and TCP) will use in each client session a state machine describing the protocol currently in use. It is designed to allow upgrades from one protocol to the next. As an example, you could have the following progression:</p> <ul> <li>start in TLS handshake protocol</li> <li>once the handshake is done, upgrade to the HTTP protocol over the recently negotiated TLS stream</li> <li>upgrade to websockets</li> </ul> <p>Each protocol will work with the <code>Readiness</code> structure to indicate if it wants to read or write on each socket. As an example, the OpenSSL based handshake is only interested in the frontend socket.</p> <p>They are all defined in <code>lib/src/network/protocol</code>.</p>"},{"location":"architecture/#logging","title":"Logging","text":"<p>The logger is designed to reduce allocations and string interpolations, using Rust's formatting system. It can send logs on various backends: stdout, file, TCP, UDP, Unix sockets.</p> <p>The logger can be invoked through a thread local storage variable accessible from anywhere with logging macros.</p>"},{"location":"architecture/#metrics","title":"Metrics","text":"<p>Metrics work like the logger, accessible from anywhere with macros and TLS. We support two \"drains\": one that sends the metrics on the networks with a statsd compatible protocol, and one aggregating metrics locally, to be queried through the configuration socket.</p>"},{"location":"architecture/#load-balancing","title":"Load balancing","text":"<p>For a given cluster, S\u014dzu keeps a list of backends to which the connection is redirected. S\u014dzu detects broken servers and redirects traffic only to healthy ones, with several available loadbalancing algorithms: round robin (default), random, least_loaded, and power of two.</p>"},{"location":"architecture/#tls","title":"TLS","text":"<p>S\u014dzu is an TLS endpoint, powered by rustls. It decrypts the traffic using the TLS key and certificate, and forwards it, unencrypted, to the backends.</p>"},{"location":"architecture/#deep-dive","title":"Deep dive","text":""},{"location":"architecture/#buffers","title":"Buffers","text":"<p>S\u014dzu is optimised for very limited memory use. All traffic is (briefly) stored in a pool of fix-sized (usually 16 kB), reusable buffers.</p>"},{"location":"architecture/#channels","title":"channels","text":"<p>They are an abstraction layer over a unix socket, making chatting with a s\u014dzu easier.</p>"},{"location":"architecture_zh/","title":"\u67b6\u6784","text":"<p>\u8fd9\u90e8\u5206\u4e3b\u8981\u9762\u5411\u5e0c\u671b\u4e86\u89e3 s\u014dzu \u5de5\u4f5c\u539f\u7406\u7684\u4eba\u3002</p>"},{"location":"architecture_zh/#_2","title":"\u4e3b/\u5de5\u4f5c\u8fdb\u7a0b\u6a21\u578b","text":"<p>S\u014dzu \u91c7\u7528\u4e00\u4e2a\u4e3b\u8fdb\u7a0b\u548c\u591a\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u7684\u6a21\u5f0f\u3002\u8fd9\u4f7f\u5f97\u5728\u67d0\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u9047\u5230\u95ee\u9898\u5e76\u5d29\u6e83\u65f6\uff0c\u5b83\u80fd\u591f\u7ee7\u7eed\u8fd0\u884c\uff0c\u5e76\u5728\u5fc5\u8981\u65f6\u9010\u4e2a\u5347\u7ea7\u5de5\u4f5c\u8fdb\u7a0b\u3002</p>"},{"location":"architecture_zh/#_3","title":"\u5355\u7ebf\u7a0b\uff0c\u65e0\u5171\u4eab\u67b6\u6784","text":"<p>\u6bcf\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u8fd0\u884c\u4e00\u4e2a\u57fa\u4e8e epoll \u7684\u4e8b\u4ef6\u5faa\u73af\u7684\u5355\u7ebf\u7a0b\u3002\u4e3a\u907f\u514d\u540c\u6b65\u95ee\u9898\uff0c\u6bcf\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u90fd\u62e5\u6709\u6574\u4e2a\u8def\u7531\u914d\u7f6e\u7684\u526f\u672c\u3002\u8def\u7531\u7684\u6bcf\u6b21\u4fee\u6539\u90fd\u901a\u8fc7\u914d\u7f6e\u6d88\u606f\u8fdb\u884c\u3002\u65e5\u5fd7\u548c\u5ea6\u91cf\u7531\u6bcf\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u5355\u72ec\u53d1\u9001\uff0c\u5c06\u805a\u5408\u548c\u5e8f\u5217\u5316\u4e8b\u4ef6\u7684\u5de5\u4f5c\u7559\u7ed9\u5916\u90e8\u670d\u52a1\u3002 \u6240\u6709\u76d1\u542c\u7684 TCP \u5957\u63a5\u5b57\u90fd\u4f7f\u7528 SO_REUSEPORT \u9009\u9879\u6253\u5f00\uff0c\u5141\u8bb8\u591a\u4e2a\u8fdb\u7a0b\u5728\u540c\u4e00\u5730\u5740\u4e0a\u76d1\u542c\u3002</p>"},{"location":"architecture_zh/#_4","title":"\u914d\u7f6e","text":"<p>\u5916\u90e8\u5de5\u5177\u901a\u8fc7\u4e00\u4e2a unix \u5957\u63a5\u5b57\u4e0e\u4e3b\u8fdb\u7a0b\u4ea4\u4e92\uff0c\u914d\u7f6e\u66f4\u6539\u6d88\u606f\u5c06\u7531\u4e3b\u8fdb\u7a0b\u5206\u6d3e\u7ed9\u5de5\u4f5c\u8fdb\u7a0b\u3002 \u914d\u7f6e\u6d88\u606f\u662f\u201c\u5dee\u5f02\u201d\uff0c\u4f8b\u5982\u201c\u6dfb\u52a0\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u201d\u6216\u201c\u79fb\u9664\u4e00\u4e2a HTTP \u524d\u7aef\u201d\uff0c\u800c\u4e0d\u662f\u4e00\u6b21\u6027\u66f4\u6539\u6574\u4e2a\u914d\u7f6e\u3002\u8fd9\u4f7f\u5f97 s\u014dzu \u5728\u5904\u7406\u6709\u6d41\u91cf\u65f6\u7684\u914d\u7f6e\u66f4\u6539\u65f6\u80fd\u66f4\u52a0\u667a\u80fd\u3002</p> <p>\u914d\u7f6e\u6d88\u606f\u4ee5 protobuf \u4e8c\u8fdb\u5236\u683c\u5f0f\u4f20\u8f93\uff0c\u5b83\u4eec\u5728 command \u5e93 \u4e2d\u5b9a\u4e49\u3002\u6709\u4e09\u79cd\u53ef\u80fd\u7684\u6d88\u606f\u5e94\u7b54\uff1aprocessing\uff08\u8868\u793a\u6d88\u606f\u5df2\u6536\u5230\u4f46\u66f4\u6539\u5c1a\u672a\u751f\u6548\uff09\u3001failure \u6216 ok\u3002</p> <p>\u4e3b\u8fdb\u7a0b\u66b4\u9732\u4e00\u4e2a\u7528\u4e8e\u914d\u7f6e\u7684 unix \u5957\u63a5\u5b57\uff0c\u800c\u4e0d\u662f\u5728 localhost \u4e0a\u66b4\u9732\u4e00\u4e2a HTTP \u670d\u52a1\u5668\uff0c\u56e0\u4e3a unix \u5957\u63a5\u5b57\u7684\u8bbf\u95ee\u53ef\u4ee5\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u6743\u9650\u6765\u4fdd\u62a4\u3002</p>"},{"location":"architecture_zh/#_5","title":"\u4ee3\u7406","text":""},{"location":"architecture_zh/#mio","title":"\u4f7f\u7528 mio \u7684\u4e8b\u4ef6\u5faa\u73af","text":"<p>\u6bcf\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u90fd\u8fd0\u884c\u4e00\u4e2a\u57fa\u4e8e epoll\uff08\u5728 Linux \u4e0a\uff09\u6216 kqueue\uff08\u5728 OSX \u548c BSD \u4e0a\uff09\u7684\u4e8b\u4ef6\u5faa\u73af\uff0c\u4f7f\u7528 mio \u5e93\u3002</p> <p>Mio \u63d0\u4f9b\u4e86\u4e00\u4e2a\u8de8\u5e73\u53f0\u62bd\u8c61\uff0c\u5141\u8bb8\u8c03\u7528\u8005\u63a5\u6536\u4e8b\u4ef6\uff0c\u4f8b\u5982\u5957\u63a5\u5b57\u53d8\u4e3a\u53ef\u8bfb\uff08\u8868\u793a\u5b83\u63a5\u6536\u5230\u4e86\u4e00\u4e9b\u6570\u636e\uff09\u3002</p> <p>S\u014dzu \u8981\u6c42 mio \u4ee5\u8fb9\u7f18\u89e6\u53d1\u6a21\u5f0f\u53d1\u9001\u5957\u63a5\u5b57\u7684\u6240\u6709\u4e8b\u4ef6\u3002 \u8fd9\u6837\uff0c\u5b83\u53ea\u63a5\u6536\u4e00\u6b21\u4e8b\u4ef6\uff0c\u5e76\u5c06\u5176\u5b58\u50a8\u5728\u4e00\u4e2a <code>Readiness</code> \u7ed3\u6784\u4e2d\u3002 \u7136\u540e\uff0c\u5b83\u5c06\u4f7f\u7528\u8be5\u4fe1\u606f\u548c\u201c\u5174\u8da3\u201d\uff08\u6307\u793a\u5f53\u524d\u534f\u8bae\u72b6\u6001\u673a\u662f\u5426\u60f3\u5728\u5957\u63a5\u5b57\u4e0a\u8bfb\u6216\u5199\uff09\u3002</p> <p>\u6bcf\u4e2a\u5957\u63a5\u5b57\u4e8b\u4ef6\u90fd\u8fd4\u56de\u4e00\u4e2a <code>Token</code>\uff0c\u6307\u793a\u5176\u5728 <code>Slab</code> \u6570\u636e\u7ed3\u6784\u4e2d\u7684\u7d22\u5f15\u3002\u4e00\u4e2a\u5ba2\u6237\u7aef\u4f1a\u8bdd\u53ef\u4ee5\u6709\u591a\u4e2a\u5957\u63a5\u5b57\uff08\u901a\u5e38\u662f\u4e00\u4e2a\u524d\u7aef\u5957\u63a5\u5b57\u548c\u4e00\u4e2a\u540e\u7aef\u5957\u63a5\u5b57\uff09\u3002</p>"},{"location":"architecture_zh/#_6","title":"\u534f\u8bae","text":"<p>\u6bcf\u4e2a\u4ee3\u7406\u5b9e\u73b0\uff08HTTP\u3001HTTPS \u548c TCP\uff09\u5c06\u5728\u6bcf\u4e2a\u5ba2\u6237\u7aef\u4f1a\u8bdd\u4e2d\u4f7f\u7528\u4e00\u4e2a\u72b6\u6001\u673a\u6765\u63cf\u8ff0\u5f53\u524d\u4f7f\u7528\u7684\u534f\u8bae\u3002\u5b83\u65e8\u5728\u5141\u8bb8\u4ece\u4e00\u4e2a\u534f\u8bae\u5347\u7ea7\u5230\u4e0b\u4e00\u4e2a\u534f\u8bae\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6709\u4ee5\u4e0b\u8fdb\u5c55\uff1a</p> <ul> <li>\u4ece TLS \u63e1\u624b\u534f\u8bae\u5f00\u59cb</li> <li>\u63e1\u624b\u5b8c\u6210\u540e\uff0c\u5347\u7ea7\u5230\u6700\u8fd1\u534f\u5546\u7684 TLS \u6d41\u4e0a\u7684 HTTP \u534f\u8bae</li> <li>\u5347\u7ea7\u5230 websockets</li> </ul> <p>\u6bcf\u4e2a\u534f\u8bae\u90fd\u5c06\u4e0e <code>Readiness</code> \u7ed3\u6784\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u6307\u793a\u5b83\u662f\u5426\u60f3\u5728\u6bcf\u4e2a\u5957\u63a5\u5b57\u4e0a\u8bfb\u6216\u5199\u3002\u4f8b\u5982\uff0c\u57fa\u4e8e OpenSSL \u7684\u63e1\u624b\u53ea\u5bf9\u524d\u7aef\u5957\u63a5\u5b57\u611f\u5174\u8da3\u3002</p> <p>\u5b83\u4eec\u90fd\u5728 <code>lib/src/network/protocol</code> \u4e2d\u5b9a\u4e49\u3002</p>"},{"location":"architecture_zh/#_7","title":"\u65e5\u5fd7","text":"<p>logger \u65e8\u5728\u51cf\u5c11\u5206\u914d\u548c\u5b57\u7b26\u4e32\u63d2\u503c\uff0c\u4f7f\u7528 Rust \u7684\u683c\u5f0f\u5316\u7cfb\u7edf\u3002\u5b83\u53ef\u4ee5\u5c06\u65e5\u5fd7\u53d1\u9001\u5230\u5404\u79cd\u540e\u7aef\uff1astdout\u3001\u6587\u4ef6\u3001TCP\u3001UDP\u3001Unix \u5957\u63a5\u5b57\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a\u7ebf\u7a0b\u5c40\u90e8\u5b58\u50a8\u53d8\u91cf\uff0c\u4f7f\u7528\u65e5\u5fd7\u5b8f\u4ece\u4efb\u4f55\u5730\u65b9\u8c03\u7528 logger\u3002</p>"},{"location":"architecture_zh/#_8","title":"\u5ea6\u91cf","text":"<p>\u5ea6\u91cf\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e logger \u7c7b\u4f3c\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b8f\u548c TLS \u4ece\u4efb\u4f55\u5730\u65b9\u8bbf\u95ee\u3002\u6211\u4eec\u652f\u6301\u4e24\u79cd\u201cdrains\u201d\uff1a\u4e00\u79cd\u901a\u8fc7\u7f51\u7edc\u4ee5 statsd \u517c\u5bb9\u534f\u8bae\u53d1\u9001\u5ea6\u91cf\uff0c\u53e6\u4e00\u79cd\u5728\u672c\u5730\u805a\u5408\u5ea6\u91cf\uff0c\u4ee5\u901a\u8fc7\u914d\u7f6e\u5957\u63a5\u5b57\u67e5\u8be2\u3002</p>"},{"location":"architecture_zh/#_9","title":"\u8d1f\u8f7d\u5747\u8861","text":"<p>\u5bf9\u4e8e\u7ed9\u5b9a\u7684\u96c6\u7fa4\uff0cS\u014dzu \u7ef4\u62a4\u4e00\u4e2a\u540e\u7aef\u5217\u8868\uff0c\u8fde\u63a5\u5c06\u88ab\u91cd\u5b9a\u5411\u5230\u8fd9\u4e9b\u540e\u7aef\u3002 S\u014dzu \u68c0\u6d4b\u635f\u574f\u7684\u670d\u52a1\u5668\uff0c\u5e76\u4ec5\u5c06\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u5065\u5eb7\u7684\u670d\u52a1\u5668\uff0c\u6709\u51e0\u79cd\u53ef\u7528\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff1a \u8f6e\u8be2\uff08\u9ed8\u8ba4\uff09\u3001\u968f\u673a\u3001\u6700\u5c11\u8fde\u63a5\u548c\u4e8c\u6b21\u5e42\u3002</p>"},{"location":"architecture_zh/#tls","title":"TLS","text":"<p>S\u014dzu \u662f\u4e00\u4e2a TLS \u7aef\u70b9\uff0c\u7531 rustls \u63d0\u4f9b\u652f\u6301\u3002 \u5b83\u4f7f\u7528 TLS \u5bc6\u94a5\u548c\u8bc1\u4e66\u89e3\u5bc6\u6d41\u91cf\uff0c\u5e76\u5c06\u5176\u672a\u52a0\u5bc6\u5730\u8f6c\u53d1\u5230\u540e\u7aef\u3002</p>"},{"location":"architecture_zh/#_10","title":"\u6df1\u5165\u4e86\u89e3","text":""},{"location":"architecture_zh/#_11","title":"\u7f13\u51b2\u533a","text":"<p>S\u014dzu \u9488\u5bf9\u975e\u5e38\u6709\u9650\u7684\u5185\u5b58\u4f7f\u7528\u8fdb\u884c\u4e86\u4f18\u5316\u3002 \u6240\u6709\u6d41\u91cf\u90fd\uff08\u77ed\u6682\u5730\uff09\u5b58\u50a8\u5728\u4e00\u4e2a\u56fa\u5b9a\u5927\u5c0f\uff08\u901a\u5e38\u4e3a 16 kB\uff09\u7684\u53ef\u91cd\u7528\u7f13\u51b2\u533a\u6c60\u4e2d\u3002</p>"},{"location":"architecture_zh/#_12","title":"\u901a\u9053","text":"<p>\u5b83\u4eec\u662f unix \u5957\u63a5\u5b57\u4e4b\u4e0a\u7684\u4e00\u4e2a\u62bd\u8c61\u5c42\uff0c\u4f7f\u4e0e s\u014dzu \u7684\u901a\u4fe1\u66f4\u5bb9\u6613\u3002</p>"},{"location":"benchmark/","title":"How to benchmark / observe S\u014dzu","text":"<p>For debugging and optimization purposes.</p>"},{"location":"benchmark/#run-sozu-on-your-machine-with-dummy-backends","title":"Run S\u014dzu on your machine, with dummy backends","text":""},{"location":"benchmark/#create-a-config-with-an-http-and-an-https-listener","title":"Create a config with an HTTP and an HTTPS listener","text":"<p>Most defaults of <code>bin/config.toml</code> are sensible, copy them into <code>bin/my-config.toml</code>. An important value to tweak is <code>worker_count</code>. Testing the performance of one worker only seems ideal:</p> <pre><code>worker_count = 1\n</code></pre> <p>The HTTP and HTTPS listeners should be identical. Chose a TLS version and a cipher list for the HTTPS listener, and stick to it.</p> <pre><code>[[listeners]]\nprotocol = \"http\"\naddress = \"0.0.0.0:8080\"\n\n[[listeners]]\nprotocol = \"https\"\naddress = \"0.0.0.0:8443\"\ntls_versions = [\"TLS_V13\"]\n\ncipher_list = [\n  # \"TLS13_AES_128_GCM_SHA256\",\n  \"TLS13_CHACHA20_POLY1305_SHA256\",\n  # ...\n]\n</code></pre> <p>Create a cluster (equivalent to an app) that has two frontends: one for HTTP requests, one for HTTPS requests.</p> <p>Make sure you created your own certificate and key for the <code>localhost</code> domain.</p> <pre><code>frontends = [\n    { address = \"0.0.0.0:8080\", hostname = \"localhost\", path = \"/api\" },\n    { address = \"0.0.0.0:8443\", hostname = \"localhost\", certificate = \"/path/to/your/certificate.pem\", key = \"/path/to/your/key.pem\", certificate_chain = \"/path/to/your/certificate.pem\" },\n]\n</code></pre> <p>or use the certificate and key and certificate chain of <code>config.toml</code>, present in <code>/lib/assets/</code>. But then you have to use <code>lolcatho.st</code> as a local domain, and be sure to have this lines in your <code>/etc/hosts</code>:</p> <pre><code>127.0.0.1       lolcatho.st\n::1             lolcatho.st\n</code></pre>"},{"location":"benchmark/#spawn-4-backends","title":"Spawn 4 backends","text":"<p>Create four simple HTTP servers that reply each 200 OK when requested with HTTP GET on the <code>/api</code> path (arbitrarily). Use your favorite programming langage, it should be simple. It's 8 lines of javascript. Make sure that each backend listens on localhost and on a different port, for exapmle: 1051, 1052, 1053 1054.</p> <p>Add those backends to <code>my-config.toml</code>, under the frontends:</p> <pre><code>backends = [\n    { address = \"127.0.0.1:1051\", backend_id = \"backend_1\" },\n    { address = \"127.0.0.1:1052\", backend_id = \"backend_2\" },\n    { address = \"127.0.0.1:1053\", backend_id = \"backend_3\" },\n    { address = \"127.0.0.1:1054\", backend_id = \"backend_4\" },\n]\n</code></pre>"},{"location":"benchmark/#build-and-run-sozu","title":"Build and run S\u014dzu","text":"<p>Build S\u014dzu in release mode.</p> <pre><code>cargo build --release\n</code></pre> <p>Tip: rename the release binary and put it in the cargo path:</p> <pre><code>mv target/release/sozu $HOME/.cargo/bin/sozu-0.15.14\n</code></pre> <p>Now you can run S\u014dzu in release mode:</p> <pre><code>cd bin\nsozu-0.15.14 --config my-config.toml start\n</code></pre> <p>Check that S\u014dzu works by curling the backends through S\u014dzu:</p> <pre><code>curl https://localhost:8443/api -v\ncurl http://localhost:8080/api  -v\n</code></pre>"},{"location":"benchmark/#bombardier","title":"Bombardier","text":"<p>Bombardier is an HTTP and HTTPS benchmarking tool written in go. It is available as a package in most linux distributions, and easy to use in the command line.</p>"},{"location":"benchmark/#test-a-lot-of-requests-on-one-connection","title":"Test a lot of requests on one connection","text":"<pre><code>bombardier --connections=1 --requests=10000 https://localhost:8443/api --latencies\nbombardier --connections=1 --requests=10000 http://localhost:8080/api --latencies\n</code></pre>"},{"location":"benchmark/#test-concurrent-connections","title":"Test concurrent connections","text":"<pre><code>bombardier --connections=100 --requests=10000 https://localhost:8443/api --latencies\nbombardier --connections=100 --requests=10000 http://localhost:8080/api --latencies\n</code></pre> <p>Increase the number of connections until S\u00f5zu can't take it anymore.</p>"},{"location":"benchmark/#tls-perf","title":"TLS-perf","text":"<p><code>tls-perf</code> is a TLS stress-test tool written in C. It has no dependencies and is easy to build.</p> <pre><code>git clone git@github.com:tempesta-tech/tls-perf.git\ncd tls-perf\nmake\nmv tls-perf $HOME/.local/bin\n</code></pre> <p>Assuming <code>$HOME/.local/bin</code> is in your path.</p> <p>This command does: - ten thousand TLS handshakes - using only one connection - using TLS version 1.3</p> <pre><code>tls-perf \\\n  -n 10000 \\\n  -l 1 \\\n  --sni localhost \\\n  --tls 1.3 \\\n  127.0.0.1 8443\n</code></pre>"},{"location":"benchmark/#find-syscalls-with-strace","title":"Find syscalls with <code>strace</code>","text":"<p><code>strace</code> is a diagnostic tool that can monitor interactions between a process (S\u014dzu) and the linux kernel. It is available as a package in most linux distributions.</p> <p>Once S\u014dzu runs, find the pid of the worker:</p> <pre><code>ps -aux | grep sozu\nuser   13368  0.7  0.1 188132 40344 pts/2    Sl+  11:35   0:00 /path/to/sozu --config my-config.toml start\nuser   14157  0.0  0.0  79908 29628 pts/2    S+   11:35   0:00 /path/to/sozu worker --id 0 --fd 5 --scm 7 --configuration-state-fd 3 --command-buffer-size 16384 --max-command-buffer-size 16384\nuser   14205  0.0  0.0   6556  2412 pts/3    S+   11:35   0:00 grep --color=auto sozu\n</code></pre> <p>That second line is the worker, its pid is <code>14157</code>.</p> <p>Use strace to track this pid. You may need root privileges.</p> <pre><code>strace --attach=14157\n</code></pre> <p>You should see regular <code>epoll_wait</code> syscalls (system calls), this is S\u014dzu's main loop.</p> <pre><code>epoll_wait(3, [], 1024, 1000)           = 0\nepoll_wait(3, [], 1024, 1000)           = 0\nepoll_wait(3, [], 1024, 1000)           = 0\nepoll_wait(3, [], 1024, 318)            = 0\n</code></pre> <p>If you perform one of those curls, you will see all syscalls that S\u014dzu does during an HTTP or HTTPS request. Here are syscalls occuring during an HTTP GET on a simple backend. This is only the accepting of traffic on a listener socket.</p> <pre><code># main loop waiting for events\nepoll_wait(3, [], 1024, 1000)           = 0\n\n# One readable event (EPOLLIN). A client connected to a listener socket.\nepoll_wait(3, [{events=EPOLLIN, data={u32=3, u64=3}}], 1024, 1000) = 1\n\n# The proxy accepts the connection, by telling a listener to accept\n# incoming connections on the socket\naccept4(9, {sa_family=AF_INET, sin_port=htons(46144), sin_addr=inet_addr(\"127.0.0.1\")}, [128 =&gt; 16], SOCK_CLOEXEC|SOCK_NONBLOCK) = 11\n\n# Done! No more connections to accept\naccept4(9, 0x7ffe89e39b98, [128], SOCK_CLOEXEC|SOCK_NONBLOCK) = -1 EAGAIN (Resource temporarily unavailable)\n\n# The HTTP proxy sets NODELAY on the socket\nsetsockopt(11, SOL_TCP, TCP_NODELAY, [1], 4) = 0\n\n# S\u014dzu registers the socket in the accept queue\n# The accept queue is popped in another loop, to create sessions\n\n# When creating a session, the socket is registered in the event loop\nepoll_ctl(6, EPOLL_CTL_ADD, 11, {events=EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, data={u32=267, u64=267}}) = 0\n\n# Get the address of the socket (here, the host is the same, but the port is different)\ngetpeername(11, {sa_family=AF_INET, sin_port=htons(46144), sin_addr=inet_addr(\"127.0.0.1\")}, [128 =&gt; 16]) = 0\n\n# Return to the main event loop\nepoll_wait(3, [{events=EPOLLIN|EPOLLOUT, data={u32=267, u64=267}}], 1024, 1000) = 1\n\n# We are ready for traffic to come through this socket\n\n# Here it comes!\nrecvfrom(11, \"GET /api HTTP/1.1\\r\\nHost: localho\"..., 16400, 0, NULL, NULL) = 80\n</code></pre>"},{"location":"benchmark/#find-which-parts-of-the-code-cause-syscalls","title":"Find which parts of the code cause syscalls","text":"<p>For this kind of digging, S\u014dzu must run in debug mode, that is: not compiled with the <code>--release</code> flag. Do:</p> <pre><code>cargo run -- --config my-config.toml start\n</code></pre> <p>Find the pid as described above, and do:</p> <pre><code>strace --attach=14157 --stack-traces\n# or\nstrace -p 14157 -k\n</code></pre> <p>Curl S\u014dzu once, for instance</p> <pre><code>curl http://localhost:8080/api  -v\n</code></pre> <p>Now you see what piece of code is responsible for each syscall. Here is, for instance, the code responsible for a <code>connect</code> syscall on a socket with file descriptor 12. We can see it is an HTTP session connecting to its backend:</p> <pre><code>connect(12, {sa_family=AF_INET, sin_port=htons(1052), sin_addr=inet_addr(\"127.0.0.1\")}, 16) = -1 EINPROGRESS (Operation now in progress)\n &gt; /usr/lib/libc.so.6(__connect+0x14) [0x112454]\n &gt; /path/to/sozu/target/debug/sozu(mio::sys::unix::tcp::connect+0x84) [0x17b2ec4]\n &gt; /path/to/sozu/target/debug/sozu(mio::net::tcp::stream::TcpStream::connect+0x127) [0x17ad9e7]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::backends::Backend::try_connect+0x88) [0xb03898]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::backends::BackendMap::backend_from_cluster_id+0x465) [0xb04145]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::get_backend_for_sticky_session+0x5ab) [0xca8beb]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::backend_from_request+0x159) [0xca69b9]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::connect_to_backend+0xb7a) [0xcaafba]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::ready_inner+0x423) [0xcaf3a3]\n &gt; /path/to/sozu/target/debug/sozu(&lt;sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt; as sozu_lib::protocol::SessionState&gt;::ready+0x2d) [0xcb040d]\n &gt; /path/to/sozu/target/debug/sozu(&lt;sozu_lib::http::HttpStateMachine as sozu_lib::protocol::SessionState&gt;::ready+0xf2) [0xdbb9b2]\n &gt; /path/to/sozu/target/debug/sozu(&lt;sozu_lib::http::HttpSession as sozu_lib::ProxySession&gt;::ready+0x114) [0xdb4b54]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::server::Server::ready+0x746) [0xc95846]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::server::Server::run+0x66d) [0xc8869d]\n &gt; /path/to/sozu/target/debug/sozu(sozu::worker::begin_worker_process+0x3060) [0x32e480]\n &gt; /path/to/sozu/target/debug/sozu(sozu::main+0x42e) [0x556afe]\n &gt; /path/to/sozu/target/debug/sozu(core::ops::function::FnOnce::call_once+0xb) [0x1e453b]\n &gt; /path/to/sozu/target/debug/sozu(std::sys_common::backtrace::__rust_begin_short_backtrace+0xe) [0x287e6e]\n &gt; /path/to/sozu/target/debug/sozu(std::rt::lang_start::{{closure}}+0x11) [0x2ff2e1]\n &gt; /path/to/sozu/target/debug/sozu(std::rt::lang_start_internal+0x42e) [0x18217fe]\n &gt; /path/to/sozu/target/debug/sozu(std::rt::lang_start+0x3a) [0x2ff2ba]\n &gt; /path/to/sozu/target/debug/sozu(main+0x1e) [0x556f6e]\n &gt; /usr/lib/libc.so.6(__libc_init_first+0x90) [0x27cd0]\n &gt; /usr/lib/libc.so.6(__libc_start_main+0x8a) [0x27d8a]\n &gt; /path/to/sozu/target/debug/sozu(_start+0x25) [0x17bca5]\n</code></pre>"},{"location":"benchmark_zh/","title":"\u5982\u4f55\u5bf9 S\u014dzu \u8fdb\u884c\u57fa\u51c6\u6d4b\u8bd5/\u89c2\u5bdf","text":"<p>\u7528\u4e8e\u8c03\u8bd5\u548c\u4f18\u5316\u76ee\u7684\u3002</p>"},{"location":"benchmark_zh/#sozu_1","title":"\u5728\u60a8\u7684\u673a\u5668\u4e0a\u8fd0\u884c S\u014dzu\uff0c\u4f7f\u7528\u865a\u62df\u540e\u7aef","text":""},{"location":"benchmark_zh/#http-https","title":"\u521b\u5efa\u4e00\u4e2a\u5305\u542b HTTP \u548c HTTPS \u76d1\u542c\u5668\u7684\u914d\u7f6e","text":"<p><code>bin/config.toml</code> \u7684\u5927\u591a\u6570\u9ed8\u8ba4\u503c\u90fd\u662f\u5408\u7406\u7684\uff0c\u5c06\u5b83\u4eec\u590d\u5236\u5230 <code>bin/my-config.toml</code>\u3002 \u4e00\u4e2a\u9700\u8981\u8c03\u6574\u7684\u91cd\u8981\u503c\u662f <code>worker_count</code>\u3002\u4ec5\u6d4b\u8bd5\u4e00\u4e2a \u5de5\u4f5c\u8fdb\u7a0b\u7684\u6027\u80fd\u4f3c\u4e4e\u662f\u7406\u60f3\u7684\uff1a</p> <pre><code>worker_count = 1\n</code></pre> <p>HTTP \u548c HTTPS \u76d1\u542c\u5668\u5e94\u8be5\u76f8\u540c\u3002 \u4e3a HTTPS \u76d1\u542c\u5668\u9009\u62e9\u4e00\u4e2a TLS \u7248\u672c\u548c\u4e00\u4e2a\u5bc6\u7801\u5217\u8868\uff0c\u5e76\u575a\u6301\u4f7f\u7528\u5b83\u3002</p> <pre><code>[[listeners]]\nprotocol = \"http\"\naddress = \"0.0.0.0:8080\"\n\n[[listeners]]\nprotocol = \"https\"\naddress = \"0.0.0.0:8443\"\ntls_versions = [\"TLS_V13\"]\n\ncipher_list = [\n  # \"TLS13_AES_128_GCM_SHA256\",\n  \"TLS13_CHACHA20_POLY1305_SHA256\",\n  # ...\n]\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a\u96c6\u7fa4\uff08\u76f8\u5f53\u4e8e\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff09\uff0c\u5b83\u6709\u4e24\u4e2a\u524d\u7aef\uff1a \u4e00\u4e2a\u7528\u4e8e HTTP \u8bf7\u6c42\uff0c\u4e00\u4e2a\u7528\u4e8e HTTPS \u8bf7\u6c42\u3002</p> <p>\u786e\u4fdd\u60a8\u4e3a <code>localhost</code> \u57df\u521b\u5efa\u4e86\u81ea\u5df1\u7684\u8bc1\u4e66\u548c\u5bc6\u94a5\u3002</p> <pre><code>frontends = [\n    { address = \"0.0.0.0:8080\", hostname = \"localhost\", path = \"/api\" },\n    { address = \"0.0.0.0:8443\", hostname = \"localhost\", certificate = \"/path/to/your/certificate.pem\", key = \"/path/to/your/key.pem\", certificate_chain = \"/path/to/your/certificate.pem\" },\n]\n</code></pre> <p>\u6216\u8005\u4f7f\u7528 <code>config.toml</code> \u7684\u8bc1\u4e66\u3001\u5bc6\u94a5\u548c\u8bc1\u4e66\u94fe\uff0c \u5b83\u4eec\u4f4d\u4e8e <code>/lib/assets/</code>\u3002 \u4f46\u8fd9\u6837\u60a8\u5fc5\u987b\u4f7f\u7528 <code>lolcatho.st</code> \u4f5c\u4e3a\u672c\u5730\u57df\u540d\uff0c \u5e76\u786e\u4fdd\u60a8\u7684 <code>/etc/hosts</code> \u4e2d\u6709\u8fd9\u4e9b\u884c\uff1a</p> <pre><code>127.0.0.1       lolcatho.st\n::1             lolcatho.st\n</code></pre>"},{"location":"benchmark_zh/#4","title":"\u751f\u6210 4 \u4e2a\u540e\u7aef","text":"<p>\u521b\u5efa\u56db\u4e2a\u7b80\u5355\u7684 HTTP \u670d\u52a1\u5668\uff0c\u5f53\u901a\u8fc7 HTTP GET \u8bf7\u6c42 <code>/api</code> \u8def\u5f84\u65f6\uff0c\u6bcf\u4e2a\u670d\u52a1\u5668\u90fd\u56de\u590d 200 OK\uff08\u968f\u610f\u9009\u62e9\uff09\u3002 \u4f7f\u7528\u60a8\u559c\u6b22\u7684\u7f16\u7a0b\u8bed\u8a00\uff0c\u8fd9\u5e94\u8be5\u5f88\u7b80\u5355\u3002 \u8fd9\u662f 8 \u884c javascript \u4ee3\u7801\u3002 \u786e\u4fdd\u6bcf\u4e2a\u540e\u7aef\u90fd\u5728 localhost \u4e0a\u76d1\u542c\uff0c\u5e76\u4e14\u7aef\u53e3\u4e0d\u540c\uff0c \u4f8b\u5982\uff1a1051\u30011052\u30011053\u30011054\u3002</p> <p>\u5c06\u8fd9\u4e9b\u540e\u7aef\u6dfb\u52a0\u5230 <code>my-config.toml</code> \u7684 frontends \u4e0b\uff1a</p> <pre><code>bac&lt;ctrl61&gt;kends = [\n    { address = \"127.0.0.1:1051\", backend_id = \"backend_1\" },\n    { address = \"127.0.0.1:1052\", backend_id = \"backend_2\" },\n    { address = \"127.0.0.1:1053\", backend_id = \"backend_3\" },\n    { address = \"127.0.0.1:1054\", backend_id = \"backend_4\" },\n]\n</code></pre>"},{"location":"benchmark_zh/#sozu_2","title":"\u6784\u5efa\u5e76\u8fd0\u884c S\u014dzu","text":"<p>\u4ee5 release \u6a21\u5f0f\u6784\u5efa S\u014dzu\u3002</p> <pre><code>cargo build --release\n</code></pre> <p>\u63d0\u793a\uff1a\u91cd\u547d\u540d release \u4e8c\u8fdb\u5236\u6587\u4ef6\u5e76\u5c06\u5176\u653e\u5165 cargo \u8def\u5f84\uff1a</p> <pre><code>mv target/release/sozu $HOME/.cargo/bin/sozu-0.15.14\n</code></pre> <p>\u73b0\u5728\u60a8\u53ef\u4ee5\u4ee5 release \u6a21\u5f0f\u8fd0\u884c S\u014dzu\uff1a</p> <pre><code>cd bin\nsozu-0.15.14 --config my-config.toml start\n</code></pre> <p>\u901a\u8fc7 S\u014dzu \u4f7f\u7528 curl \u68c0\u67e5\u540e\u7aef\u662f\u5426\u5de5\u4f5c\uff1a</p> <pre><code>curl https://localhost:8443/api -v\ncurl http://localhost:8080/api  -v\n</code></pre>"},{"location":"benchmark_zh/#bombardier","title":"Bombardier","text":"<p>Bombardier \u662f\u4e00\u4e2a\u7528 go \u7f16\u5199\u7684 HTTP \u548c HTTPS \u57fa\u51c6\u6d4b\u8bd5\u5de5\u5177\u3002 \u5728\u5927\u591a\u6570 linux \u53d1\u884c\u7248\u4e2d\u5b83\u90fd\u662f\u4e00\u4e2a\u53ef\u7528\u7684\u5305\uff0c \u5e76\u4e14\u5728\u547d\u4ee4\u884c\u4e2d\u6613\u4e8e\u4f7f\u7528\u3002</p>"},{"location":"benchmark_zh/#_1","title":"\u5728\u4e00\u4e2a\u8fde\u63a5\u4e0a\u6d4b\u8bd5\u5927\u91cf\u8bf7\u6c42","text":"<pre><code>bombardier --connections=1 --requests=10000 https://localhost:8443/api --latencies\nbombardier --connections=1 --requests=10000 http://localhost:8080/api --latencies\n</code></pre>"},{"location":"benchmark_zh/#_2","title":"\u6d4b\u8bd5\u5e76\u53d1\u8fde\u63a5","text":"<pre><code>bombardier --connections=100 --requests=10000 https://localhost:8443/api --latencies\nbombardier --connections=100 --requests=10000 http://localhost:8080/api --latencies\n</code></pre> <p>\u589e\u52a0\u8fde\u63a5\u6570\uff0c\u76f4\u5230 S\u014dzu \u65e0\u6cd5\u627f\u53d7\u3002</p>"},{"location":"benchmark_zh/#tls-perf","title":"TLS-perf","text":"<p><code>tls-perf</code> \u662f\u4e00\u4e2a\u7528 C \u7f16\u5199\u7684 TLS \u538b\u529b\u6d4b\u8bd5\u5de5\u5177\u3002 \u5b83\u6ca1\u6709\u4f9d\u8d56\u9879\uff0c\u5e76\u4e14\u6613\u4e8e\u6784\u5efa\u3002</p> <pre><code>git clone git@github.com:tempesta-tech/tls-perf.git\ncd tls-perf\nmake\nmv tls-perf $HOME/.local/bin\n</code></pre> <p>\u5047\u8bbe <code>$HOME/.local/bin</code> \u5728\u60a8\u7684\u8def\u5f84\u4e2d\u3002</p> <p>\u6b64\u547d\u4ee4\u6267\u884c\uff1a - \u4e00\u4e07\u6b21 TLS \u63e1\u624b - \u4ec5\u4f7f\u7528\u4e00\u4e2a\u8fde\u63a5 - \u4f7f\u7528 TLS 1.3 \u7248\u672c</p> <pre><code>tls-perf \\\n  -n 10000 \\\n  -l 1 \\\n  --sni localhost \\\n  --tls 1.3 \\\n  127.0.0.1 8443\n</code></pre>"},{"location":"benchmark_zh/#strace","title":"\u4f7f\u7528 <code>strace</code> \u67e5\u627e\u7cfb\u7edf\u8c03\u7528","text":"<p><code>strace</code> \u662f\u4e00\u4e2a\u8bca\u65ad\u5de5\u5177\uff0c\u53ef\u4ee5\u76d1\u89c6 \u8fdb\u7a0b\uff08S\u014dzu\uff09\u548c linux \u5185\u6838\u4e4b\u95f4\u7684\u4ea4\u4e92\u3002\u5728\u5927\u591a\u6570 linux \u53d1\u884c\u7248\u4e2d\u5b83\u90fd\u662f\u4e00\u4e2a\u53ef\u7528\u7684\u5305\u3002</p> <p>S\u014dzu \u8fd0\u884c\u540e\uff0c\u627e\u5230\u5de5\u4f5c\u8fdb\u7a0b\u7684 pid\uff1a</p> <pre><code>ps -aux | grep sozu\nuser   13368  0.7  0.1 188132 40344 pts/2    Sl+  11:35   0:00 /path/to/sozu --config my-config.toml start\nuser   14157  0.0  0.0  79908 29628 pts/2    S+   11:35   0:00 /path/to/sozu worker --id 0 --fd 5 --scm 7 --configuration-state-fd 3 --command-buffer-size 16384 --max-command-buffer-size 16384\nuser   14205  0.0  0.0   6556  2412 pts/3    S+   11:35   0:00 grep --color=auto sozu\n</code></pre> <p>\u7b2c\u4e8c\u884c\u662f\u5de5\u4f5c\u8fdb\u7a0b\uff0c\u5176 pid \u662f <code>14157</code>\u3002</p> <p>\u4f7f\u7528 strace \u8ddf\u8e2a\u6b64 pid\u3002\u60a8\u53ef\u80fd\u9700\u8981 root \u6743\u9650\u3002</p> <pre><code>strace --attach=14157\n</code></pre> <p>\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u5e38\u89c4\u7684 <code>epoll_wait</code> \u7cfb\u7edf\u8c03\u7528\uff0c\u8fd9\u662f S\u014dzu \u7684\u4e3b\u5faa\u73af\u3002</p> <pre><code>epoll_wait(3, [], 1024, 1000)           = 0\nepoll_wait(3, [], 1024, 1000)           = 0\nepoll_wait(3, [], 1024, 1000)           = 0\nepoll_wait(3, [], 1024, 318)            = 0\n</code></pre> <p>\u5982\u679c\u60a8\u6267\u884c\u5176\u4e2d\u4e00\u4e2a curl\uff0c\u60a8\u5c06\u770b\u5230 S\u014dzu \u5728 HTTP \u6216 HTTPS \u8bf7\u6c42\u671f\u95f4\u6267\u884c\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528\u3002 \u4ee5\u4e0b\u662f\u5728\u7b80\u5355\u540e\u7aef\u4e0a\u8fdb\u884c HTTP GET \u671f\u95f4\u53d1\u751f\u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u8fd9\u53ea\u662f\u5728\u76d1\u542c\u5668\u5957\u63a5\u5b57\u4e0a\u63a5\u53d7\u6d41\u91cf\u3002</p> <pre><code># \u4e3b\u5faa\u73af\u7b49\u5f85\u4e8b\u4ef6\nepoll_wait(3, [], 1024, 1000)           = 0\n\n# \u4e00\u4e2a\u53ef\u8bfb\u4e8b\u4ef6 (EPOLLIN)\u3002\u4e00\u4e2a\u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u4e00\u4e2a\u76d1\u542c\u5668\u5957\u63a5\u5b57\u3002\nepoll_wait(3, [{events=EPOLLIN, data={u32=3, u64=3}}], 1024, 1000) = 1\n\n# \u4ee3\u7406\u63a5\u53d7\u8fde\u63a5\uff0c\u901a\u8fc7\u544a\u8bc9\u76d1\u542c\u5668\u63a5\u53d7\n# \u5957\u63a5\u5b57\u4e0a\u7684\u4f20\u5165\u8fde\u63a5\naccept4(9, {sa_family=AF_INET, sin_port=htons(46144), sin_addr=inet_addr(\"127.0.0.1\")}, [128 =&gt; 16], SOCK_CLOEXEC|SOCK_NONBLOCK) = 11\n\n# \u5b8c\u6210\uff01\u6ca1\u6709\u66f4\u591a\u8fde\u63a5\u8981\u63a5\u53d7\naccept4(9, 0x7ffe89e39b98, [128], SOCK_CLOEXEC|SOCK_NONBLOCK) = -1 EAGAIN (Resource temporarily unavailable)\n\n# HTTP \u4ee3\u7406\u5728\u5957\u63a5\u5b57\u4e0a\u8bbe\u7f6e NODELAY\nsetsockopt(11, SOL_TCP, TCP_NODELAY, [1], 4) = 0\n\n# S\u014dzu \u5728\u63a5\u53d7\u961f\u5217\u4e2d\u6ce8\u518c\u5957\u63a5\u5b57\n# \u63a5\u53d7\u961f\u5217\u5728\u53e6\u4e00\u4e2a\u5faa\u73af\u4e2d\u5f39\u51fa\uff0c\u4ee5\u521b\u5efa\u4f1a\u8bdd\n\n# \u521b\u5efa\u4f1a\u8bdd\u65f6\uff0c\u5957\u63a5\u5b57\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u6ce8\u518c\nepoll_ctl(6, EPOLL_CTL_ADD, 11, {events=EPOLLIN|EPOLLOUT|EPOLLRDHUP|EPOLLET, data={u32=267, u64=267}}) = 0\n\n# \u83b7\u53d6\u5957\u63a5\u5b57\u7684\u5730\u5740\uff08\u8fd9\u91cc\uff0c\u4e3b\u673a\u76f8\u540c\uff0c\u4f46\u7aef\u53e3\u4e0d\u540c\uff09\ngetpeername(11, {sa_family=AF_INET, sin_port=htons(46144), sin_addr=inet_addr(\"127.0.0.1\")}, [128 =&gt; 16]) = 0\n\n# \u8fd4\u56de\u4e3b\u4e8b\u4ef6\u5faa\u73af\nepoll_wait(3, [{events=EPOLLIN|EPOLLOUT, data={u32=267, u64=267}}], 1024, 1000) = 1\n\n# \u6211\u4eec\u51c6\u5907\u597d\u8ba9\u6d41\u91cf\u901a\u8fc7\u8fd9\u4e2a\u5957\u63a5\u5b57\n\n# \u6765\u4e86\uff01\nrecvfrom(11, \"GET /api HTTP/1.1\\r\\nHost: localho\"..., 16400, 0, NULL, NULL) = 80\n</code></pre>"},{"location":"benchmark_zh/#_3","title":"\u627e\u51fa\u4ee3\u7801\u7684\u54ea\u4e9b\u90e8\u5206\u5bfc\u81f4\u4e86\u7cfb\u7edf\u8c03\u7528","text":"<p>\u5bf9\u4e8e\u8fd9\u79cd\u6316\u6398\uff0cS\u014dzu \u5fc5\u987b\u5728\u8c03\u8bd5\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u5373\uff1a \u672a\u4f7f\u7528 <code>--release</code> \u6807\u5fd7\u7f16\u8bd1\u3002\u6267\u884c\uff1a</p> <pre><code>cargo run -- --config my-config.toml start\n</code></pre> <p>\u5982\u4e0a\u6240\u8ff0\u627e\u5230 pid\uff0c\u7136\u540e\u6267\u884c\uff1a</p> <pre><code>strace --attach=14157 --stack-traces\n# \u6216\nstrace -p 14157 -k\n</code></pre> <p>curl \u4e00\u6b21 S\u014dzu\uff0c\u4f8b\u5982</p> <pre><code>curl http://localhost:8080/api  -v\n</code></pre> <p>\u73b0\u5728\u60a8\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u7cfb\u7edf\u8c03\u7528\u662f\u7531\u54ea\u6bb5\u4ee3\u7801\u8d1f\u8d23\u7684\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u662f\u8d1f\u8d23\u5728\u6587\u4ef6\u63cf\u8ff0\u7b26 12 \u7684\u5957\u63a5\u5b57\u4e0a\u8fdb\u884c <code>connect</code> \u7cfb\u7edf\u8c03\u7528\u7684\u4ee3\u7801\u3002 \u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5b83\u662f\u4e00\u4e2a HTTP \u4f1a\u8bdd\u8fde\u63a5\u5230\u5176\u540e\u7aef\uff1a</p> <pre><code>connect(12, {sa_family=AF_INET, sin_port=htons(1052), sin_addr=inet_addr(\"127.0.0.1\")}, 16) = -1 EINPROGRESS (Operation now in progress)\n &gt; /usr/lib/libc.so.6(__connect+0x14) [0x112454]\n &gt; /path/to/sozu/target/debug/sozu(mio::sys::unix::tcp::connect+0x84) [0x17b2ec4]\n &gt; /path/to/sozu/target/debug/sozu(mio::net::tcp::stream::TcpStream::connect+0x127) [0x17ad9e7]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::backends::Backend::try_connect+0x88) [0xb03898]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::backends::BackendMap::backend_from_cluster_id+0x465) [0xb04145]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::get_backend_for_sticky_session+0x5ab) [0xca8beb]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::backend_from_request+0x159) [0xca69b9]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::connect_to_backend+0xb7a) [0xcaafba]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt;::ready_inner+0x423) [0xcaf3a3]\n &gt; /path/to/sozu/target/debug/sozu(&lt;sozu_lib::protocol::kawa_h1::Http&lt;Front,L&gt; as sozu_lib::protocol::SessionState&gt;::ready+0x2d) [0xcb040d]\n &gt; /path/to/sozu/target/debug/sozu(&lt;sozu_lib::http::HttpStateMachine as sozu_lib::protocol::SessionState&gt;::ready+0xf2) [0xdbb9b2]\n &gt; /path/to/sozu/target/debug/sozu(&lt;sozu_lib::http::HttpSession as sozu_lib::ProxySession&gt;::ready+0x114) [0xdb4b54]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::server::Server::ready+0x746) [0xc95846]\n &gt; /path/to/sozu/target/debug/sozu(sozu_lib::server::Server::run+0x66d) [0xc8869d]\n &gt; /path/to/sozu/target/debug/sozu(sozu::worker::begin_worker_process+0x3060) [0x32e480]\n &gt; /path/to/sozu/target/debug/sozu(sozu::main+0x42e) [0x556afe]\n &gt; /path/to/sozu/target/debug/sozu(core::ops::function::FnOnce::call_once+0xb) [0x1e453b]\n &gt; /path/to/sozu/target/debug/sozu(std::sys_common::backtrace::__rust_begin_short_backtrace+0xe) [0x287e6e]\n &gt; /path/to/sozu/target/debug/sozu(std::rt::lang_start::{{closure}}+0x11) [0x2ff2e1]\n &gt; /path/to/sozu/target/debug/sozu(std::rt::lang_start_internal+0x42e) [0x18217fe]\n &gt; /path/to/sozu/target/debug/sozu(std::rt::lang_start+0x3a) [0x2ff2ba]\n &gt; /path/to/sozu/target/debug/sozu(main+0x1e) [0x556f6e]\n &gt; /usr/lib/libc.so.6(__libc_init_first+0x90) [0x27cd0]\n &gt; /usr/lib/libc.so.6(__libc_start_main+0x8a) [0x27d8a]\n &gt; /path/to/sozu/target/debug/sozu(_start+0x25) [0x17bca5]\n</code></pre>"},{"location":"cli_configuration_example/","title":"CLI Configuration Example","text":""},{"location":"cli_configuration_example/#configuring-a-cluster-via-the-sozu-command-line","title":"Configuring a Cluster via the Sozu Command Line","text":"<p>This document demonstrates how to use the <code>sozu</code> command-line tool to configure clusters, frontends, and backends as an alternative to directly editing the <code>config.toml</code> file.</p> <p>Important Note: All <code>sozu</code> commands require the <code>--config &lt;your-config-file&gt;</code> parameter to specify the configuration file. This file contains the path to the command socket that the sozu instance is listening on, allowing the command-line tool to communicate with sozu. In the following examples, we use <code>--config config.toml</code>.</p>"},{"location":"cli_configuration_example/#original-configtoml-configuration-example","title":"Original <code>config.toml</code> Configuration Example:","text":"<pre><code># A unique identifier for our routing rule.\n[clusters.komo]\n\n# The protocol this cluster will handle.\nprotocol = \"http\"\nload_balancing = \"ROUND_ROBIN\"\n\n# 'frontends' define which requests this cluster will handle.\n# It matches requests coming to the listener at 'address' with the specified 'hostname'.\nfrontends = [\n    { address = \"0.0.0.0:80\", hostname = \"dash.bdev.cn\" },\n    { address = \"0.0.0.0:443\", hostname = \"dash.bdev.cn\" }\n]\n\n# 'backends' define where to forward the matched requests.\nbackends = [\n    { address = \"komodo-core-1:9120\" }\n]\n</code></pre>"},{"location":"cli_configuration_example/#converting-configtoml-configuration-to-command-line-instructions","title":"Converting <code>config.toml</code> Configuration to Command-Line Instructions","text":"<p>The following are the steps to convert the <code>config.toml</code> configuration above into equivalent <code>sozu</code> command-line instructions:</p>"},{"location":"cli_configuration_example/#1-add-a-cluster","title":"1. Add a Cluster","text":"<p>First, create a new cluster named <code>komo</code> and set its load balancing policy. Note that we use the <code>--id</code> and <code>--load-balancing-policy</code> parameters.</p> <pre><code>sozu --config config.toml cluster add --id komo --load-balancing-policy ROUND_ROBIN\n</code></pre> <p>Explanation: *   <code>--config config.toml</code>: Specifies the sozu configuration file. *   <code>cluster add --id komo</code>: Creates a new cluster with the unique identifier <code>komo</code>. *   <code>--load-balancing-policy ROUND_ROBIN</code>: Sets the load balancing algorithm to round-robin.</p> <p>Regarding Protocol (<code>protocol</code>): The <code>cluster add</code> command may not directly support setting the protocol. If <code>http</code> is not the default, you may need to use the <code>sozu cluster modify</code> command or check <code>sozu cluster add --help</code> for complete options.</p>"},{"location":"cli_configuration_example/#2-add-frontends","title":"2. Add Frontends","text":"<p>Next, add two frontends for the <code>komo</code> cluster to match incoming requests. Note the structure of the command: the protocol (<code>http</code> or <code>https</code>) comes after <code>frontend</code>, and you must use the <code>id &lt;cluster_id&gt;</code> subcommand at the end to associate it with the cluster.</p> <pre><code># Add a frontend to handle HTTP (port 80)\nsozu --config config.toml frontend http add --address 0.0.0.0:80 --hostname dash.bdev.cn id komo\n\n# Add a frontend to handle HTTPS (port 443)\nsozu --config config.toml frontend https add --address 0.0.0.0:443 --hostname dash.bdev.cn id komo\n</code></pre> <p>Explanation: *   <code>frontend http add</code> / <code>frontend https add</code>: Defines a frontend addition operation for the HTTP or HTTPS protocol, respectively. *   <code>--address ... --hostname ...</code>: Defines the rules for matching traffic. *   <code>id komo</code>: Associates this frontend rule with the cluster with ID <code>komo</code>.</p>"},{"location":"cli_configuration_example/#3-add-a-backend","title":"3. Add a Backend","text":"<p>Finally, add the backend service address to the <code>komo</code> cluster. Sozu will forward matched requests here. Note that you need to specify the cluster with <code>--id</code> and provide a unique identifier for this backend with <code>--backend-id</code>.</p> <pre><code>sozu --config config.toml backend add --id komo --backend-id komodo-core-1 --address komodo-core-1:9120\n</code></pre> <p>Explanation: *   <code>backend add</code>: Defines a backend addition operation. *   <code>--id komo</code>: Specifies the target cluster ID to add the backend to. *   <code>--backend-id komodo-core-1</code>: Sets a unique identifier for this backend within the cluster. *   <code>--address komodo-core-1:9120</code>: Sets the address and port of the backend server.</p>"},{"location":"cli_configuration_example/#complete-command-line-configuration-flow","title":"Complete Command-Line Configuration Flow","text":"<p>The design philosophy of <code>sozu</code> is to manage listeners, certificates, and routing rules (frontends) separately. Configuring a complete HTTPS service, as described in a <code>config.toml</code> file, requires a series of steps via the command line.</p> <p>Assume your certificate and private key files are located at: *   Certificate: <code>/etc/sozu/certs/certificate.pem</code> *   Private Key: <code>/etc/sozu/certs/key.pem</code></p> <p>The following are the complete steps:</p>"},{"location":"cli_configuration_example/#step-1-create-a-cluster","title":"Step 1: Create a Cluster","text":"<p>First, create a new cluster named <code>komo</code> and set its load balancing policy.</p> <pre><code># 1. Create the cluster\nsozu --config config.toml cluster add --id komo --load-balancing-policy ROUND_ROBIN\n</code></pre>"},{"location":"cli_configuration_example/#step-2-add-a-certificate-for-https","title":"Step 2: Add a Certificate for HTTPS","text":"<p>For HTTPS traffic, you must first associate the TLS certificate and private key with the address that will be listening (<code>0.0.0.0:443</code>).</p> <pre><code># 2. Add the certificate\nsozu --config config.toml certificate add \\\n  --address 0.0.0.0:443 \\\n  --certificate /etc/sozu/certs/certificate.pem \\\n  --certificate-chain /etc/sozu/certs/certificate.pem \\\n  --key /etc/sozu/certs/key.pem\n</code></pre> <p>Explanation: *   <code>certificate add</code>: Defines a certificate addition operation. *   <code>--address 0.0.0.0:443</code>: Specifies which listening address this certificate is for. *   <code>--certificate</code>, <code>--certificate-chain</code>, <code>--key</code>: Specify the file paths for the certificate, certificate chain, and private key, respectively. If the certificate and chain are in the same file, you can use the same path for both.</p>"},{"location":"cli_configuration_example/#step-3-associate-frontends","title":"Step 3: Associate Frontends","text":"<p>Now, create frontend rules to tell sozu how to route traffic from ports 80 (HTTP) and 443 (HTTPS) based on the <code>hostname</code>.</p> <pre><code># 3. Associate the frontends\nsozu --config config.toml frontend http add --address 0.0.0.0:80 --hostname dash.bdev.cn id komo\nsozu --config config.toml frontend https add --address 0.0.0.0:443 --hostname dash.bdev.cn id komo\n</code></pre> <p>Explanation: *   <code>frontend http add</code> / <code>frontend https add</code>: Defines routing rules for HTTP and HTTPS, respectively. *   <code>id komo</code>: Routes traffic matching this rule to the cluster with ID <code>komo</code>.</p>"},{"location":"cli_configuration_example/#step-4-associate-a-backend","title":"Step 4: Associate a Backend","text":"<p>Finally, add the backend service address to the <code>komo</code> cluster.</p> <pre><code># 4. Associate the backend\nsozu --config config.toml backend add --id komo --backend-id komodo-core-1 --address komodo-core-1:9120\n</code></pre> <p>Explanation: *   <code>backend add</code>: Defines a backend addition operation. *   <code>--id komo</code>: Specifies the target cluster to add the backend to. *   <code>--backend-id ... --address ...</code>: Defines the unique ID and address of the backend.</p> <p>By following these four steps, you have completely reproduced the configuration from the <code>config.toml</code> file using the command line.</p>"},{"location":"cli_configuration_example_zh/","title":"CLI \u914d\u7f6e\u793a\u4f8b","text":""},{"location":"cli_configuration_example_zh/#sozu","title":"\u901a\u8fc7 Sozu \u547d\u4ee4\u884c\u914d\u7f6e\u96c6\u7fa4","text":"<p>\u672c\u8bf4\u660e\u6f14\u793a\u5982\u4f55\u4f7f\u7528 <code>sozu</code> \u547d\u4ee4\u884c\u5de5\u5177\u6765\u914d\u7f6e\u96c6\u7fa4\u3001\u524d\u7aef\u548c\u540e\u7aef\uff0c\u4ee5\u66ff\u4ee3\u76f4\u63a5\u7f16\u8f91 <code>config.toml</code> \u6587\u4ef6\u3002</p> <p>\u91cd\u8981\u63d0\u793a: \u6240\u6709 <code>sozu</code> \u547d\u4ee4\u90fd\u9700\u8981\u901a\u8fc7 <code>--config &lt;your-config-file&gt;</code> \u53c2\u6570\u6765\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6\u3002\u6b64\u6587\u4ef6\u5305\u542b\u4e86 sozu \u5b9e\u4f8b\u6b63\u5728\u76d1\u542c\u7684\u547d\u4ee4\u5957\u63a5\u5b57\uff08command socket\uff09\u7684\u8def\u5f84\uff0c\u4ece\u800c\u8ba9\u547d\u4ee4\u884c\u5de5\u5177\u80fd\u591f\u4e0e sozu \u901a\u4fe1\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 <code>--config config.toml</code>\u3002</p>"},{"location":"cli_configuration_example_zh/#configtoml","title":"\u539f\u59cb <code>config.toml</code> \u914d\u7f6e\u793a\u4f8b\uff1a","text":"<pre><code># A unique identifier for our routing rule.\n[clusters.komo]\n\n# The protocol this cluster will handle.\nprotocol = \"http\"\nload_balancing = \"ROUND_ROBIN\"\n\n# 'frontends' define which requests this cluster will handle.\n# It matches requests coming to the listener at 'address' with the specified 'hostname'.\nfrontends = [\n    { address = \"0.0.0.0:80\", hostname = \"dash.bdev.cn\" },\n    { address = \"0.0.0.0:443\", hostname = \"dash.bdev.cn\" }\n]\n\n# 'backends' define where to forward the matched requests.\nbackends = [\n    { address = \"komodo-core-1:9120\" }\n]\n</code></pre>"},{"location":"cli_configuration_example_zh/#configtoml_1","title":"\u5c06 <code>config.toml</code> \u914d\u7f6e\u8f6c\u6362\u4e3a\u547d\u4ee4\u884c\u6307\u4ee4","text":"<p>\u4ee5\u4e0b\u662f\u5c06\u4e0a\u8ff0 <code>config.toml</code> \u914d\u7f6e\u8f6c\u6362\u4e3a\u7b49\u6548 <code>sozu</code> \u547d\u4ee4\u884c\u6307\u4ee4\u7684\u6b65\u9aa4\uff1a</p>"},{"location":"cli_configuration_example_zh/#1-cluster","title":"1. \u6dfb\u52a0\u96c6\u7fa4 (Cluster)","text":"<p>\u9996\u5148\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>komo</code> \u7684\u96c6\u7fa4\uff0c\u5e76\u8bbe\u7f6e\u5176\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002\u8bf7\u6ce8\u610f\uff0c\u6839\u636e\u4e4b\u524d\u7684\u9519\u8bef\u63d0\u793a\uff0c\u6211\u4eec\u4f7f\u7528 <code>--id</code> \u548c <code>--load-balancing-policy</code> \u53c2\u6570\u3002</p> <pre><code>sozu --config config.toml cluster add --id komo --load-balancing-policy ROUND_ROBIN\n</code></pre> <p>\u8bf4\u660e: *   <code>--config config.toml</code>: \u6307\u5b9a sozu \u7684\u914d\u7f6e\u6587\u4ef6\u3002 *   <code>cluster add --id komo</code>: \u521b\u5efa\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\u7b26\u4e3a <code>komo</code> \u7684\u65b0\u96c6\u7fa4\u3002 *   <code>--load-balancing-policy ROUND_ROBIN</code>: \u8bbe\u7f6e\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u4e3a\u8f6e\u8be2\u3002</p> <p>\u5173\u4e8e\u534f\u8bae (<code>protocol</code>): <code>cluster add</code> \u547d\u4ee4\u53ef\u80fd\u4e0d\u76f4\u63a5\u652f\u6301\u8bbe\u7f6e\u534f\u8bae\u3002\u5982\u679c <code>http</code> \u4e0d\u662f\u9ed8\u8ba4\u534f\u8bae\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u4f7f\u7528 <code>sozu cluster modify</code> \u547d\u4ee4\u6216\u68c0\u67e5 <code>sozu cluster add --help</code> \u4ee5\u83b7\u53d6\u5b8c\u6574\u9009\u9879\u3002</p>"},{"location":"cli_configuration_example_zh/#2-frontends","title":"2. \u6dfb\u52a0\u524d\u7aef (Frontends)","text":"<p>\u63a5\u4e0b\u6765\uff0c\u4e3a <code>komo</code> \u96c6\u7fa4\u6dfb\u52a0\u4e24\u4e2a\u524d\u7aef\uff0c\u7528\u4e8e\u5339\u914d\u4f20\u5165\u7684\u8bf7\u6c42\u3002\u6ce8\u610f\u547d\u4ee4\u7684\u7ed3\u6784\uff1a\u534f\u8bae (<code>http</code> \u6216 <code>https</code>) \u5728 <code>frontend</code> \u4e4b\u540e\uff0c\u5e76\u4e14\u5fc5\u987b\u5728\u672b\u5c3e\u4f7f\u7528 <code>id &lt;cluster_id&gt;</code> \u5b50\u547d\u4ee4\u6765\u5c06\u5176\u5173\u8054\u5230\u96c6\u7fa4\u3002</p> <pre><code># \u6dfb\u52a0\u5904\u7406 HTTP (80\u7aef\u53e3) \u7684\u524d\u7aef\nsozu --config config.toml frontend http add --address 0.0.0.0:80 --hostname dash.bdev.cn id komo\n\n# \u6dfb\u52a0\u5904\u7406 HTTPS (443\u7aef\u53e3) \u7684\u524d\u7aef\nsozu --config config.toml frontend https add --address 0.0.0.0:443 --hostname dash.bdev.cn id komo\n</code></pre> <p>\u8bf4\u660e: *   <code>frontend http add</code> / <code>frontend https add</code>: \u5206\u522b\u5b9a\u4e49\u4e00\u4e2a HTTP \u6216 HTTPS \u534f\u8bae\u7684\u524d\u7aef\u6dfb\u52a0\u64cd\u4f5c\u3002 *   <code>--address ... --hostname ...</code>: \u5b9a\u4e49\u5339\u914d\u6d41\u91cf\u7684\u89c4\u5219\u3002 *   <code>id komo</code>: \u5c06\u6b64\u524d\u7aef\u89c4\u5219\u5173\u8054\u5230 ID \u4e3a <code>komo</code> \u7684\u96c6\u7fa4\u3002</p>"},{"location":"cli_configuration_example_zh/#3-backend","title":"3. \u6dfb\u52a0\u540e\u7aef (Backend)","text":"<p>\u6700\u540e\uff0c\u4e3a <code>komo</code> \u96c6\u7fa4\u6dfb\u52a0\u540e\u7aef\u7684\u670d\u52a1\u5730\u5740\uff0csozu \u4f1a\u5c06\u5339\u914d\u5230\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u8fd9\u91cc\u3002\u6ce8\u610f\uff0c\u9700\u8981\u4f7f\u7528 <code>--id</code> \u6307\u5b9a\u96c6\u7fa4\uff0c\u5e76\u4f7f\u7528 <code>--backend-id</code> \u4e3a\u6b64\u540e\u7aef\u63d0\u4f9b\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u7b26\u3002</p> <pre><code>sozu --config config.toml backend add --id komo --backend-id komodo-core-1 --address komodo-core-1:9120\n</code></pre> <p>\u8bf4\u660e: *   <code>backend add</code>: \u5b9a\u4e49\u4e00\u4e2a\u540e\u7aef\u6dfb\u52a0\u64cd\u4f5c\u3002 *   <code>--id komo</code>: \u6307\u5b9a\u8981\u6dfb\u52a0\u540e\u7aef\u7684\u76ee\u6807\u96c6\u7fa4 ID\u3002 *   <code>--backend-id komodo-core-1</code>: \u4e3a\u6b64\u540e\u7aef\u5728\u96c6\u7fa4\u4e2d\u8bbe\u7f6e\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u7b26\u3002 *   <code>--address komodo-core-1:9120</code>: \u8bbe\u7f6e\u540e\u7aef\u670d\u52a1\u5668\u7684\u5730\u5740\u548c\u7aef\u53e3\u3002</p>"},{"location":"cli_configuration_example_zh/#_1","title":"\u5b8c\u6574\u547d\u4ee4\u884c\u914d\u7f6e\u6d41\u7a0b","text":"<p><code>sozu</code> \u7684\u8bbe\u8ba1\u601d\u8def\u662f\u5c06\u76d1\u542c\u5668\u3001\u8bc1\u4e66\u548c\u8def\u7531\u89c4\u5219\uff08\u524d\u7aef\uff09\u5206\u5f00\u7ba1\u7406\u3002\u914d\u7f6e\u4e00\u4e2a\u5b8c\u6574\u7684\u3001\u7531 <code>config.toml</code> \u6587\u4ef6\u63cf\u8ff0\u7684 HTTPS \u670d\u52a1\uff0c\u9700\u8981\u901a\u8fc7\u547d\u4ee4\u884c\u5206\u6b65\u6267\u884c\u3002</p> <p>\u5047\u8bbe\u60a8\u7684\u8bc1\u4e66\u548c\u79c1\u94a5\u6587\u4ef6\u4f4d\u4e8e\uff1a *   \u8bc1\u4e66: <code>/etc/sozu/certs/certificate.pem</code> *   \u79c1\u94a5: <code>/etc/sozu/certs/key.pem</code></p> <p>\u4ee5\u4e0b\u662f\u5b8c\u6574\u7684\u6b65\u9aa4\uff1a</p>"},{"location":"cli_configuration_example_zh/#1-cluster_1","title":"\u7b2c 1 \u6b65: \u521b\u5efa\u96c6\u7fa4 (Cluster)","text":"<p>\u9996\u5148\uff0c\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>komo</code> \u7684\u96c6\u7fa4\uff0c\u5e76\u8bbe\u7f6e\u5176\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002</p> <pre><code># 1. \u521b\u5efa\u96c6\u7fa4\nsozu --config config.toml cluster add --id komo --load-balancing-policy ROUND_ROBIN\n</code></pre>"},{"location":"cli_configuration_example_zh/#2-https","title":"\u7b2c 2 \u6b65: \u4e3a HTTPS \u6dfb\u52a0\u8bc1\u4e66","text":"<p>\u5bf9\u4e8e HTTPS \u6d41\u91cf\uff0c\u60a8\u5fc5\u987b\u5148\u5c06 TLS \u8bc1\u4e66\u548c\u79c1\u94a5\u5173\u8054\u5230\u5c06\u8981\u76d1\u542c\u7684\u5730\u5740 (<code>0.0.0.0:443</code>)\u3002</p> <pre><code># 2. \u6dfb\u52a0\u8bc1\u4e66\nsozu --config config.toml certificate add \\\n  --address 0.0.0.0:443 \\\n  --certificate /etc/sozu/certs/certificate.pem \\\n  --certificate-chain /etc/sozu/certs/certificate.pem \\\n  --key /etc/sozu/certs/key.pem\n</code></pre> <p>\u8bf4\u660e: *   <code>certificate add</code>: \u5b9a\u4e49\u4e00\u4e2a\u8bc1\u4e66\u6dfb\u52a0\u64cd\u4f5c\u3002 *   <code>--address 0.0.0.0:443</code>: \u6307\u5b9a\u6b64\u8bc1\u4e66\u7528\u4e8e\u54ea\u4e2a\u76d1\u542c\u5730\u5740\u3002 *   <code>--certificate</code>, <code>--certificate-chain</code>, <code>--key</code>: \u5206\u522b\u6307\u5b9a\u8bc1\u4e66\u3001\u8bc1\u4e66\u94fe\u548c\u79c1\u94a5\u7684\u6587\u4ef6\u8def\u5f84\u3002\u5982\u679c\u8bc1\u4e66\u548c\u94fe\u5728\u540c\u4e00\u6587\u4ef6\uff0c\u53ef\u4f7f\u7528\u76f8\u540c\u8def\u5f84\u3002</p>"},{"location":"cli_configuration_example_zh/#3-frontends","title":"\u7b2c 3 \u6b65: \u5173\u8054\u524d\u7aef (Frontends)","text":"<p>\u73b0\u5728\uff0c\u521b\u5efa\u524d\u7aef\u89c4\u5219\u6765\u544a\u8bc9 sozu \u5982\u4f55\u6839\u636e <code>hostname</code> \u8def\u7531\u6765\u81ea\u7aef\u53e3 80 (HTTP) \u548c 443 (HTTPS) \u7684\u6d41\u91cf\u3002</p> <pre><code># 3. \u5173\u8054\u524d\u7aef\nsozu --config config.toml frontend http add --address 0.0.0.0:80 --hostname dash.bdev.cn id komo\nsozu --config config.toml frontend https add --address 0.0.0.0:443 --hostname dash.bdev.cn id komo\n</code></pre> <p>\u8bf4\u660e: *   <code>frontend http add</code> / <code>frontend https add</code>: \u5206\u522b\u4e3a HTTP \u548c HTTPS \u5b9a\u4e49\u8def\u7531\u89c4\u5219\u3002 *   <code>id komo</code>: \u5c06\u5339\u914d\u6b64\u89c4\u5219\u7684\u6d41\u91cf\u8def\u7531\u5230 ID \u4e3a <code>komo</code> \u7684\u96c6\u7fa4\u3002</p>"},{"location":"cli_configuration_example_zh/#4-backend","title":"\u7b2c 4 \u6b65: \u5173\u8054\u540e\u7aef (Backend)","text":"<p>\u6700\u540e\uff0c\u4e3a <code>komo</code> \u96c6\u7fa4\u6dfb\u52a0\u540e\u7aef\u7684\u670d\u52a1\u5730\u5740\u3002</p> <pre><code># 4. \u5173\u8054\u540e\u7aef\nsozu --config config.toml backend add --id komo --backend-id komodo-core-1 --address komodo-core-1:9120\n</code></pre> <p>\u8bf4\u660e: *   <code>backend add</code>: \u5b9a\u4e49\u4e00\u4e2a\u540e\u7aef\u6dfb\u52a0\u64cd\u4f5c\u3002 *   <code>--id komo</code>: \u6307\u5b9a\u8981\u6dfb\u52a0\u540e\u7aef\u7684\u76ee\u6807\u96c6\u7fa4\u3002 *   <code>--backend-id ... --address ...</code>: \u5b9a\u4e49\u540e\u7aef\u7684\u552f\u4e00 ID \u548c\u5730\u5740\u3002</p> <p>\u901a\u8fc7\u4ee5\u4e0a\u56db\u4e2a\u6b65\u9aa4\uff0c\u60a8\u5c31\u901a\u8fc7\u547d\u4ee4\u884c\u5b8c\u6574\u5730\u590d\u73b0\u4e86 <code>config.toml</code> \u6587\u4ef6\u4e2d\u7684\u914d\u7f6e\u3002</p>"},{"location":"configure/","title":"Configure S\u014dzu","text":"<p>Before a deep dive in the configuration part of the proxy, you should take a look at the getting started documentation if you haven't yet.</p>"},{"location":"configure/#configuration-file","title":"Configuration file","text":"<p>The configuration file uses the .toml format.</p> <p>S\u014dzu configuration process involves 3 major sources of parameters:</p> <ul> <li>The <code>global</code> section, which sets process-wide parameters.</li> <li>The definition of the protocols like <code>https</code>, <code>http</code>, <code>tcp</code>.</li> <li>The clusters sections under: <code>[clusters]</code>.</li> </ul>"},{"location":"configure/#global-parameters","title":"Global parameters","text":"<p>Parameters in the global section allow you to define the global settings shared by the main process and workers (like the log level):</p> parameter description possible values <code>saved_state</code> path from which sozu tries to load its state at startup <code>log_level</code> possible values are <code>debug</code>, <code>trace</code>, <code>error</code>, <code>warn</code>, <code>info</code> <code>log_target</code> possible values are <code>stdout, tcp or udp address</code> <code>access_logs_target</code> possible values are (if activated, sends access logs to a separate target) <code>stdout</code>, <code>tcp</code> or <code>udp address</code> <code>command_socket</code> path to the unix socket command <code>command_buffer_size</code> size, in bytes, of the buffer used by the main process to handle commands. <code>max_command_buffer_size</code> maximum size of the buffer used by the main process to handle commands. <code>worker_count</code> number of workers <code>worker_automatic_restart</code> if activated, workers that panicked or crashed are restarted (activated by default) <code>handle_process_affinity</code> bind workers to cpu cores. <code>max_connections</code> maximum number of simultaneous / opened connections <code>max_buffers</code> maximum number of buffers use to proxying <code>min_buffers</code> minimum number of buffers preallocated for proxying <code>buffer_size</code> size, in bytes, of requests buffer use by the workers <code>ctl_command_timeout</code> maximum time the command line will wait for a command to complete <code>pid_file_path</code> stores the pid in a specific file location <code>front_timeout</code> maximum time of inactivity for a front socket <code>connect_timeout</code> maximum time of inactivity for a request to connect <code>request_timeout</code> maximum time of inactivity for a request <code>zombie_check_interval</code> duration between checks for zombie sessions <code>activate_listeners</code> automatically start listeners <p>Example:</p> <pre><code>command_socket = \"./command_folder/sock\"\nsaved_state = \"./state.json\"\nlog_level = \"info\"\nlog_target = \"stdout\"\ncommand_buffer_size = 16384\nworker_count = 2\nhandle_process_affinity = false\nmax_connections = 500\nmax_buffers = 500\nbuffer_size = 16384\nactivate_listeners = true\n</code></pre>"},{"location":"configure/#listeners","title":"Listeners","text":"<p>The listener section describes a set of listening sockets accepting client connections. You can define as many listeners as you want. They follow the format:</p> <p>General parameters:</p> <pre><code>[[listeners]]\n# possible values are http, https or tcp\nprotocol = \"http\"\n# listening address\naddress = \"0.0.0.0:8080\"\n# address = \"[::]:8080\"\n\n# specify a different IP than the one the socket sees, for logs and forwarded headers\n# public_address = \"1.2.3.4:80\n\n# Configures the client socket to receive a PROXY protocol header\n# expect_proxy = false\n</code></pre>"},{"location":"configure/#options-specific-to-http-and-https-listeners","title":"Options specific to HTTP and HTTPS listeners","text":"<p>Since version 1.0.0, S\u014dzu allows custom HTTP answers defined for HTTP and HTTPS listeners.</p> <p>These answers are customizable:</p> <ul> <li>301 Moved Permanently</li> <li>400 Bad Request</li> <li>401 Unauthorized</li> <li>404 Not Found</li> <li>408 Request Timeout</li> <li>413 Payload Too Large</li> <li>502 Bad Gateway</li> <li>503 Service Unavailable</li> <li>504 Gateway Timeout</li> <li>507 Insufficient Storage</li> </ul> <p>These answers are to be provided in plain text files of whichever extension (we recommend <code>.http</code> for clarity) and may look like this:</p> <pre><code>HTTP/1.1 404 Not Found\nCache-Control: no-cache\nConnection: close\nSozu-Id: %REQUEST_ID\n\n&lt;style&gt;pre{background:#EEE;padding:10px;border:1px solid #AAA;border-radius: 5px;}&lt;/style&gt;\n&lt;h1&gt;404 Not Found&lt;/h1&gt;\n\n&lt;p&gt;insert your custom text here, in fact, all HTML is changeable, including the CSS.&lt;/p&gt;\n\n&lt;pre&gt;\n{\n    \\\"route\\\": \\\"%ROUTE\\\",\n    \\\"request_id\\\": \\\"%REQUEST_ID\\\",\n}\n&lt;/pre&gt;\n&lt;footer&gt;This is an automatic answer by Sozu.&lt;/footer&gt;\",\n</code></pre> <p>There are a number of available template variables, like <code>REQUEST_ID</code> or <code>CLUSTER_ID</code>, that will be replaced by the proxying logic when producing the error.</p> <p>To create your own custom HTTP answers, we highly suggest you first copy the default answers present in <code>lib/src/protocol/kawa_h1/answers.rs</code>, and then change them to your liking. Feel free to remove the <code>\\r</code> newlines of the default strings for clarity. S\u014dzu will parse your file and replace whatever newline symbol(s) you use.</p> <p>Then, for each listener, provide the absolute paths of each custom answer.</p> <pre><code># a 404 response is sent when sozu does not know about the requested domain or path\nanswer_404 = \"/path/to/my-404-answer.http\"\n# a 503 response is sent if there are no backend servers available\nanswer_503 = \"/path/to/my-503-answer.http\"\n# answer_507 = ...\n</code></pre> <p>If a frontend has a <code>sticky_session</code>, the sticky name is defined at the listener level.</p> <pre><code># defines the sticky session cookie's name, if `sticky_session` is activated format\n# a cluster. Defaults to \"SOZUBALANCEID\"\nsticky_name = \"SOZUBALANCEID\"\n</code></pre>"},{"location":"configure/#options-specific-to-https-listeners","title":"Options specific to HTTPS listeners","text":"<pre><code># supported TLS versions. Possible values are \"SSL_V2\", \"SSL_V3\",\n# \"TLS_V12\", \"TLS_V13\". Defaults to \"TLS_V12\" and \"TLS_V13\"\ntls_versions = [\"TLS_V12\", \"TLS_V13\"]\n</code></pre>"},{"location":"configure/#options-specific-to-rustls-based-https-listeners","title":"Options specific to Rustls based HTTPS listeners","text":"<pre><code># option specific to rustls based HTTPS listeners\ncipher_list = [\n    # TLS 1.3 cipher suites\n    \"TLS13_AES_256_GCM_SHA384\",\n    \"TLS13_AES_128_GCM_SHA256\",\n    \"TLS13_CHACHA20_POLY1305_SHA256\",\n    # TLS 1.2 cipher suites\n    \"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\n    \"TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\",\n    \"TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256\",\n    \"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\n    \"TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\",\n    \"TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256\",\n]\n</code></pre>"},{"location":"configure/#clusters","title":"Clusters","text":"<p>You can declare the list of your clusters under the <code>[clusters]</code> section. They follow the format:</p> <p>Mandatories parameters:</p> <pre><code>[clusters]\n\n[clusters.NameOfYourCluster]\n# possible values are http or tcp\n# https proxies will use http here\nprotocol = \"http\"\n\n# per cluster load balancing algorithm. The possible values are\n# \"roundrobin\" and \"random\". Defaults to \"roundrobin\"\n# load_balancing_policy=\"roundrobin\"\n\n# force cluster to redirect http traffic to https\n# https_redirect = true\n\nfrontends = [\n  { address = \"0.0.0.0:8080\", hostname = \"lolcatho.st\" },\n  { address = \"0.0.0.0:8443\", hostname = \"lolcatho.st\", certificate = \"../lib/assets/certificate.pem\", key = \"../lib/assets/key.pem\", certificate_chain = \"../lib/assets/certificate_chain.pem\" }\n]\n# additional options for frontends: sticky_session (boolean)\n\nbackends  = [\n  { address = \"127.0.0.1:1026\" }\n]\n</code></pre>"},{"location":"configure/#metrics","title":"Metrics","text":"<p>S\u014dzu reports its own state to another network component through a <code>UDP</code> socket. The main process and the workers are responsible to send their states. We implement the statsd protocol to send statistics. Any service that understands the <code>statsd</code> protocol can then gather metrics from S\u014dzu.</p>"},{"location":"configure/#configure-metrics","title":"Configure metrics","text":"<p>In your <code>config.toml</code>, you can define the address and port of your external service by adding:</p> <pre><code>[metrics]\naddress = \"127.0.0.1:8125\"\n# use InfluxDB's statsd protocol flavor to add tags\n# tagged_metrics = false\n# metrics key prefix\n# prefix = \"sozu\"\n</code></pre> <p>Currently, we can't change the frequency of sending messages.</p>"},{"location":"configure/#example-of-externals-services","title":"Example of externals services","text":"<ul> <li>statsd</li> <li>grad</li> </ul>"},{"location":"configure/#proxy-protocol","title":"PROXY Protocol","text":"<p>When a network stream goes through a proxy, the backend server will only see the IP address and port used by the proxy as client address. The real source IP address and port will only be seen by the proxy. Since this information is useful for logging, security, etc, the PROXY protocol was developed to transmit it to backend servers. With this protocol, after connecting to the backend server, the proxy will first send a small header indicating the client IP address and port, and the proxy's receiving IP address and port, and will then send the stream from the client.</p> <p>S\u014dzu support the version 2 of the <code>PROXY protocol</code> in three configurations:</p> <ul> <li>\"send\" protocol: S\u014dzu, in TCP proxy mode, will send the header to the backend server</li> <li>\"expect\" protocol: S\u014dzu receives the header from a proxy, interprets it for its own logging and metrics, and uses it in HTTP forwarding headers</li> <li>\"relay\" protocol: S\u014dzu, in TCP proxy mode, can receive the header, and transmit it to a backend server</li> </ul> <p>More information here: proxy-protocol spec</p>"},{"location":"configure/#configuring-sozu-to-expect-a-proxy-protocol-header","title":"Configuring S\u014dzu to expect a PROXY Protocol header","text":"<p>Configures the client-facing connection to receive a PROXY protocol header before any byte sent by the client is read from the socket.</p> <pre><code>                           send PROXY                    expect PROXY\n                           protocol header               protocol header\n    +--------+\n    | client |             +---------+                   +------------+      +-----------+\n    |        |             | proxy   |                   | Sozu       |      | upstream  |\n    +--------+  ---------&gt; | server  |  ---------------&gt; |            |------| server    |\n   /        /              |         |                   |            |      |           |\n  /________/               +---------+                   +------------+      +-----------+\n</code></pre> <p>It is supported by HTTP, HTTPS and TCP proxies.</p> <p>Configuration:</p> <pre><code>[[listeners]]\naddress = \"0.0.0.0:80\"\nexpect_proxy = true\n</code></pre>"},{"location":"configure/#configuring-sozu-to-send-a-proxy-protocol-header-to-an-upstream-backend","title":"Configuring S\u014dzu to send a PROXY Protocol header to an upstream backend","text":"<p>Send a PROXY protocol header over any connection established to the backends declared in the cluster.</p> <pre><code>                           send PROXY\n    +--------+             protocol header\n    | client |             +---------+                +-----------------+\n    |        |             | Sozu    |                | proxy/upstream  |\n    +--------+  ---------&gt; |         |  ------------&gt; | server          |\n   /        /              |         |                |                 |\n  /________/               +---------+                +-----------------+\n</code></pre> <p>Configuration:</p> <pre><code>[[listeners]]\naddress = \"0.0.0.0:81\"\n\n[clusters]\n[clusters.NameOfYourTcpCluster]\nsend_proxy = true\nfrontends = [\n  { address = \"0.0.0.0:81\" }\n]\n</code></pre> <p>NOTE: Only for TCP clusters (HTTP and HTTPS proxies will use the forwarding headers).</p>"},{"location":"configure/#configuring-sozu-to-relay-a-proxy-protocol-header-to-an-upstream","title":"Configuring S\u014dzu to relay a PROXY Protocol header to an upstream","text":"<p>S\u014dzu will receive a PROXY protocol header from the client connection, check its validity and then forward it to an upstream backend. This allows for chains of reverse-proxies without losing the client connection information.</p> <pre><code>                           send PROXY                       expect PROXY               send PROXY\n                           protocol header                  protocol header            protocol header\n    +--------+\n    | client |             +---------+                      +------------+             +-------------------+\n    |        |             | proxy   |                      | Sozu       |             | proxy/upstream    |\n    +--------+  +--------&gt; | server  |  +-----------------&gt; |            | +---------&gt; | server            |\n   /        /              |         |                      |            |             |                   |\n  /________/               +---------+                      +------------+             +-------------------+\n</code></pre> <p>Configuration:</p> <p>This only concerns TCP clusters (HTTP and HTTPS proxies can work directly in expect mode, and will use the forwarding headers).</p> <pre><code>[[listeners]]\naddress = \"0.0.0.0:80\"\nexpect_proxy = true\n\n[clusters]\n\n[clusters.NameOfYourCluster]\nsend_proxy = true\nfrontends = [\n  { address = \"0.0.0.0:80\" }\n]\n</code></pre>"},{"location":"configure_cli/","title":"Configuring sozu via command line","text":"<p>The sozu executable can be used to start the proxy, and configure it: adding new backend servers, reading metrics, etc. It talks to the currently running proxy through a unix socket.</p> <p>You can specify its path by adding to your <code>config.toml</code>:</p> <pre><code>command_socket = \"path/to/your/command_folder/sock\"\n</code></pre>"},{"location":"configure_cli/#add-a-cluster-with-an-http-and-https-frontends","title":"Add a cluster with an http and https frontends","text":"<p>First you need to create a new cluster with an id and a load balancing policy (roundrobin or random):</p> <pre><code>sozu --config /etc/sozu/config.toml cluster add --id &lt;my_cluster_id&gt; --load-balancing-policy roundrobin\n</code></pre> <p>It won't show anything but you can verify that the cluster has been added successfully by querying sozu:</p> <pre><code>sozu --config /etc/sozu/config.toml query clusters\n</code></pre> <p>Then you need to add a backend:</p> <pre><code>sozu --config /etc/sozu/config.toml backend add --address 127.0.0.1:3000 --backend-id &lt;my_backend_id&gt; --id &lt;my_cluster_id&gt;\n</code></pre>"},{"location":"configure_cli/#add-http-frontend","title":"Add http frontend","text":"<p>And an http listener:</p> <pre><code>sozu --config /etc/sozu/config.toml listener http add --address 0.0.0.0:80 --tls-versions TLSv1.2 --tls-cipher-list ECDHE-ECDSA-AES256-GCM-SHA384 --tls-cipher-suites TLS_AES_256_GCM_SHA384 --tls-signature-algorithms ECDSA+SHA512 --tls-groups-list x25519 --expect-proxy\n</code></pre> <p>Finally you have to create a frontend to allow sozu to send traffic from the listener to your backend:</p> <pre><code>sozu --config /etc/sozu/config.toml frontend http add --address 0.0.0.0:80 --hostname &lt;my_cluster_hostname&gt; id &lt;my_cluster_id&gt;\n</code></pre>"},{"location":"configure_cli/#add-https-frontend","title":"Add https frontend","text":"<p>And an https listener:</p> <pre><code>sozu --config /etc/sozu/config.toml listener https add --address 0.0.0.0:443\n</code></pre> <p>Finally you have to create a frontend to allow sozu to send traffic from the listener to your backend:</p> <pre><code>sozu --config /etc/sozu/config.toml frontend https add --address 0.0.0.0:443 --hostname &lt;my_cluster_hostname&gt; id &lt;my_cluster_id&gt;\n</code></pre>"},{"location":"configure_cli/#check-the-status-of-sozu","title":"Check the status of sozu","text":"<p>It shows a list of workers and show information about their statuses.</p> <pre><code>sozu --config /etc/sozu/config.toml status\n</code></pre>"},{"location":"configure_cli/#get-metrics-and-statistics","title":"Get metrics and statistics","text":"<p>It will show global statistics about sozu, workers and clusters metrics.</p> <pre><code>sozu --config /etc/sozu/config.toml query metrics\n</code></pre>"},{"location":"configure_cli/#dump-and-restore-state","title":"Dump and restore state","text":"<p>If sozu configurations (clusters, frontends &amp; backends) are not written in the config file, you can save sozu state to restore it later.</p> <pre><code>sozu --config /etc/sozu/config.toml state save --file state.json\n</code></pre> <p>Then shutdown gracefully sozu:</p> <pre><code>sozu --config /etc/sozu/config.toml shutdown\n</code></pre> <p>Restart sozu and restore its state:</p> <pre><code>sozu --config /etc/sozu/config.toml state load --file state.json\n</code></pre> <p>You should be able to request your cluster like before the shutdown.</p>"},{"location":"configure_cli/#monitor-status-of-backends-with-events","title":"Monitor status of backends with events","text":"<p>This CLI command:</p> <pre><code>sozu --config /path/to/config.toml events\n</code></pre> <p>listens to events sent by S\u014dzu workers whenever a backend is down, up again, or when no backend is available.</p>"},{"location":"configure_cli_zh/","title":"\u901a\u8fc7\u547d\u4ee4\u884c\u914d\u7f6e sozu","text":"<p>sozu \u53ef\u6267\u884c\u6587\u4ef6\u53ef\u7528\u4e8e\u542f\u52a8\u4ee3\u7406\u548c\u914d\u7f6e\u5b83\uff1a\u6dfb\u52a0\u65b0\u7684\u540e\u7aef\u670d\u52a1\u5668\u3001\u8bfb\u53d6\u6307\u6807\u7b49\u3002 \u5b83\u901a\u8fc7\u4e00\u4e2a unix \u5957\u63a5\u5b57\u4e0e\u5f53\u524d\u8fd0\u884c\u7684\u4ee3\u7406\u901a\u4fe1\u3002</p> <p>\u60a8\u53ef\u4ee5\u901a\u8fc7\u5728 <code>config.toml</code> \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\u6765\u6307\u5b9a\u5176\u8def\u5f84\uff1a</p> <pre><code>command_socket = \"path/to/your/command_folder/sock\"\n</code></pre>"},{"location":"configure_cli_zh/#http-https","title":"\u6dfb\u52a0\u4e00\u4e2a\u5e26\u6709 http \u548c https \u524d\u7aef\u7684\u96c6\u7fa4","text":"<p>\u9996\u5148\uff0c\u60a8\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5177\u6709 id \u548c\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\uff08roundrobin \u6216 random\uff09\u7684\u65b0\u96c6\u7fa4\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml cluster add --id &lt;my_cluster_id&gt; --load-balancing-policy roundrobin\n</code></pre> <p>\u5b83\u4e0d\u4f1a\u663e\u793a\u4efb\u4f55\u5185\u5bb9\uff0c\u4f46\u60a8\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2 sozu \u6765\u9a8c\u8bc1\u96c6\u7fa4\u662f\u5426\u5df2\u6210\u529f\u6dfb\u52a0\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml query clusters\n</code></pre> <p>\u7136\u540e\u60a8\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a\u540e\u7aef\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml backend add --address 127.0.0.1:3000 --backend-id &lt;my_backend_id&gt; --id &lt;my_cluster_id&gt;\n</code></pre>"},{"location":"configure_cli_zh/#http","title":"\u6dfb\u52a0 http \u524d\u7aef","text":"<p>\u548c\u4e00\u4e2a http \u76d1\u542c\u5668\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml listener http add --address 0.0.0.0:80 --tls-versions TLSv1.2 --tls-cipher-list ECDHE-ECDSA-AES256-GCM-SHA384 --tls-cipher-suites TLS_AES_256_GCM_SHA384 --tls-signature-algorithms ECDSA+SHA512 --tls-groups-list x25519 --expect-proxy\n</code></pre> <p>\u6700\u540e\uff0c\u60a8\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a\u524d\u7aef\u4ee5\u5141\u8bb8 sozu \u5c06\u6d41\u91cf\u4ece\u76d1\u542c\u5668\u53d1\u9001\u5230\u60a8\u7684\u540e\u7aef\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml frontend http add --address 0.0.0.0:80 --hostname &lt;my_cluster_hostname&gt; id &lt;my_cluster_id&gt;\n</code></pre>"},{"location":"configure_cli_zh/#https","title":"\u6dfb\u52a0 https \u524d\u7aef","text":"<p>\u548c\u4e00\u4e2a https \u76d1\u542c\u5668\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml listener https add --address 0.0.0.0:443\n</code></pre> <p>\u6700\u540e\uff0c\u60a8\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a\u524d\u7aef\u4ee5\u5141\u8bb8 sozu \u5c06\u6d41\u91cf\u4ece\u76d1\u542c\u5668\u53d1\u9001\u5230\u60a8\u7684\u540e\u7aef\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml frontend https add --address 0.0.0.0:443 --hostname &lt;my_cluster_hostname&gt; id &lt;my_cluster_id&gt;\n</code></pre>"},{"location":"configure_cli_zh/#sozu_1","title":"\u68c0\u67e5 sozu \u7684\u72b6\u6001","text":"<p>\u5b83\u663e\u793a\u4e00\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u5217\u8868\uff0c\u5e76\u663e\u793a\u6709\u5173\u5176\u72b6\u6001\u7684\u4fe1\u606f\u3002</p> <pre><code>sozu --config /etc/sozu/config.toml status\n</code></pre>"},{"location":"configure_cli_zh/#_1","title":"\u83b7\u53d6\u6307\u6807\u548c\u7edf\u8ba1\u4fe1\u606f","text":"<p>\u5b83\u5c06\u663e\u793a\u6709\u5173 sozu\u3001\u5de5\u4f5c\u8fdb\u7a0b\u548c\u96c6\u7fa4\u6307\u6807\u7684\u5168\u5c40\u7edf\u8ba1\u4fe1\u606f\u3002</p> <pre><code>sozu --config /etc/sozu/config.toml query metrics\n</code></pre>"},{"location":"configure_cli_zh/#_2","title":"\u8f6c\u50a8\u548c\u6062\u590d\u72b6\u6001","text":"<p>\u5982\u679c sozu \u914d\u7f6e\uff08\u96c6\u7fa4\u3001\u524d\u7aef\u548c\u540e\u7aef\uff09\u672a\u5199\u5165\u914d\u7f6e\u6587\u4ef6\uff0c\u60a8\u53ef\u4ee5\u4fdd\u5b58 sozu \u72b6\u6001\u4ee5\u4fbf\u7a0d\u540e\u6062\u590d\u3002</p> <pre><code>sozu --config /etc/sozu/config.toml state save --file state.json\n</code></pre> <p>\u7136\u540e\u6b63\u5e38\u5173\u95ed sozu\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml shutdown\n</code></pre> <p>\u91cd\u65b0\u542f\u52a8 sozu \u5e76\u6062\u590d\u5176\u72b6\u6001\uff1a</p> <pre><code>sozu --config /etc/sozu/config.toml state load --file state.json\n</code></pre> <p>\u60a8\u5e94\u8be5\u80fd\u591f\u50cf\u5173\u95ed\u524d\u4e00\u6837\u8bf7\u6c42\u60a8\u7684\u96c6\u7fa4\u3002</p>"},{"location":"configure_cli_zh/#_3","title":"\u4f7f\u7528\u4e8b\u4ef6\u76d1\u89c6\u540e\u7aef\u72b6\u6001","text":"<p>\u6b64 CLI \u547d\u4ee4\uff1a</p> <pre><code>sozu --config /path/to/config.toml events\n</code></pre> <p>\u76d1\u542c S\u014dzu \u5de5\u4f5c\u8fdb\u7a0b\u5728\u540e\u7aef\u5173\u95ed\u3001\u518d\u6b21\u542f\u52a8\u6216 \u6ca1\u6709\u53ef\u7528\u540e\u7aef\u65f6\u53d1\u9001\u7684\u4e8b\u4ef6\u3002</p>"},{"location":"configure_zh/","title":"\u914d\u7f6e S\u014dzu","text":"<p>\u5728\u6df1\u5165\u4e86\u89e3\u4ee3\u7406\u7684\u914d\u7f6e\u90e8\u5206\u4e4b\u524d\uff0c\u5982\u679c\u60a8\u8fd8\u6ca1\u6709\u9605\u8bfb\u8fc7 \u5165\u95e8\u6587\u6863\uff0c\u60a8\u5e94\u8be5\u5148\u770b\u4e00\u4e0b\u3002</p>"},{"location":"configure_zh/#_1","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>\u914d\u7f6e\u6587\u4ef6\u4f7f\u7528 .toml \u683c\u5f0f\u3002</p> <p>S\u014dzu \u914d\u7f6e\u8fc7\u7a0b\u6d89\u53ca 3 \u4e2a\u4e3b\u8981\u53c2\u6570\u6765\u6e90\uff1a</p> <ul> <li><code>global</code> \u90e8\u5206\uff0c\u7528\u4e8e\u8bbe\u7f6e\u8fdb\u7a0b\u8303\u56f4\u7684\u53c2\u6570\u3002</li> <li>\u534f\u8bae\u7684\u5b9a\u4e49\uff0c\u5982 <code>https</code>\u3001<code>http</code>\u3001<code>tcp</code>\u3002</li> <li><code>[clusters]</code> \u4e0b\u7684\u96c6\u7fa4\u90e8\u5206\u3002</li> </ul>"},{"location":"configure_zh/#_2","title":"\u5168\u5c40\u53c2\u6570","text":"<p>\u5168\u5c40\u90e8\u5206\u4e2d\u7684\u53c2\u6570\u5141\u8bb8\u60a8\u5b9a\u4e49\u4e3b\u8fdb\u7a0b\u548c\u5de5\u4f5c\u8fdb\u7a0b\u5171\u4eab\u7684\u5168\u5c40\u8bbe\u7f6e\uff08\u5982\u65e5\u5fd7\u7ea7\u522b\uff09\uff1a</p> \u53c2\u6570 \u63cf\u8ff0 \u53ef\u80fd\u7684\u503c <code>saved_state</code> sozu \u542f\u52a8\u65f6\u5c1d\u8bd5\u4ece\u4e2d\u52a0\u8f7d\u5176\u72b6\u6001\u7684\u8def\u5f84 <code>log_level</code> \u53ef\u80fd\u7684\u503c\u662f <code>debug</code>\u3001<code>trace</code>\u3001<code>error</code>\u3001<code>warn</code>\u3001<code>info</code> <code>log_target</code> \u53ef\u80fd\u7684\u503c\u662f <code>stdout, tcp \u6216 udp \u5730\u5740</code> <code>access_logs_target</code> \u53ef\u80fd\u7684\u503c\u662f\uff08\u5982\u679c\u6fc0\u6d3b\uff0c\u5219\u5c06\u8bbf\u95ee\u65e5\u5fd7\u53d1\u9001\u5230\u5355\u72ec\u7684\u76ee\u6807\uff09 <code>stdout</code>\u3001<code>tcp \u6216</code>udp \u5730\u5740` <code>command_socket</code> unix \u5957\u63a5\u5b57\u547d\u4ee4\u7684\u8def\u5f84 <code>command_buffer_size</code> \u4e3b\u8fdb\u7a0b\u7528\u4e8e\u5904\u7406\u547d\u4ee4\u7684\u7f13\u51b2\u533a\u5927\u5c0f\uff08\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\uff09\u3002 <code>max_command_buffer_size</code> \u4e3b\u8fdb\u7a0b\u7528\u4e8e\u5904\u7406\u547d\u4ee4\u7684\u7f13\u51b2\u533a\u7684\u6700\u5927\u5927\u5c0f\u3002 <code>worker_count</code> \u5de5\u4f5c\u8fdb\u7a0b\u6570 <code>worker_automatic_restart</code> \u5982\u679c\u6fc0\u6d3b\uff0c\u51fa\u73b0 panic \u6216\u5d29\u6e83\u7684\u5de5\u4f5c\u8fdb\u7a0b\u5c06\u91cd\u65b0\u542f\u52a8\uff08\u9ed8\u8ba4\u6fc0\u6d3b\uff09 <code>handle_process_affinity</code> \u5c06\u5de5\u4f5c\u8fdb\u7a0b\u7ed1\u5b9a\u5230 cpu \u6838\u5fc3\u3002 <code>max_connections</code> \u6700\u5927\u540c\u65f6/\u6253\u5f00\u8fde\u63a5\u6570 <code>max_buffers</code> \u7528\u4e8e\u4ee3\u7406\u7684\u6700\u5927\u7f13\u51b2\u533a\u6570 <code>min_buffers</code> \u4e3a\u4ee3\u7406\u9884\u5206\u914d\u7684\u6700\u5c0f\u7f13\u51b2\u533a\u6570 <code>buffer_size</code> \u5de5\u4f5c\u8fdb\u7a0b\u4f7f\u7528\u7684\u8bf7\u6c42\u7f13\u51b2\u533a\u5927\u5c0f\uff08\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\uff09 <code>ctl_command_timeout</code> \u547d\u4ee4\u884c\u7b49\u5f85\u547d\u4ee4\u5b8c\u6210\u7684\u6700\u957f\u65f6\u95f4 <code>pid_file_path</code> \u5c06 pid \u5b58\u50a8\u5728\u7279\u5b9a\u6587\u4ef6\u4f4d\u7f6e <code>front_timeout</code> \u524d\u7aef\u5957\u63a5\u5b57\u7684\u6700\u5927\u4e0d\u6d3b\u52a8\u65f6\u95f4 <code>connect_timeout</code> \u8fde\u63a5\u8bf7\u6c42\u7684\u6700\u5927\u4e0d\u6d3b\u52a8\u65f6\u95f4 <code>request_timeout</code> \u8bf7\u6c42\u7684\u6700\u5927\u4e0d\u6d3b\u52a8\u65f6\u95f4 <code>zombie_check_interval</code> \u50f5\u5c38\u4f1a\u8bdd\u68c0\u67e5\u4e4b\u95f4\u7684\u6301\u7eed\u65f6\u95f4 <code>activate_listeners</code> \u81ea\u52a8\u542f\u52a8\u76d1\u542c\u5668 <p>\u793a\u4f8b\uff1a</p> <pre><code>command_socket = \"./command_folder/sock\"\nsaved_state = \"./state.json\"\nlog_level = \"info\"\nlog_target = \"stdout\"\ncommand_buffer_size = 16384\nworker_count = 2\nhandle_process_affinity = false\nmax_connections = 500\nmax_buffers = 500\nbuffer_size = 16384\nactivate_listeners = true\n</code></pre>"},{"location":"configure_zh/#_3","title":"\u76d1\u542c\u5668","text":"<p>listener \u90e8\u5206\u63cf\u8ff0\u4e86\u4e00\u7ec4\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u76d1\u542c\u5957\u63a5\u5b57\u3002 \u60a8\u53ef\u4ee5\u5b9a\u4e49\u4efb\u610f\u6570\u91cf\u7684\u76d1\u542c\u5668\u3002 \u5b83\u4eec\u9075\u5faa\u4ee5\u4e0b\u683c\u5f0f\uff1a</p> <p>\u901a\u7528\u53c2\u6570\uff1a</p> <pre><code>[[listeners]]\n# \u53ef\u80fd\u7684\u503c\u662f http\u3001https \u6216 tcp\nprotocol = \"http\"\n# \u76d1\u542c\u5730\u5740\naddress = \"0.0.0.0:8080\"\n# address = \"[::]:8080\"\n\n# \u4e3a\u65e5\u5fd7\u548c\u8f6c\u53d1\u7684\u6807\u5934\u6307\u5b9a\u4e00\u4e2a\u4e0d\u540c\u4e8e\u5957\u63a5\u5b57\u6240\u89c1\u7684 IP\n# public_address = \"1.2.3.4:80\n\n# \u914d\u7f6e\u5ba2\u6237\u7aef\u5957\u63a5\u5b57\u4ee5\u63a5\u6536 PROXY \u534f\u8bae\u5934\n# expect_proxy = false\n</code></pre>"},{"location":"configure_zh/#http-https","title":"HTTP \u548c HTTPS \u76d1\u542c\u5668\u7279\u6709\u9009\u9879","text":"<p>\u81ea 1.0.0 \u7248\u672c\u4ee5\u6765\uff0cS\u014dzu \u5141\u8bb8\u4e3a HTTP \u548c HTTPS \u76d1\u542c\u5668\u5b9a\u4e49\u81ea\u5b9a\u4e49 HTTP \u5e94\u7b54\u3002</p> <p>\u8fd9\u4e9b\u5e94\u7b54\u662f\u53ef\u5b9a\u5236\u7684\uff1a</p> <ul> <li>301 Moved Permanently</li> <li>400 Bad Request</li> <li>401 Unauthorized</li> <li>404 Not Found</li> <li>408 Request Timeout</li> <li>413 Payload Too Large</li> <li>502 Bad Gateway</li> <li>503 Service Unavailable</li> <li>504 Gateway Timeout</li> <li>507 Insufficient Storage</li> </ul> <p>\u8fd9\u4e9b\u5e94\u7b54\u5e94\u4ee5\u4efb\u4f55\u6269\u5c55\u540d\u7684\u7eaf\u6587\u672c\u6587\u4ef6\u63d0\u4f9b\uff08\u4e3a\u6e05\u6670\u8d77\u89c1\uff0c\u6211\u4eec\u5efa\u8bae\u4f7f\u7528 <code>.http</code> \uff09\uff0c\u5e76\u4e14\u53ef\u80fd\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>HTTP/1.1 404 Not Found\nCache-Control: no-cache\nConnection: close\nSozu-Id: %REQUEST_ID\n\n&lt;style&gt;pre{background:#EEE;padding:10px;border:1px solid #AAA;border-radius: 5px;}&lt;/style&gt;\n&lt;h1&gt;404 Not Found&lt;/h1&gt;\n\n&lt;p&gt;\u5728\u6b64\u5904\u63d2\u5165\u60a8\u7684\u81ea\u5b9a\u4e49\u6587\u672c\uff0c\u5b9e\u9645\u4e0a\uff0c\u6240\u6709 HTML \u90fd\u662f\u53ef\u66f4\u6539\u7684\uff0c\u5305\u62ec CSS\u3002&lt;/p&gt;\n\n&lt;pre&gt;\n{\n    \"route\": \"%ROUTE\",\n    \"request_id\": \"%REQUEST_ID\",\n}\n&lt;/pre&gt;\n&lt;footer&gt;\u8fd9\u662f Sozu \u7684\u81ea\u52a8\u5e94\u7b54\u3002&lt;/footer&gt;\",\n</code></pre> <p>\u6709\u8bb8\u591a\u53ef\u7528\u7684\u6a21\u677f\u53d8\u91cf\uff0c\u5982 <code>REQUEST_ID</code> \u6216 <code>CLUSTER_ID</code>\uff0c \u5728\u751f\u6210\u9519\u8bef\u65f6\uff0c\u4ee3\u7406\u903b\u8f91\u5c06\u66ff\u6362\u5b83\u4eec\u3002</p> <p>\u8981\u521b\u5efa\u60a8\u81ea\u5df1\u7684\u81ea\u5b9a\u4e49 HTTP \u5e94\u7b54\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u60a8\u9996\u5148\u590d\u5236 <code>lib/src/protocol/kawa_h1/answers.rs</code> \u4e2d\u5b58\u5728\u7684\u9ed8\u8ba4\u5e94\u7b54\uff0c\u7136\u540e\u6839\u636e\u81ea\u5df1\u7684\u559c\u597d\u8fdb\u884c\u66f4\u6539\u3002\u4e3a\u6e05\u6670\u8d77\u89c1\uff0c\u53ef\u4ee5\u968f\u610f\u5220\u9664 \u9ed8\u8ba4\u5b57\u7b26\u4e32\u4e2d\u7684 <code>\\r</code> \u6362\u884c\u7b26\u3002 S\u014dzu \u5c06\u89e3\u6790\u60a8\u7684\u6587\u4ef6\u5e76\u66ff\u6362\u60a8\u4f7f\u7528\u7684\u4efb\u4f55\u6362\u884c\u7b26\u3002</p> <p>\u7136\u540e\uff0c\u4e3a\u6bcf\u4e2a\u76d1\u542c\u5668\u63d0\u4f9b\u6bcf\u4e2a\u81ea\u5b9a\u4e49\u5e94\u7b54\u7684\u7edd\u5bf9\u8def\u5f84\u3002</p> <pre><code># \u5f53 sozu \u4e0d\u77e5\u9053\u8bf7\u6c42\u7684\u57df\u6216\u8def\u5f84\u65f6\uff0c\u5c06\u53d1\u9001 404 \u54cd\u5e94\nanswer_404 = \"/path/to/my-404-answer.http\"\n# \u5982\u679c\u6ca1\u6709\u53ef\u7528\u7684\u540e\u7aef\u670d\u52a1\u5668\uff0c\u5c06\u53d1\u9001 503 \u54cd\u5e94\nanswer_503 = \"/path/to/my-503-answer.http\"\n# answer_507 = ...\n</code></pre> <p>\u5982\u679c\u524d\u7aef\u5177\u6709 <code>sticky_session</code>\uff0c\u5219\u7c98\u6027\u540d\u79f0\u5728\u76d1\u542c\u5668\u7ea7\u522b\u5b9a\u4e49\u3002</p> <pre><code># \u5982\u679c\u96c6\u7fa4\u6fc0\u6d3b\u4e86 `sticky_session`\uff0c\u5219\u5b9a\u4e49\u7c98\u6027\u4f1a\u8bdd cookie \u7684\u540d\u79f0\n# \u9ed8\u8ba4\u4e3a \"SOZUBALANCEID\"\nsticky_name = \"SOZUBALANCEID\"\n</code></pre>"},{"location":"configure_zh/#https","title":"HTTPS \u76d1\u542c\u5668\u7279\u6709\u9009\u9879","text":"<pre><code># \u652f\u6301\u7684 TLS \u7248\u672c\u3002\u53ef\u80fd\u7684\u503c\u662f \"SSL_V2\"\u3001\"SSL_V3\"\u3001\n# \"TLS_V12\"\u3001\"TLS_V13\"\u3002\u9ed8\u8ba4\u4e3a \"TLS_V12\" \u548c \"TLS_V13\"\ntls_versions = [\"TLS_V12\", \"TLS_V13\"]\n</code></pre>"},{"location":"configure_zh/#rustls-https","title":"\u57fa\u4e8e Rustls \u7684 HTTPS \u76d1\u542c\u5668\u7279\u6709\u9009\u9879","text":"<pre><code># \u57fa\u4e8e rustls \u7684 HTTPS \u76d1\u542c\u5668\u7279\u6709\u9009\u9879\ncipher_list = [\n    # TLS 1.3 \u5bc6\u7801\u5957\u4ef6\n    \"TLS13_AES_256_GCM_SHA384\",\n    \"TLS13_AES_128_GCM_SHA256\",\n    \"TLS13_CHACHA20_POLY1305_SHA256\",\n    # TLS 1.2 \u5bc6\u7801\u5957\u4ef6\n    \"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\n    \"TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\",\n    \"TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256\",\n    \"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\n    \"TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\",\n    \"TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256\",\n]\n</code></pre>"},{"location":"configure_zh/#_4","title":"\u96c6\u7fa4","text":"<p>\u60a8\u53ef\u4ee5\u5728 <code>[clusters]</code> \u90e8\u5206\u4e0b\u58f0\u660e\u60a8\u7684 \u96c6\u7fa4 \u5217\u8868\u3002 \u5b83\u4eec\u9075\u5faa\u4ee5\u4e0b\u683c\u5f0f\uff1a</p> <p>\u5f3a\u5236\u53c2\u6570\uff1a</p> <pre><code>[clusters]\n\n[clusters.NameOfYourCluster]\n# \u53ef\u80fd\u7684\u503c\u662f http \u6216 tcp\n# https \u4ee3\u7406\u5c06\u5728\u6b64\u5904\u4f7f\u7528 http\nprotocol = \"http\"\n\n# \u6bcf\u4e2a\u96c6\u7fa4\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u3002\u53ef\u80fd\u7684\u503c\u662f\n# \"roundrobin\" \u548c \"random\"\u3002\u9ed8\u8ba4\u4e3a \"roundrobin\"\n# load_balancing_policy=\"roundrobin\"\n\n# \u5f3a\u5236\u96c6\u7fa4\u5c06 http \u6d41\u91cf\u91cd\u5b9a\u5411\u5230 https\n# https_redirect = true\n\nfrontends = [\n  { address = \"0.0.0.0:8080\", hostname = \"lolcatho.st\" },\n  { address = \"0.0.0.0:8443\", hostname = \"lolcatho.st\", certificate = \"../lib/assets/certificate.pem\", key = \"../lib/assets/key.pem\", certificate_chain = \"../lib/assets/certificate_chain.pem\" }\n]\n# frontends \u7684\u9644\u52a0\u9009\u9879\uff1asticky_session (\u5e03\u5c14\u503c)\n\nbackends  = [\n  { address = \"127.0.0.1:1026\" }\n]\n</code></pre>"},{"location":"configure_zh/#_5","title":"\u6307\u6807","text":"<p>S\u014dzu \u901a\u8fc7 <code>UDP</code> \u5957\u63a5\u5b57\u5c06\u5176\u81ea\u8eab\u72b6\u6001\u62a5\u544a\u7ed9\u53e6\u4e00\u4e2a\u7f51\u7edc\u7ec4\u4ef6\u3002 \u4e3b\u8fdb\u7a0b\u548c\u5de5\u4f5c\u8fdb\u7a0b\u8d1f\u8d23\u53d1\u9001\u5176\u72b6\u6001\u3002 \u6211\u4eec\u5b9e\u73b0 statsd \u534f\u8bae\u6765\u53d1\u9001\u7edf\u8ba1\u4fe1\u606f\u3002 \u4efb\u4f55\u7406\u89e3 <code>statsd</code> \u534f\u8bae\u7684\u670d\u52a1\u90fd\u53ef\u4ee5\u4ece S\u014dzu \u6536\u96c6\u6307\u6807\u3002</p>"},{"location":"configure_zh/#_6","title":"\u914d\u7f6e\u6307\u6807","text":"<p>\u5728\u60a8\u7684 <code>config.toml</code> \u4e2d\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9\u6765\u5b9a\u4e49\u5916\u90e8\u670d\u52a1\u7684\u5730\u5740\u548c\u7aef\u53e3\uff1a</p> <pre><code>[metrics]\naddress = \"127.0.0.1:8125\"\n# \u4f7f\u7528 InfluxDB \u7684 statsd \u534f\u8bae\u98ce\u683c\u6dfb\u52a0\u6807\u7b7e\n# tagged_metrics = false\n# \u6307\u6807\u952e\u524d\u7f00\n# prefix = \"sozu\"\n</code></pre> <p>\u76ee\u524d\uff0c\u6211\u4eec\u65e0\u6cd5\u66f4\u6539\u53d1\u9001\u6d88\u606f\u7684\u9891\u7387\u3002</p>"},{"location":"configure_zh/#_7","title":"\u5916\u90e8\u670d\u52a1\u793a\u4f8b","text":"<ul> <li>statsd</li> <li>grad</li> </ul>"},{"location":"configure_zh/#proxy","title":"PROXY \u534f\u8bae","text":"<p>\u5f53\u7f51\u7edc\u6d41\u901a\u8fc7\u4ee3\u7406\u65f6\uff0c\u540e\u7aef\u670d\u52a1\u5668\u5c06\u4ec5\u770b\u5230\u4ee3\u7406\u7528\u4f5c\u5ba2\u6237\u7aef\u5730\u5740\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u3002 \u771f\u5b9e\u7684\u6e90 IP \u5730\u5740\u548c\u7aef\u53e3\u5c06\u4ec5\u7531\u4ee3\u7406\u770b\u5230\u3002 \u7531\u4e8e\u6b64\u4fe1\u606f\u5bf9\u4e8e\u65e5\u5fd7\u8bb0\u5f55\u3001\u5b89\u5168\u7b49\u5f88\u6709\u7528\uff0c \u56e0\u6b64\u5f00\u53d1\u4e86 PROXY \u534f\u8bae \u4ee5\u5c06\u5176\u4f20\u8f93\u5230\u540e\u7aef\u670d\u52a1\u5668\u3002 \u4f7f\u7528\u6b64\u534f\u8bae\uff0c\u5728\u8fde\u63a5\u5230\u540e\u7aef\u670d\u52a1\u5668\u540e\uff0c\u4ee3\u7406\u5c06\u9996\u5148\u53d1\u9001\u4e00\u4e2a\u6307\u793a\u5ba2\u6237\u7aef IP \u5730\u5740\u548c\u7aef\u53e3 \u4ee5\u53ca\u4ee3\u7406\u7684\u63a5\u6536 IP \u5730\u5740\u548c\u7aef\u53e3\u7684\u5c0f\u6807\u5934\uff0c\u7136\u540e\u5c06\u53d1\u9001\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u6d41\u3002</p> <p>S\u014dzu \u652f\u6301 <code>PROXY \u534f\u8bae</code> \u7684 \u7248\u672c 2\uff0c\u6709\u4e09\u79cd\u914d\u7f6e\uff1a</p> <ul> <li>\u201c\u53d1\u9001\u201d\u534f\u8bae\uff1aS\u014dzu \u5728 TCP \u4ee3\u7406\u6a21\u5f0f\u4e0b\uff0c\u5c06\u5411\u540e\u7aef\u670d\u52a1\u5668\u53d1\u9001\u6807\u5934</li> <li>\u201c\u671f\u671b\u201d\u534f\u8bae\uff1aS\u014dzu \u4ece\u4ee3\u7406\u63a5\u6536\u6807\u5934\uff0c\u4e3a\u5176\u81ea\u5df1\u7684\u65e5\u5fd7\u8bb0\u5f55\u548c\u6307\u6807\u89e3\u91ca\u5b83\uff0c\u5e76\u5728 HTTP \u8f6c\u53d1\u6807\u5934\u4e2d\u4f7f\u7528\u5b83</li> <li>\u201c\u4e2d\u7ee7\u201d\u534f\u8bae\uff1aS\u014dzu \u5728 TCP \u4ee3\u7406\u6a21\u5f0f\u4e0b\uff0c\u53ef\u4ee5\u63a5\u6536\u6807\u5934\uff0c\u5e76\u5c06\u5176\u4f20\u8f93\u5230\u540e\u7aef\u670d\u52a1\u5668</li> </ul> <p>\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u89c1\uff1aproxy-protocol spec</p>"},{"location":"configure_zh/#sozu-proxy","title":"\u914d\u7f6e S\u014dzu \u671f\u671b PROXY \u534f\u8bae\u5934","text":"<p>\u914d\u7f6e\u9762\u5411\u5ba2\u6237\u7aef\u7684\u8fde\u63a5\u4ee5\u5728\u4ece\u5957\u63a5\u5b57\u8bfb\u53d6\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u4efb\u4f55\u5b57\u8282\u4e4b\u524d\u63a5\u6536 PROXY \u534f\u8bae\u5934\u3002</p> <pre><code>                           \u53d1\u9001 PROXY                   \u671f\u671b PROXY\n                           \u534f\u8bae\u5934                       \u534f\u8bae\u5934\n    +--------+\n    | \u5ba2\u6237\u7aef |             +---------+                   +------------+      +-----------+\n    |        |             | \u4ee3\u7406    |                   | Sozu       |      | \u4e0a\u6e38      |\n    +--------+  ---------&gt; | \u670d\u52a1\u5668  |  ---------------&gt; |            |------| \u670d\u52a1\u5668    |\n   /        /              |         |                   |            |      |           |\n  /________/               +---------+                   +------------+      +-----------+\n</code></pre> <p>\u5b83\u53d7 HTTP\u3001HTTPS \u548c TCP \u4ee3\u7406\u652f\u6301\u3002</p> <p>\u914d\u7f6e\uff1a</p> <pre><code>[[listeners]]\naddress = \"0.0.0.0:80\"\nexpect_proxy = true\n</code></pre>"},{"location":"configure_zh/#sozu-proxy_1","title":"\u914d\u7f6e S\u014dzu \u5411 \u4e0a\u6e38\u540e\u7aef \u53d1\u9001 PROXY \u534f\u8bae\u5934","text":"<p>\u5728\u4e0e\u96c6\u7fa4\u4e2d\u58f0\u660e\u7684\u540e\u7aef\u5efa\u7acb\u7684\u4efb\u4f55\u8fde\u63a5\u4e0a\u53d1\u9001 PROXY \u534f\u8bae\u5934\u3002</p> <pre><code>                           \u53d1\u9001 PROXY\n    +--------+             \u534f\u8bae\u5934\n    | \u5ba2\u6237\u7aef |             +---------+\n    |        |             | Sozu    |\n    +--------+  ---------&gt; |         |  ------------&gt; +-------------------+ \n   /        /              |         |                | \u4ee3\u7406/\u4e0a\u6e38       |\n  /________/               +---------+                | \u670d\u52a1\u5668          |\n                                                      |                 |\n                                                      +-----------------+\n</code></pre> <p>\u914d\u7f6e\uff1a</p> <pre><code>[[listeners]]\naddress = \"0.0.0.0:81\"\n\n[clusters]\n[clusters.NameOfYourTcpCluster]\nsend_proxy = true\nfrontends = [\n  { address = \"0.0.0.0:81\" }\n]\n</code></pre> <p>\u6ce8\u610f\uff1a\u4ec5\u9002\u7528\u4e8e TCP \u96c6\u7fa4\uff08HTTP \u548c HTTPS \u4ee3\u7406\u5c06\u4f7f\u7528\u8f6c\u53d1\u6807\u5934\uff09\u3002</p>"},{"location":"configure_zh/#sozu-proxy_2","title":"\u914d\u7f6e S\u014dzu \u5411 \u4e0a\u6e38 \u4e2d\u7ee7 PROXY \u534f\u8bae\u5934","text":"<p>S\u014dzu \u5c06\u4ece\u5ba2\u6237\u7aef\u8fde\u63a5\u63a5\u6536 PROXY \u534f\u8bae\u5934\uff0c\u68c0\u67e5\u5176\u6709\u6548\u6027\uff0c\u7136\u540e\u5c06\u5176\u8f6c\u53d1\u5230\u4e0a\u6e38\u540e\u7aef\u3002\u8fd9\u5141\u8bb8\u53cd\u5411\u4ee3\u7406\u94fe\u5728\u4e0d\u4e22\u5931\u5ba2\u6237\u7aef\u8fde\u63a5\u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\u5de5\u4f5c\u3002</p> <pre><code>                           \u53d1\u9001 PROXY                       \u671f\u671b PROXY               \u53d1\u9001 PROXY\n                           \u534f\u8bae\u5934                           \u534f\u8bae\u5934                   \u534f\u8bae\u5934\n    +--------+\n    | \u5ba2\u6237\u7aef |             +---------+                      +------------+             +-------------------+\n    |        |             | \u4ee3\u7406    |                      | Sozu       |             | \u4ee3\u7406/\u4e0a\u6e38         |\n    +--------+  +--------&gt; | \u670d\u52a1\u5668  |  +-----------------&gt; |            | +---------&gt; | \u670d\u52a1\u5668            |\n   /        /              |         |                      |            |             |                   |\n  /________/               +---------+                      +------------+             +-------------------+ \n</code></pre> <p>\u914d\u7f6e\uff1a</p> <p>\u8fd9\u4ec5\u6d89\u53ca TCP \u96c6\u7fa4\uff08HTTP \u548c HTTPS \u4ee3\u7406\u53ef\u4ee5\u76f4\u63a5\u5728\u671f\u671b\u6a21\u5f0f\u4e0b\u5de5\u4f5c\uff0c\u5e76\u5c06\u4f7f\u7528\u8f6c\u53d1\u6807\u5934\uff09\u3002</p> <pre><code>[[listeners]]\naddress = \"0.0.0.0:80\"\nexpect_proxy = true\n\n[clusters]\n\n[clusters.NameOfYourCluster]\nsend_proxy = true\nfrontends = [\n  { address = \"0.0.0.0:80\" }\n]\n</code></pre>"},{"location":"debugging_strategies/","title":"How to debug sozu","text":"<p>Sozu provides logs and metrics allowing detection of most production issues.</p>"},{"location":"debugging_strategies/#gathering-information","title":"Gathering information","text":""},{"location":"debugging_strategies/#dumping-the-state-through-sozu-command-line","title":"Dumping the state through sozu command line","text":"<p>It is useful to gather information on the configuration state in a production system. Here are some commands you can use to take a snapshot of the current state:</p> <pre><code>sozu -c /etc/config.toml status\"\nsozu -c /etc/config.toml metrics get\"\nsozu -c /etc/config.toml clusters list\"\nsozu -c /etc/config.toml state save -f \"sozu-state-$(date -Iseconds).txt\"\n</code></pre>"},{"location":"debugging_strategies/#logging","title":"Logging","text":"<p>There are three configuration options related to logging:</p> <ul> <li><code>log_level</code>: sets logging verbosity</li> <li><code>log_target</code>: where logs are sent. It can have the following formats:</li> <li><code>stdout</code></li> <li><code>udp://127.0.0.1:9876</code></li> <li><code>tcp://127.0.0.1:9876</code></li> <li><code>unix:///var/sozu/logs</code></li> <li><code>file:///var/logs/sozu.log</code></li> <li><code>access_logs_target</code>: if activated, sends the access logs to a separate destination</li> </ul> <p><code>log_level</code> follows env_logger's level directives. Moreover, the <code>RUST_LOG</code> environment variable can be used to override the log level.</p> <p>If sozu is built in release mode, the <code>DEBUG</code> and <code>TRACE</code> log levels are not compiled in, unless you set the compilation features <code>logs-debug</code> and <code>logs-trace</code>.</p>"},{"location":"debugging_strategies/#metrics","title":"Metrics","text":"<p>Various metrics are generated while sozu is running. They can be accessed in two ways:</p> <ul> <li>through <code>sozu metrics get</code>, which will display metrics for the main process and workers. Counters are refreshed between each call</li> <li>by UDP, following the statsd protocol (optionally with support for InfluxDB's tags)</li> </ul> <p>Here is how you can set up metrics with statsd in the configuration file:</p> <pre><code>[metrics]\naddress = \"127.0.0.1:8125\"\n# use InfluxDB's statsd protocol flavor to add tags (default: false)\ntagged_metrics = true\n# metrics key prefix (default: sozu)\n# prefix = \"sozu\"\n</code></pre>"},{"location":"debugging_strategies/#graphs-and-metrics-to-follow","title":"Graphs and metrics to follow","text":"<p>(assuming we set <code>sozu</code> as metric prefix)</p>"},{"location":"debugging_strategies/#tracking-valid-traffic","title":"Tracking valid traffic","text":""},{"location":"debugging_strategies/#access-logs","title":"Access logs","text":"<p>Access logs have the following format:</p> <pre><code>2018-09-21T14:01:51Z 821136800672570 71013 WRK-00 INFO  450b071a-53b8-4fd7-b2f2-1213f03ef032 MyCluster      127.0.0.1:52323 -&gt; 127.0.0.1:1027       241ms 855\u03bcs 560 33084   200 OK lolcatho.st:8080 GET /\n</code></pre> <p>From left to right:</p> <ul> <li>date in ISO8601 format, UTC timezone</li> <li>monotonic clock (in case some messages appear in the wrong order)</li> <li>PID</li> <li>worker name (\"MAIN\" for the main process)</li> <li>log level</li> <li>request id (UUID, generated randomly for each request, changes on the same connection if doing multiple requests in keep-alive)</li> <li>cluster id</li> <li>client's source IP and port</li> <li>backend server's destination IP and port</li> <li>response time (from first byte received from the client, to last byte sent to the client)</li> <li>service time (time spent by sozu handling the session)</li> <li>uploaded bytes</li> <li>downloaded bytes</li> </ul>"},{"location":"debugging_strategies/#http-status-metrics","title":"HTTP status metrics","text":"<p>The following metrics track requests that are correctly sent to the backend servers:</p> <ul> <li><code>sozu.http.status.1xx</code>: counts requests with 100 to 199 status</li> <li><code>sozu.http.status.2xx</code>: counts requests with 200 to 299 status</li> <li><code>sozu.http.status.3xx</code>: counts requests with 300 to 399 status</li> <li><code>sozu.http.status.4xx</code>: counts requests with 400 to 499 status</li> <li><code>sozu.http.status.5xx</code>: counts requests with 500 to 599 status</li> <li><code>sozu.http.requests</code>: incremented at each request (sum of above counters)</li> </ul>"},{"location":"debugging_strategies/#data-transmitted","title":"data transmitted","text":"<p>There are global <code>sozu.bytes_in</code> and <code>sozu.bytes_out</code> metrics counting the front traffic for sozu. These metrics can also have a backend ID and cluster ID. They would then indicate bytes in and out from the point of view of the backend server.</p>"},{"location":"debugging_strategies/#response-time","title":"Response time","text":"<p>?</p>"},{"location":"debugging_strategies/#protocols","title":"Protocols","text":"<p>Client sessions can be at various state of their network protocols. As an example, a connection could go from \"Expect proxy protocol\" (assuming there's a TCP proxy in front) to TLS handshake, to HTTPS, to WSS (websockets over TLS).</p> <p>You can track the following gauges indicating the current protocol usage:</p> <ul> <li><code>sozu.protocol.proxy.expect</code></li> <li><code>sozu.protocol.proxy.send</code></li> <li><code>sozu.protocol.proxy.relay</code></li> <li><code>sozu.protocol.tcp</code></li> <li><code>sozu.protocol.tls.handshake</code></li> <li><code>sozu.protocol.http</code></li> <li><code>sozu.protocol.https</code></li> <li><code>sozu.protocol.ws</code></li> <li><code>sozu.protocol.wss</code></li> </ul>"},{"location":"debugging_strategies/#tracking-failed-requests","title":"Tracking failed requests","text":"<p>Sozu has a way of answering to invalid traffic with minimal resource usage, sending predefined answers. It does that for invalid traffic (not standard compliant) and routing issues (unknown host and/or path, unresponsive backend server).</p> <p>The <code>sozu.http.errors</code> counter is the sum of failed requests. It contains the following:</p> <ul> <li><code>sozu.http.frontend_parse_errors</code>: sozu received some invalid traffic</li> <li><code>sozu.http.400.errors</code>: cannot parse hostname</li> <li><code>sozu.http.404.errors</code>: unknown hostname and/or path</li> <li><code>sozu.http.413.errors</code>: request too large</li> <li><code>sozu.http.503.errors</code>: could not connect to backend server, or no backend server available for the corresponding cluster</li> </ul> <p>Going further, backend connections issues are tracked by the following metrics:</p> <ul> <li><code>sozu.backend.connections.error</code>: could not connect to a backend server</li> <li><code>sozu.backend.down</code>: the retry policy triggered and marked the backend server as down</li> </ul> <p>The <code>sozu.http.503.errors</code> metric is incremented after a request sent back a 503 error, and a 503 error is sent after the circuit breaker triggered (we wait for 3 failed connections to the backend server).</p> <p>A backend connection error would result in the following log message:</p> <pre><code>2018-09-21T14:36:08Z 823194694977734 71501 WRK-00 ERROR 839f592b-a194-4c3b-848b-8ef024129969    MyCluster    error connecting to backend, trying again\n</code></pre> <p>The circuit breaker triggering will write this to the logs:</p> <pre><code>2018-09-21T14:36:57Z 823243245414405 71524 WRK-00 ERROR 7029d66e-57a8-406e-ae61-e4bf9ff7b6b8    MyCluster    max connection attempt reached\n</code></pre> <p>The retry policy marking a backend server as down will write the following log message:</p> <pre><code>2018-09-21T14:37:31Z 823277868708804 71524 WRK-00 ERROR no more available backends for cluster MyCluster\n</code></pre>"},{"location":"debugging_strategies/#scalability","title":"Scalability","text":"<p>Sozu handles its resource usage finely, and puts hard limits on the number of requests or memory usage.</p> <p>To track connections, follow these gauges:</p> <ul> <li><code>sozu.client.connections</code> for frontend connections</li> <li><code>sozu.backend.connections</code> for backend connections</li> <li><code>sozu.http.active_requests</code> for currently active connections (a keep alive connection that's waiting for the next request is marked as not active)</li> </ul> <p>Client connections should always be higher than backend connections, and backend connections should be higher than active requests (an inactive session can keep a backend connection around).</p> <p>These metrics are closely linked to resource usage, which is tracked by the following:</p> <ul> <li><code>sozu.slab.entries</code>: number of slots used in the slab allocator. Typically, there's one slot per listener socket, one for the connection to the main process, one for the metrics socket, then one per frontend connection and one per backend connection. So the number of connections should always be close to (but lower than) the slab count.</li> <li><code>sozu.buffer.number</code>: number of buffers used in the buffer pool. Inactive sessions and requests for which we send a default answer (400, 404, 413, 503 HTTP errors) do not use buffers. Active HTTP sessions use one buffer (except in pipelining mode), WebSocket sessions use two buffers. So the number of buffers should always be lower than the slab count, and lower than the number of connections.</li> <li><code>sozu.zombies</code>: sozu integrates a zombie session checker. If some session did not do anything for a while, there's probably a bug in the event loop or the protocol implementations, so its internal state is logged. This counter is incremented for each zombie session that gets deleted.</li> </ul> <p>New connections are put into a queue, and wait until the session is created (if we have available resources), or until a configurable timeout has elapsed. The following metrics observe the accept queue usage:</p> <ul> <li><code>sozu.accept_queue.connections</code>: number of sockets in the accept queue</li> <li><code>sozu.accept_queue.timeout</code>: incremented every time a socket stayed too long in the queue and is closed</li> <li><code>sozu.accept_queue.wait_time</code>: every time a session is created, this metric records how long the socket had to wait in the accept queue</li> </ul>"},{"location":"debugging_strategies/#tls-specific-information","title":"TLS specific information","text":"<p>TLS version counter:</p> <ul> <li><code>sozu.tls.version.SSLv2</code></li> <li><code>sozu.tls.version.SSLv3</code></li> <li><code>sozu.tls.version.TLSv1_0</code></li> <li><code>sozu.tls.version.TLSv1_1</code></li> <li><code>sozu.tls.version.TLSv1_2</code></li> <li><code>sozu.tls.version.TLSv1_3</code></li> <li><code>sozu.tls.version.Unknown</code></li> </ul> <p>Rustls specific, negotiated ciphersuite:</p> <ul> <li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</code></li> <li><code>sozu.tls.cipher.TLS13_CHACHA20_POLY1305_SHA256</code></li> <li><code>sozu.tls.cipher.TLS13_AES_256_GCM_SHA384</code></li> <li><code>sozu.tls.cipher.TLS13_AES_128_GCM_SHA256</code></li> <li><code>sozu.tls.cipher.Unsupported</code></li> </ul>"},{"location":"debugging_strategies/#classic-error-scenarios","title":"Classic error scenarios","text":""},{"location":"debugging_strategies/#routing-issues","title":"Routing issues","text":"<p>Normal traffic (<code>sozu.http.requests</code>) drops while 404 (<code>sozu.http.404.errors</code>) and 503 (<code>sozu.http.503.errors</code>), that means sozu's configuration is probably invalid. Check the configuration state with;</p> <pre><code>sozu -c /etc/config.toml clusters list\n</code></pre> <p>And, for the complete configuration for a specific cluster id:</p> <pre><code>sozu -c /etc/config.toml clusters list -i cluster_id\n</code></pre>"},{"location":"debugging_strategies/#backend-server-unavailable","title":"Backend server unavailable","text":"<p><code>sozu.http.503.errors</code> increases, lots of <code>sozu.backend.connections.error</code> and a <code>sozu.backend.down</code> record: a backend server is down. Check the logs for <code>error connecting to backend, trying again</code> and <code>no more available backends for cluster &lt;cluster_id&gt;</code> to find out which cluster is affected</p>"},{"location":"debugging_strategies/#zombies","title":"Zombies","text":"<p>if the <code>sozu.zombies</code> metric triggers, this means there's an event loop or protocol implementation bug. The logs should contain the internal state of the sessions that were killed. Please copy those logs and open an issue to sozu.</p> <p>It usually comes with the <code>sozu.slab.entries</code> increasing while the number of connections or active requests stays the same. The slab count will then drop when the zombie checker activates.</p>"},{"location":"debugging_strategies/#invalid-session-close","title":"Invalid session close","text":"<p>if the slab count and active requests stay the same but <code>sozu.client.connections</code> and/or <code>sozu.backend.connections</code> are increasing, it means sessions are not properly closed by sozu, please open an issue for this. (if the slab count stays constant, sockets should still be closed properly, though)</p>"},{"location":"debugging_strategies/#accept-queue-filling-up","title":"accept queue filling up","text":"<p>if <code>sozu.accept_queue.connections</code> is increasing, that means the accept queue is filling up because sozu is under heavy load (in a healthy load, this queue is almost always empty). <code>sozu.accept_queue.wait_time</code> should increase as well. If <code>sozu.accept_queue.timeout</code> is higher than zero, sozu cannot accept sessions fast enough and is rejecting traffic.</p>"},{"location":"debugging_strategies/#during-development","title":"During development","text":"<p>In the config.toml file:</p> <ul> <li>if the bug only affects one of the protocols (HTTP, HTTPS or TCP), deactivate the other ones</li> <li>set <code>worker_count</code> to 1 to avoid duplicates in the log</li> <li>to debug panics:</li> <li>start sozu with <code>RUST_BACKTRACE=1</code></li> <li>set <code>worker_automatic_restart</code> to false (so sozu can stop immediately)</li> </ul>"},{"location":"debugging_strategies/#tracking-metrics","title":"Tracking metrics","text":"<p>The grad metrics tool was developed to easily aggregate statsd metric and display them.</p>"},{"location":"debugging_strategies_zh/","title":"\u5982\u4f55\u8c03\u8bd5 sozu","text":"<p>Sozu \u63d0\u4f9b\u65e5\u5fd7\u548c\u6307\u6807\uff0c\u53ef\u4ee5\u68c0\u6d4b\u5927\u591a\u6570\u751f\u4ea7\u95ee\u9898\u3002</p>"},{"location":"debugging_strategies_zh/#_1","title":"\u6536\u96c6\u4fe1\u606f","text":""},{"location":"debugging_strategies_zh/#sozu_1","title":"\u901a\u8fc7 sozu \u547d\u4ee4\u884c\u8f6c\u50a8\u72b6\u6001","text":"<p>\u5728\u751f\u4ea7\u7cfb\u7edf\u4e2d\u6536\u96c6\u6709\u5173\u914d\u7f6e\u72b6\u6001\u7684\u4fe1\u606f\u975e\u5e38\u6709\u7528\u3002 \u4ee5\u4e0b\u662f\u4e00\u4e9b\u53ef\u7528\u4e8e\u83b7\u53d6\u5f53\u524d\u72b6\u6001\u5feb\u7167\u7684\u547d\u4ee4\uff1a</p> <pre><code>sozu -c /etc/config.toml status\"\nsozu -c /etc/config.toml metrics get\"\nsozu -c /etc/config.toml clusters list\"\nsozu -c /etc/config.toml state save -f \"sozu-state-$(date -Iseconds).txt\"\n</code></pre>"},{"location":"debugging_strategies_zh/#_2","title":"\u65e5\u5fd7\u8bb0\u5f55","text":"<p>\u6709\u4e09\u4e2a\u4e0e\u65e5\u5fd7\u8bb0\u5f55\u76f8\u5173\u7684\u914d\u7f6e\u9009\u9879\uff1a</p> <ul> <li><code>log_level</code>\uff1a\u8bbe\u7f6e\u65e5\u5fd7\u8bb0\u5f55\u7684\u8be6\u7ec6\u7a0b\u5ea6</li> <li><code>log_target</code>\uff1a\u65e5\u5fd7\u53d1\u9001\u5230\u7684\u4f4d\u7f6e\u3002\u5b83\u53ef\u4ee5\u6709\u4ee5\u4e0b\u683c\u5f0f\uff1a</li> <li><code>stdout</code></li> <li><code>udp://127.0.0.1:9876</code></li> <li><code>tcp://127.0.0.1:9876</code></li> <li><code>unix:///var/sozu/logs</code></li> <li><code>file:///var/logs/sozu.log</code></li> <li><code>access_logs_target</code>\uff1a\u5982\u679c\u6fc0\u6d3b\uff0c\u5219\u5c06\u8bbf\u95ee\u65e5\u5fd7\u53d1\u9001\u5230\u5355\u72ec\u7684\u76ee\u6807</li> </ul> <p><code>log_level</code> \u9075\u5faa env_logger \u7684\u7ea7\u522b\u6307\u4ee4\u3002 \u6b64\u5916\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>RUST_LOG</code> \u73af\u5883\u53d8\u91cf\u8986\u76d6\u65e5\u5fd7\u7ea7\u522b\u3002</p> <p>\u5982\u679c sozu \u662f\u5728\u53d1\u5e03\u6a21\u5f0f\u4e0b\u6784\u5efa\u7684\uff0c\u5219\u4e0d\u4f1a\u7f16\u8bd1 <code>DEBUG</code> \u548c <code>TRACE</code> \u65e5\u5fd7\u7ea7\u522b\uff0c \u9664\u975e\u60a8\u8bbe\u7f6e\u4e86\u7f16\u8bd1\u529f\u80fd <code>logs-debug</code> \u548c <code>logs-trace</code>\u3002</p>"},{"location":"debugging_strategies_zh/#_3","title":"\u6307\u6807","text":"<p>sozu \u8fd0\u884c\u65f6\u4f1a\u751f\u6210\u5404\u79cd\u6307\u6807\u3002\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u8bbf\u95ee\u5b83\u4eec\uff1a</p> <ul> <li>\u901a\u8fc7 <code>sozu metrics get</code>\uff0c\u5b83\u5c06\u663e\u793a\u4e3b\u8fdb\u7a0b\u548c\u5de5\u4f5c\u8fdb\u7a0b\u7684\u6307\u6807\u3002\u8ba1\u6570\u5668\u5728\u6bcf\u6b21\u8c03\u7528\u4e4b\u95f4\u5237\u65b0</li> <li>\u901a\u8fc7 UDP\uff0c\u9075\u5faa statsd \u534f\u8bae\uff08\u53ef\u9009\u5730\u652f\u6301 InfluxDB \u7684\u6807\u7b7e\uff09</li> </ul> <p>\u4ee5\u4e0b\u662f\u5982\u4f55\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u4f7f\u7528 statsd \u8bbe\u7f6e\u6307\u6807\uff1a</p> <pre><code>[metrics]\naddress = \"127.0.0.1:8125\"\n# \u4f7f\u7528 InfluxDB \u7684 statsd \u534f\u8bae\u98ce\u683c\u6dfb\u52a0\u6807\u7b7e\uff08\u9ed8\u8ba4\u4e3a false\uff09\ntagged_metrics = true\n# \u6307\u6807\u952e\u524d\u7f00\uff08\u9ed8\u8ba4\u4e3a sozu\uff09\n# prefix = \"sozu\"\n</code></pre>"},{"location":"debugging_strategies_zh/#_4","title":"\u8981\u5173\u6ce8\u7684\u56fe\u8868\u548c\u6307\u6807","text":"<p>\uff08\u5047\u8bbe\u6211\u4eec\u5c06 <code>sozu</code> \u8bbe\u7f6e\u4e3a\u6307\u6807\u524d\u7f00\uff09</p>"},{"location":"debugging_strategies_zh/#_5","title":"\u8ddf\u8e2a\u6709\u6548\u6d41\u91cf","text":""},{"location":"debugging_strategies_zh/#_6","title":"\u8bbf\u95ee\u65e5\u5fd7","text":"<p>\u8bbf\u95ee\u65e5\u5fd7\u5177\u6709\u4ee5\u4e0b\u683c\u5f0f\uff1a</p> <pre><code>2018-09-21T14:01:51Z 821136800672570 71013 WRK-00 INFO  450b071a-53b8-4fd7-b2f2-1213f03ef032 MyCluster      127.0.0.1:52323 -&gt; 127.0.0.1:1027       241ms 855\u03bcs 560 33084   200 OK lolcatho.st:8080 GET /\n</code></pre> <p>\u4ece\u5de6\u5230\u53f3\uff1a</p> <ul> <li>ISO8601 \u683c\u5f0f\u7684\u65e5\u671f\uff0cUTC \u65f6\u533a</li> <li>\u5355\u8c03\u65f6\u949f\uff08\u4ee5\u9632\u67d0\u4e9b\u6d88\u606f\u987a\u5e8f\u9519\u8bef\uff09</li> <li>PID</li> <li>\u5de5\u4f5c\u8fdb\u7a0b\u540d\u79f0\uff08\u4e3b\u8fdb\u7a0b\u4e3a\u201cMAIN\u201d\uff09</li> <li>\u65e5\u5fd7\u7ea7\u522b</li> <li>\u8bf7\u6c42 ID\uff08UUID\uff0c\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u968f\u673a\u751f\u6210\uff0c\u5982\u679c\u5728 keep-alive \u4e2d\u6267\u884c\u591a\u4e2a\u8bf7\u6c42\uff0c\u5219\u5728\u540c\u4e00\u8fde\u63a5\u4e0a\u4f1a\u66f4\u6539\uff09</li> <li>\u96c6\u7fa4 ID</li> <li>\u5ba2\u6237\u7aef\u7684\u6e90 IP \u548c\u7aef\u53e3</li> <li>\u540e\u7aef\u670d\u52a1\u5668\u7684\u76ee\u6807 IP \u548c\u7aef\u53e3</li> <li>\u54cd\u5e94\u65f6\u95f4\uff08\u4ece\u5ba2\u6237\u7aef\u63a5\u6536\u5230\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\u5230\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u7684\u6700\u540e\u4e00\u4e2a\u5b57\u8282\uff09</li> <li>\u670d\u52a1\u65f6\u95f4\uff08sozu \u5904\u7406\u4f1a\u8bdd\u6240\u82b1\u8d39\u7684\u65f6\u95f4\uff09</li> <li>\u4e0a\u4f20\u7684\u5b57\u8282\u6570</li> <li>\u4e0b\u8f7d\u7684\u5b57\u8282\u6570</li> </ul>"},{"location":"debugging_strategies_zh/#http","title":"HTTP \u72b6\u6001\u6307\u6807","text":"<p>\u4ee5\u4e0b\u6307\u6807\u8ddf\u8e2a\u6b63\u786e\u53d1\u9001\u5230\u540e\u7aef\u670d\u52a1\u5668\u7684\u8bf7\u6c42\uff1a</p> <ul> <li><code>sozu.http.status.1xx</code>\uff1a\u8ba1\u7b97\u72b6\u6001\u4e3a 100 \u5230 199 \u7684\u8bf7\u6c42</li> <li><code>sozu.http.status.2xx</code>\uff1a\u8ba1\u7b97\u72b6\u6001\u4e3a 200 \u5230 299 \u7684\u8bf7\u6c42</li> <li><code>sozu.http.status.3xx</code>\uff1a\u8ba1\u7b97\u72b6\u6001\u4e3a 300 \u5230 399 \u7684\u8bf7\u6c42</li> <li><code>sozu.http.status.4xx</code>\uff1a\u8ba1\u7b97\u72b6\u6001\u4e3a 400 \u5230 499 \u7684\u8bf7\u6c42</li> <li><code>sozu.http.status.5xx</code>\uff1a\u8ba1\u7b97\u72b6\u6001\u4e3a 500 \u5230 599 \u7684\u8bf7\u6c42</li> <li><code>sozu.http.requests</code>\uff1a\u6bcf\u4e2a\u8bf7\u6c42\u9012\u589e\uff08\u4e0a\u8ff0\u8ba1\u6570\u5668\u7684\u603b\u548c\uff09</li> </ul>"},{"location":"debugging_strategies_zh/#_7","title":"\u4f20\u8f93\u7684\u6570\u636e","text":"<p>\u6709\u5168\u5c40\u7684 <code>sozu.bytes_in</code> \u548c <code>sozu.bytes_out</code> \u6307\u6807\uff0c\u7528\u4e8e\u8ba1\u7b97 sozu \u7684\u524d\u7aef\u6d41\u91cf\u3002 \u8fd9\u4e9b\u6307\u6807\u4e5f\u53ef\u4ee5\u5177\u6709\u540e\u7aef ID \u548c\u96c6\u7fa4 ID\u3002\u7136\u540e\u5b83\u4eec\u5c06\u4ece \u540e\u7aef\u670d\u52a1\u5668\u7684\u89d2\u5ea6\u6307\u793a\u4f20\u5165\u548c\u4f20\u51fa\u7684\u5b57\u8282\u3002</p>"},{"location":"debugging_strategies_zh/#_8","title":"\u54cd\u5e94\u65f6\u95f4","text":"<p>?</p>"},{"location":"debugging_strategies_zh/#_9","title":"\u534f\u8bae","text":"<p>\u5ba2\u6237\u7aef\u4f1a\u8bdd\u53ef\u4ee5\u5904\u4e8e\u5176\u7f51\u7edc\u534f\u8bae\u7684\u5404\u79cd\u72b6\u6001\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u8fde\u63a5 \u53ef\u4ee5\u4ece\u201c\u671f\u671b\u4ee3\u7406\u534f\u8bae\u201d\uff08\u5047\u8bbe\u524d\u9762\u6709\u4e00\u4e2a TCP \u4ee3\u7406\uff09\u5230 TLS \u63e1\u624b\uff0c \u5230 HTTPS\uff0c\u5230 WSS\uff08\u57fa\u4e8e TLS \u7684 websocket\uff09\u3002</p> <p>\u60a8\u53ef\u4ee5\u8ddf\u8e2a\u4ee5\u4e0b\u4eea\u8868\uff0c\u6307\u793a\u5f53\u524d\u7684\u534f\u8bae\u4f7f\u7528\u60c5\u51b5\uff1a</p> <ul> <li><code>sozu.protocol.proxy.expect</code></li> <li><code>sozu.protocol.proxy.send</code></li> <li><code>sozu.protocol.proxy.relay</code></li> <li><code>sozu.protocol.tcp</code></li> <li><code>sozu.protocol.tls.handshake</code></li> <li><code>sozu.protocol.http</code></li> <li><code>sozu.protocol.https</code></li> <li><code>sozu.protocol.ws</code></li> <li><code>sozu.protocol.wss</code></li> </ul>"},{"location":"debugging_strategies_zh/#_10","title":"\u8ddf\u8e2a\u5931\u8d25\u7684\u8bf7\u6c42","text":"<p>Sozu \u6709\u4e00\u79cd\u4ee5\u6700\u5c11\u7684\u8d44\u6e90\u4f7f\u7528\u6765\u54cd\u5e94\u65e0\u6548\u6d41\u91cf\u7684\u65b9\u6cd5\uff0c\u53d1\u9001\u9884\u5b9a\u4e49\u7684\u7b54\u6848\u3002 \u5b83\u5bf9\u65e0\u6548\u6d41\u91cf\uff08\u4e0d\u7b26\u5408\u6807\u51c6\uff09\u548c\u8def\u7531\u95ee\u9898\uff08\u672a\u77e5\u4e3b\u673a\u548c/\u6216\u8def\u5f84\uff0c \u65e0\u54cd\u5e94\u7684\u540e\u7aef\u670d\u52a1\u5668\uff09\u6267\u884c\u6b64\u64cd\u4f5c\u3002</p> <p><code>sozu.http.errors</code> \u8ba1\u6570\u5668\u662f\u5931\u8d25\u8bf7\u6c42\u7684\u603b\u548c\u3002\u5b83\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li><code>sozu.http.frontend_parse_errors</code>\uff1asozu \u6536\u5230\u4e86\u4e00\u4e9b\u65e0\u6548\u7684\u6d41\u91cf</li> <li><code>sozu.http.400.errors</code>\uff1a\u65e0\u6cd5\u89e3\u6790\u4e3b\u673a\u540d</li> <li><code>sozu.http.404.errors</code>\uff1a\u672a\u77e5\u7684\u4e3b\u673a\u540d\u548c/\u6216\u8def\u5f84</li> <li><code>sozu.http.413.errors</code>\uff1a\u8bf7\u6c42\u592a\u5927</li> <li><code>sozu.http.503.errors</code>\uff1a\u65e0\u6cd5\u8fde\u63a5\u5230\u540e\u7aef\u670d\u52a1\u5668\uff0c\u6216\u76f8\u5e94\u96c6\u7fa4\u6ca1\u6709\u53ef\u7528\u7684\u540e\u7aef\u670d\u52a1\u5668</li> </ul> <p>\u66f4\u8fdb\u4e00\u6b65\uff0c\u540e\u7aef\u8fde\u63a5\u95ee\u9898\u7531\u4ee5\u4e0b\u6307\u6807\u8ddf\u8e2a\uff1a</p> <ul> <li><code>sozu.backend.connections.error</code>\uff1a\u65e0\u6cd5\u8fde\u63a5\u5230\u540e\u7aef\u670d\u52a1\u5668</li> <li><code>sozu.backend.down</code>\uff1a\u91cd\u8bd5\u7b56\u7565\u5df2\u89e6\u53d1\u5e76\u5c06\u540e\u7aef\u670d\u52a1\u5668\u6807\u8bb0\u4e3a\u5173\u95ed</li> </ul> <p><code>sozu.http.503.errors</code> \u6307\u6807\u5728\u8bf7\u6c42\u53d1\u56de 503 \u9519\u8bef\u540e\u9012\u589e\uff0c\u5e76\u4e14\u5728 \u65ad\u8def\u5668\u89e6\u53d1\u540e\uff08\u6211\u4eec\u7b49\u5f85 3 \u6b21\u8fde\u63a5\u540e\u7aef\u670d\u52a1\u5668\u5931\u8d25\uff09\u53d1\u9001 503 \u9519\u8bef\u3002</p> <p>\u540e\u7aef\u8fde\u63a5\u9519\u8bef\u5c06\u5bfc\u81f4\u4ee5\u4e0b\u65e5\u5fd7\u6d88\u606f\uff1a</p> <pre><code>2018-09-21T14:36:08Z 823194694977734 71501 WRK-00 ERROR 839f592b-a194-4c3b-848b-8ef024129969    MyCluster    error connecting to backend, trying again\n</code></pre> <p>\u65ad\u8def\u5668\u89e6\u53d1\u5c06\u628a\u6b64\u5185\u5bb9\u5199\u5165\u65e5\u5fd7\uff1a</p> <pre><code>2018-09-21T14:36:57Z 823243245414405 71524 WRK-00 ERROR 7029d66e-57a8-406e-ae61-e4bf9ff7b6b8    MyCluster    max connection attempt reached\n</code></pre> <p>\u91cd\u8bd5\u7b56\u7565\u5c06\u540e\u7aef\u670d\u52a1\u5668\u6807\u8bb0\u4e3a\u5173\u95ed\u5c06\u5199\u5165\u4ee5\u4e0b\u65e5\u5fd7\u6d88\u606f\uff1a</p> <pre><code>2018-09-21T14:37:31Z 823277868708804 71524 WRK-00 ERROR no more available backends for cluster MyCluster\n</code></pre>"},{"location":"debugging_strategies_zh/#_11","title":"\u53ef\u4f38\u7f29\u6027","text":"<p>Sozu \u7cbe\u7ec6\u5730\u5904\u7406\u5176\u8d44\u6e90\u4f7f\u7528\uff0c\u5e76\u5bf9\u8bf7\u6c42\u6570\u91cf \u6216\u5185\u5b58\u4f7f\u7528\u8bbe\u7f6e\u786c\u6027\u9650\u5236\u3002</p> <p>\u8981\u8ddf\u8e2a\u8fde\u63a5\uff0c\u8bf7\u5173\u6ce8\u4ee5\u4e0b\u4eea\u8868\uff1a</p> <ul> <li><code>sozu.client.connections</code> \u7528\u4e8e\u524d\u7aef\u8fde\u63a5</li> <li><code>sozu.backend.connections</code> \u7528\u4e8e\u540e\u7aef\u8fde\u63a5</li> <li><code>sozu.http.active_requests</code> \u7528\u4e8e\u5f53\u524d\u6d3b\u52a8\u7684\u8fde\u63a5\uff08\u7b49\u5f85 \u4e0b\u4e00\u4e2a\u8bf7\u6c42\u7684 keep-alive \u8fde\u63a5\u88ab\u6807\u8bb0\u4e3a\u4e0d\u6d3b\u52a8\uff09</li> </ul> <p>\u5ba2\u6237\u7aef\u8fde\u63a5\u5e94\u59cb\u7ec8\u9ad8\u4e8e\u540e\u7aef\u8fde\u63a5\uff0c\u800c\u540e\u7aef\u8fde\u63a5\u5e94\u9ad8\u4e8e \u6d3b\u52a8\u8bf7\u6c42\uff08\u4e0d\u6d3b\u52a8\u7684\u4f1a\u8bdd\u53ef\u4ee5\u4fdd\u7559\u540e\u7aef\u8fde\u63a5\uff09\u3002</p> <p>\u8fd9\u4e9b\u6307\u6807\u4e0e\u8d44\u6e90\u4f7f\u7528\u5bc6\u5207\u76f8\u5173\uff0c\u540e\u8005\u7531\u4ee5\u4e0b\u6307\u6807\u8ddf\u8e2a\uff1a</p> <ul> <li><code>sozu.slab.entries</code>\uff1aslab \u5206\u914d\u5668\u4e2d\u4f7f\u7528\u7684\u63d2\u69fd\u6570\u3002\u901a\u5e38\uff0c\u6bcf\u4e2a\u76d1\u542c\u5668\u5957\u63a5\u5b57\u6709\u4e00\u4e2a\u63d2\u69fd\uff0c \u4e00\u4e2a\u7528\u4e8e\u8fde\u63a5\u5230\u4e3b\u8fdb\u7a0b\uff0c\u4e00\u4e2a\u7528\u4e8e\u6307\u6807\u5957\u63a5\u5b57\uff0c\u7136\u540e\u6bcf\u4e2a\u524d\u7aef\u8fde\u63a5\u4e00\u4e2a\uff0c \u6bcf\u4e2a\u540e\u7aef\u8fde\u63a5\u4e00\u4e2a\u3002\u56e0\u6b64\uff0c\u8fde\u63a5\u6570\u5e94\u59cb\u7ec8\u63a5\u8fd1\uff08\u4f46\u4f4e\u4e8e\uff09slab \u8ba1\u6570\u3002</li> <li><code>sozu.buffer.number</code>\uff1a\u7f13\u51b2\u6c60\u4e2d\u4f7f\u7528\u7684\u7f13\u51b2\u533a\u6570\u3002\u4e0d\u6d3b\u52a8\u7684\u4f1a\u8bdd\u548c\u6211\u4eec\u53d1\u9001 \u9ed8\u8ba4\u7b54\u6848\uff08400\u3001404\u3001413\u3001503 HTTP \u9519\u8bef\uff09\u7684\u8bf7\u6c42\u4e0d\u4f7f\u7528\u7f13\u51b2\u533a\u3002\u6d3b\u52a8\u7684 HTTP \u4f1a\u8bdd\u4f7f\u7528\u4e00\u4e2a\u7f13\u51b2\u533a\uff08 \u6d41\u6c34\u7ebf\u6a21\u5f0f\u9664\u5916\uff09\uff0cWebSocket \u4f1a\u8bdd\u4f7f\u7528\u4e24\u4e2a\u7f13\u51b2\u533a\u3002\u56e0\u6b64\uff0c\u7f13\u51b2\u533a\u6570\u5e94\u59cb\u7ec8\u4f4e\u4e8e slab \u8ba1\u6570\uff0c\u5e76\u4f4e\u4e8e\u8fde\u63a5\u6570\u3002</li> <li><code>sozu.zombies</code>\uff1asozu \u96c6\u6210\u4e86\u4e00\u4e2a\u50f5\u5c38\u4f1a\u8bdd\u68c0\u67e5\u5668\u3002\u5982\u679c\u67d0\u4e2a\u4f1a\u8bdd\u4e00\u6bb5\u65f6\u95f4\u5185\u6ca1\u6709\u4efb\u4f55\u64cd\u4f5c\uff0c \u5219\u4e8b\u4ef6\u5faa\u73af\u6216\u534f\u8bae\u5b9e\u73b0\u4e2d\u53ef\u80fd\u5b58\u5728\u9519\u8bef\uff0c\u56e0\u6b64\u4f1a\u8bb0\u5f55\u5176\u5185\u90e8\u72b6\u6001\u3002\u6b64\u8ba1\u6570\u5668 \u4e3a\u6bcf\u4e2a\u88ab\u5220\u9664\u7684\u50f5\u5c38\u4f1a\u8bdd\u9012\u589e\u3002</li> </ul> <p>\u65b0\u8fde\u63a5\u88ab\u653e\u5165\u961f\u5217\u4e2d\uff0c\u5e76\u7b49\u5f85\u76f4\u5230\u4f1a\u8bdd\u88ab\u521b\u5efa\uff08\u5982\u679c\u6211\u4eec\u6709\u53ef\u7528\u8d44\u6e90\uff09\uff0c \u6216\u76f4\u5230\u914d\u7f6e\u7684\u8d85\u65f6\u5df2\u8fc7\u3002\u4ee5\u4e0b\u6307\u6807\u89c2\u5bdf\u63a5\u53d7\u961f\u5217\u7684\u4f7f\u7528\u60c5\u51b5\uff1a</p> <ul> <li><code>sozu.accept_queue.connections</code>\uff1a\u63a5\u53d7\u961f\u5217\u4e2d\u7684\u5957\u63a5\u5b57\u6570</li> <li><code>sozu.accept_queue.timeout</code>\uff1a\u6bcf\u6b21\u5957\u63a5\u5b57\u5728\u961f\u5217\u4e2d\u505c\u7559\u65f6\u95f4\u8fc7\u957f\u5e76\u88ab\u5173\u95ed\u65f6\u9012\u589e</li> <li><code>sozu.accept_queue.wait_time</code>\uff1a\u6bcf\u6b21\u521b\u5efa\u4f1a\u8bdd\u65f6\uff0c\u6b64\u6307\u6807\u8bb0\u5f55\u5957\u63a5\u5b57\u5728\u63a5\u53d7\u961f\u5217\u4e2d\u5fc5\u987b\u7b49\u5f85\u591a\u957f\u65f6\u95f4</li> </ul>"},{"location":"debugging_strategies_zh/#tls","title":"TLS \u7279\u5b9a\u4fe1\u606f","text":"<p>TLS \u7248\u672c\u8ba1\u6570\u5668\uff1a</p> <ul> <li><code>sozu.tls.version.SSLv2</code></li> <li><code>sozu.tls.version.SSLv3</code></li> <li><code>sozu.tls.version.TLSv1_0</code></li> <li><code>sozu.tls.version.TLSv1_1</code></li> <li><code>sozu.tls.version.TLSv1_2</code></li> <li><code>sozu.tls.version.TLSv1_3</code></li> <li><code>sozu.tls.version.Unknown</code></li> </ul> <p>Rustls \u7279\u5b9a\u7684\u534f\u5546\u5bc6\u7801\u5957\u4ef6\uff1a</p> <ul> <li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</code></li> <li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</code></li> <li><code>sozu.tls.cipher.TLS13_CHACHA20_POLY1305_SHA256</code></li> <li><code>sozu.tls.cipher.TLS13_AES_256_GCM_SHA384</code></li> <li><code>sozu.tls.cipher.TLS13_AES_128_GCM_SHA256</code></li> <li><code>sozu.tls.cipher.Unsupported</code></li> </ul>"},{"location":"debugging_strategies_zh/#_12","title":"\u7ecf\u5178\u9519\u8bef\u573a\u666f","text":""},{"location":"debugging_strategies_zh/#_13","title":"\u8def\u7531\u95ee\u9898","text":"<p>\u6b63\u5e38\u6d41\u91cf (<code>sozu.http.requests</code>) \u4e0b\u964d\uff0c\u800c 404 (<code>sozu.http.404.errors</code>) \u548c 503 (<code>sozu.http.503.errors</code>) \u589e\u52a0\uff0c\u8fd9\u610f\u5473\u7740 sozu \u7684\u914d\u7f6e\u53ef\u80fd\u6709\u95ee\u9898\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u914d\u7f6e\u72b6\u6001\uff1a</p> <pre><code>sozu -c /etc/config.toml clusters list\n</code></pre> <p>\u5e76\u4e14\uff0c\u5bf9\u4e8e\u7279\u5b9a\u96c6\u7fa4 ID \u7684\u5b8c\u6574\u914d\u7f6e\uff1a</p> <pre><code>sozu -c /etc/config.toml clusters list -i cluster_id\n</code></pre>"},{"location":"debugging_strategies_zh/#_14","title":"\u540e\u7aef\u670d\u52a1\u5668\u4e0d\u53ef\u7528","text":"<p><code>sozu.http.503.errors</code> \u589e\u52a0\uff0c\u5927\u91cf\u7684 <code>sozu.backend.connections.error</code> \u548c <code>sozu.backend.down</code> \u8bb0\u5f55\uff1a\u540e\u7aef\u670d\u52a1\u5668\u5df2\u5173\u95ed\u3002 \u68c0\u67e5\u65e5\u5fd7\u4e2d\u662f\u5426\u6709 <code>error connecting to backend, trying again</code> \u548c <code>no more available backends for cluster &lt;cluster_id&gt;</code> \u4ee5\u627e\u51fa\u53d7\u5f71\u54cd\u7684\u96c6\u7fa4</p>"},{"location":"debugging_strategies_zh/#_15","title":"\u50f5\u5c38","text":"<p>\u5982\u679c <code>sozu.zombies</code> \u6307\u6807\u89e6\u53d1\uff0c\u8fd9\u610f\u5473\u7740\u5b58\u5728\u4e8b\u4ef6\u5faa\u73af\u6216\u534f\u8bae\u5b9e\u73b0 \u9519\u8bef\u3002\u65e5\u5fd7\u5e94\u5305\u542b\u88ab\u7ec8\u6b62\u7684\u4f1a\u8bdd\u7684\u5185\u90e8\u72b6\u6001\u3002\u8bf7\u590d\u5236\u8fd9\u4e9b \u65e5\u5fd7\u5e76\u5411 sozu \u63d0\u4ea4\u95ee\u9898\u3002</p> <p>\u5b83\u901a\u5e38\u4f34\u968f\u7740 <code>sozu.slab.entries</code> \u589e\u52a0\uff0c\u800c\u8fde\u63a5\u6570\u6216\u6d3b\u52a8\u8bf7\u6c42\u6570 \u4fdd\u6301\u4e0d\u53d8\u3002\u7136\u540e\u5f53\u50f5\u5c38\u68c0\u67e5\u5668\u6fc0\u6d3b\u65f6\uff0cslab \u8ba1\u6570\u5c06\u4e0b\u964d\u3002</p>"},{"location":"debugging_strategies_zh/#_16","title":"\u65e0\u6548\u7684\u4f1a\u8bdd\u5173\u95ed","text":"<p>\u5982\u679c slab \u8ba1\u6570\u548c\u6d3b\u52a8\u8bf7\u6c42\u4fdd\u6301\u4e0d\u53d8\uff0c\u4f46 <code>sozu.client.connections</code> \u548c/\u6216 <code>sozu.backend.connections</code> \u6b63\u5728\u589e\u52a0\uff0c\u8fd9\u610f\u5473\u7740 sozu \u6ca1\u6709\u6b63\u786e\u5173\u95ed\u4f1a\u8bdd\uff0c\u8bf7\u4e3a\u6b64\u63d0\u4ea4\u95ee\u9898\u3002 \uff08\u5982\u679c slab \u8ba1\u6570\u4fdd\u6301\u4e0d\u53d8\uff0c\u5957\u63a5\u5b57\u4ecd\u5e94\u6b63\u786e\u5173\u95ed\uff09</p>"},{"location":"debugging_strategies_zh/#_17","title":"\u63a5\u53d7\u961f\u5217\u586b\u6ee1","text":"<p>\u5982\u679c <code>sozu.accept_queue.connections</code> \u6b63\u5728\u589e\u52a0\uff0c\u8fd9\u610f\u5473\u7740\u63a5\u53d7\u961f\u5217\u6b63\u5728\u586b\u6ee1\uff0c\u56e0\u4e3a sozu \u5904\u4e8e \u9ad8\u8d1f\u8f7d\u4e0b\uff08\u5728\u5065\u5eb7\u8d1f\u8f7d\u4e0b\uff0c\u6b64\u961f\u5217\u51e0\u4e4e\u603b\u662f\u7a7a\u7684\uff09\u3002<code>sozu.accept_queue.wait_time</code> \u4e5f\u5e94\u8be5\u589e\u52a0 \u3002\u5982\u679c <code>sozu.accept_queue.timeout</code> \u9ad8\u4e8e\u96f6\uff0csozu \u65e0\u6cd5\u8db3\u591f\u5feb\u5730\u63a5\u53d7\u4f1a\u8bdd\u5e76\u4e14 \u6b63\u5728\u62d2\u7edd\u6d41\u91cf\u3002</p>"},{"location":"debugging_strategies_zh/#_18","title":"\u5f00\u53d1\u671f\u95f4","text":"<p>\u5728 config.toml \u6587\u4ef6\u4e2d\uff1a</p> <ul> <li>\u5982\u679c\u9519\u8bef\u4ec5\u5f71\u54cd\u5176\u4e2d\u4e00\u4e2a\u534f\u8bae\uff08HTTP\u3001HTTPS \u6216 TCP\uff09\uff0c\u8bf7\u505c\u7528\u5176\u4ed6\u534f\u8bae</li> <li>\u5c06 <code>worker_count</code> \u8bbe\u7f6e\u4e3a 1 \u4ee5\u907f\u514d\u65e5\u5fd7\u4e2d\u51fa\u73b0\u91cd\u590d</li> <li>\u8c03\u8bd5 panic\uff1a</li> <li>\u4f7f\u7528 <code>RUST_BACKTRACE=1</code> \u542f\u52a8 sozu</li> <li>\u5c06 <code>worker_automatic_restart</code> \u8bbe\u7f6e\u4e3a false\uff08\u4ee5\u4fbf sozu \u53ef\u4ee5\u7acb\u5373\u505c\u6b62\uff09</li> </ul>"},{"location":"debugging_strategies_zh/#_19","title":"\u8ddf\u8e2a\u6307\u6807","text":"<p>grad \u6307\u6807\u5de5\u5177 \u7684\u5f00\u53d1\u662f\u4e3a\u4e86\u8f7b\u677e\u805a\u5408 statsd \u6307\u6807\u5e76\u663e\u793a\u5b83\u4eec\u3002</p>"},{"location":"design_motivation/","title":"Design Motivation","text":"<p>This document presents the goals we should have in mind while developing s\u014dzu. It will inform feature decisions, bugfixes and areas of focus.</p>"},{"location":"design_motivation/#origin","title":"Origin","text":"<p>S\u014dzu grew from a need at Clever Cloud to handle frequent configuration changes in a reverse proxy. Since the platform follows immutable infrastructure principles, applications move frequently from one virtual machine to another, and the reverse proxy's routing configuration must be updated.</p> <p>Classical solutions like HAProxy were designed to restart their process on each configuration change. This causes a few issues:</p> <ul> <li>restarting a proxy's process will cause a temporary spike in CPU and RAM usage (resource usage is duplicated)</li> <li>handling lingering connections:</li> <li>either we stop the old process and lose the connections it was still handling</li> <li>or we keep the old process until connections are done, but we might end up with a lot of old processes if we restart regularly</li> </ul>"},{"location":"design_motivation/#main-goals","title":"Main goals","text":""},{"location":"design_motivation/#configuration-changes-at-runtime","title":"Configuration changes at runtime","text":"<p>Changing the proxy's configuration should be a routine task performed at runtime. We should not need to restart an entire process just to handle this.</p> <p>This means that configuration management must support dynamic changes, so it must be reflected in the tools we use to drive s\u014dzu, and we need to provide good libraries to handle that use case.</p>"},{"location":"design_motivation/#fine-grained-modifications","title":"Fine grained modifications","text":"<p>instead of reloading an entire state (like hot relading a configuration file), we can push small modifications, like \"remove this backend server\", or \"add this certificate\". This gives us more information on the runtime system, like knowing when we can actually drop a backend server (once no more connections are using it).</p>"},{"location":"design_motivation/#bounded-resource-usage","title":"Bounded resource usage","text":"<p>We should be able to fix the limits in resource usage (CPU, RAM, connections, etc) directly in s\u014dzu's configuration. Instead of indefinitely increasing resource usage under load, we will refuse new traffic right away. This provides back pressure and allows clients to be smart about their retries, and keep a predictable latency and behaviour for existing connections.</p>"},{"location":"design_motivation/#never-ending-software","title":"Never ending software","text":"<p>Once you started s\u014dzu, it should be able to serve traffic indefinitely. If issues happen that cause a failure, it should not bring down the whole proxy, and it should be able to go back to handling traffic automatically.</p> <p>Side effect of this approach: a binary upgrade should not result in lost traffic.</p> <p>This is the main driver behind the current multiprocess architecture.</p>"},{"location":"design_motivation/#side-goals","title":"Side goals","text":""},{"location":"design_motivation/#security","title":"Security","text":"<p>Since s\u014dzu will likely see the traffic from a lot of client connections, and the private keys to their TLS certificates, it should be safe enough to protect its memory.</p> <p>To that end, we chose Rust for its memory safety features.</p>"},{"location":"design_motivation/#predictability","title":"Predictability","text":"<p>S\u014dzu should have a very predictable behaviour in its memory usage and its latency. Any irregularity should be observed and removed.</p> <p>This standpoint has driven various decisions:</p> <ul> <li>Rust allowed us to avoid garbage collection pauses</li> <li>preallocations and pooling to avoid some allocations in the hot path</li> <li>single threaded, shared nothing architecture to avoid synchronization between cores</li> </ul>"},{"location":"design_motivation/#the-configuration-intelligence-should-be-in-tools-not-inside-sozu","title":"The configuration intelligence should be in tools, not inside s\u014dzu","text":"<p>While s\u014dzu is able to handle fine grained configuration changes, it is not its role to connect to every configuration management tool under the sun (etcd, kubernetes, etc). Instead, we should provide means to write tools connecting s\u014dzu and the rest of the system.</p> <p>Going further, the code that handles configuration changes should be reusable outside of s\u014dzu. It is currently quite easy to write a tool that loads a configuration state from a file, get the current state from s\u014dzu, generate a diff then send configuration messages for the diff to s\u014dzu.</p> <p>Writing configuration tools should be easy enough, and the configuration protocol should be accessible from any language.</p>"},{"location":"design_motivation_zh/","title":"\u8bbe\u8ba1\u52a8\u673a","text":"<p>\u672c\u6587\u6863\u4ecb\u7ecd\u4e86\u6211\u4eec\u5728\u5f00\u53d1 s\u014dzu \u65f6\u5e94\u7262\u8bb0\u7684\u76ee\u6807\u3002 \u5b83\u5c06\u4e3a\u529f\u80fd\u51b3\u7b56\u3001\u9519\u8bef\u4fee\u590d\u548c\u91cd\u70b9\u9886\u57df\u63d0\u4f9b\u4fe1\u606f\u3002</p>"},{"location":"design_motivation_zh/#_2","title":"\u8d77\u6e90","text":"<p>S\u014dzu \u6e90\u4e8e Clever Cloud \u5728\u53cd\u5411\u4ee3\u7406\u4e2d\u5904\u7406\u9891\u7e41 \u914d\u7f6e\u66f4\u6539\u7684\u9700\u6c42\u3002\u7531\u4e8e\u8be5\u5e73\u53f0\u9075\u5faa\u4e0d\u53ef\u53d8\u57fa\u7840\u8bbe\u65bd \u539f\u5219\uff0c\u5e94\u7528\u7a0b\u5e8f\u7ecf\u5e38\u4ece\u4e00\u53f0\u865a\u62df\u673a\u79fb\u52a8\u5230\u53e6\u4e00\u53f0\u865a\u62df\u673a\uff0c\u5e76\u4e14 \u53cd\u5411\u4ee3\u7406\u7684\u8def\u7531\u914d\u7f6e\u5fc5\u987b\u66f4\u65b0\u3002</p> <p>\u50cf HAProxy \u8fd9\u6837\u7684\u7ecf\u5178\u89e3\u51b3\u65b9\u6848\u88ab\u8bbe\u8ba1\u4e3a\u5728\u6bcf\u6b21\u914d\u7f6e \u66f4\u6539\u65f6\u91cd\u65b0\u542f\u52a8\u5176\u8fdb\u7a0b\u3002\u8fd9\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u95ee\u9898\uff1a</p> <ul> <li>\u91cd\u65b0\u542f\u52a8\u4ee3\u7406\u8fdb\u7a0b\u5c06\u5bfc\u81f4 CPU \u548c RAM \u4f7f\u7528\u7387\u6682\u65f6\u98d9\u5347\uff08\u8d44\u6e90\u4f7f\u7528\u7387\u7ffb\u500d\uff09</li> <li>\u5904\u7406\u6325\u4e4b\u4e0d\u53bb\u7684\u8fde\u63a5\uff1a</li> <li>\u8981\u4e48\u6211\u4eec\u505c\u6b62\u65e7\u8fdb\u7a0b\u5e76\u4e22\u5931\u5b83\u4ecd\u5728\u5904\u7406\u7684\u8fde\u63a5</li> <li>\u8981\u4e48\u6211\u4eec\u4fdd\u7559\u65e7\u8fdb\u7a0b\u76f4\u5230\u8fde\u63a5\u5b8c\u6210\uff0c\u4f46\u5982\u679c\u6211\u4eec\u5b9a\u671f\u91cd\u65b0\u542f\u52a8\uff0c\u6211\u4eec\u6700\u7ec8\u53ef\u80fd\u4f1a\u6709\u5927\u91cf\u65e7\u8fdb\u7a0b</li> </ul>"},{"location":"design_motivation_zh/#_3","title":"\u4e3b\u8981\u76ee\u6807","text":""},{"location":"design_motivation_zh/#_4","title":"\u8fd0\u884c\u65f6\u914d\u7f6e\u66f4\u6539","text":"<p>\u66f4\u6539\u4ee3\u7406\u7684\u914d\u7f6e\u5e94\u8be5\u662f\u5728\u8fd0\u884c\u65f6\u6267\u884c\u7684\u4f8b\u884c\u4efb\u52a1\u3002 \u6211\u4eec\u4e0d\u5e94\u8be5\u4ec5\u4ec5\u4e3a\u4e86\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\u800c\u91cd\u65b0\u542f\u52a8\u6574\u4e2a\u8fdb\u7a0b\u3002</p> <p>\u8fd9\u610f\u5473\u7740\u914d\u7f6e\u7ba1\u7406\u5fc5\u987b\u652f\u6301\u52a8\u6001\u66f4\u6539\uff0c\u56e0\u6b64\u5b83\u5fc5\u987b \u53cd\u6620\u5728\u6211\u4eec\u7528\u6765\u9a71\u52a8 s\u014dzu \u7684\u5de5\u5177\u4e2d\uff0c\u5e76\u4e14\u6211\u4eec\u9700\u8981\u63d0\u4f9b\u826f\u597d\u7684\u5e93 \u6765\u5904\u7406\u8be5\u7528\u4f8b\u3002</p>"},{"location":"design_motivation_zh/#_5","title":"\u7ec6\u7c92\u5ea6\u4fee\u6539","text":"<p>\u6211\u4eec\u53ef\u4ee5\u63a8\u9001\u5c0f\u7684\u4fee\u6539\uff0c\u4f8b\u5982\u201c\u5220\u9664\u6b64\u540e\u7aef\u670d\u52a1\u5668\u201d\u6216 \u201c\u6dfb\u52a0\u6b64\u8bc1\u4e66\u201d\uff0c\u800c\u4e0d\u662f\u91cd\u65b0\u52a0\u8f7d\u6574\u4e2a\u72b6\u6001\uff08\u4f8b\u5982\u70ed\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\uff09\u3002\u8fd9\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u6709\u5173\u8fd0\u884c\u65f6\u7cfb\u7edf\u7684\u66f4\u591a\u4fe1\u606f\uff0c \u4f8b\u5982\u77e5\u9053\u6211\u4eec\u4f55\u65f6\u53ef\u4ee5\u771f\u6b63\u5220\u9664\u540e\u7aef\u670d\u52a1\u5668\uff08\u4e00\u65e6\u6ca1\u6709\u66f4\u591a\u8fde\u63a5 \u4f7f\u7528\u5b83\uff09\u3002</p>"},{"location":"design_motivation_zh/#_6","title":"\u6709\u754c\u8d44\u6e90\u4f7f\u7528","text":"<p>\u6211\u4eec\u5e94\u8be5\u80fd\u591f\u76f4\u63a5\u5728 s\u014dzu \u7684\u914d\u7f6e\u4e2d\u4fee\u590d\u8d44\u6e90\u4f7f\u7528\u9650\u5236\uff08CPU\u3001RAM\u3001\u8fde\u63a5\u7b49\uff09 \u3002\u6211\u4eec\u4e0d\u4f1a\u5728\u8d1f\u8f7d\u4e0b\u65e0\u9650\u589e\u52a0\u8d44\u6e90\u4f7f\u7528\uff0c \u800c\u662f\u4f1a\u7acb\u5373\u62d2\u7edd\u65b0\u6d41\u91cf\u3002\u8fd9\u63d0\u4f9b\u4e86\u80cc\u538b\u5e76\u5141\u8bb8\u5ba2\u6237\u7aef \u667a\u80fd\u5730\u8fdb\u884c\u91cd\u8bd5\uff0c\u5e76\u4e3a \u73b0\u6709\u8fde\u63a5\u4fdd\u6301\u53ef\u9884\u6d4b\u7684\u5ef6\u8fdf\u548c\u884c\u4e3a\u3002</p>"},{"location":"design_motivation_zh/#_7","title":"\u6c38\u4e0d\u7ec8\u6b62\u7684\u8f6f\u4ef6","text":"<p>\u4e00\u65e6\u4f60\u542f\u52a8\u4e86 s\u014dzu\uff0c\u5b83\u5c31\u5e94\u8be5\u80fd\u591f\u65e0\u9650\u671f\u5730\u4e3a\u6d41\u91cf\u63d0\u4f9b\u670d\u52a1\u3002\u5982\u679c\u53d1\u751f \u5bfc\u81f4\u6545\u969c\u7684\u95ee\u9898\uff0c\u5b83\u4e0d\u5e94\u8be5\u4f7f\u6574\u4e2a\u4ee3\u7406\u762b\u75ea\uff0c\u5e76\u4e14\u5b83\u5e94\u8be5 \u80fd\u591f\u81ea\u52a8\u6062\u590d\u5904\u7406\u6d41\u91cf\u3002</p> <p>\u8fd9\u79cd\u65b9\u6cd5\u7684\u526f\u4f5c\u7528\uff1a\u4e8c\u8fdb\u5236\u5347\u7ea7\u4e0d\u5e94\u5bfc\u81f4\u6d41\u91cf\u4e22\u5931\u3002</p> <p>\u8fd9\u662f\u5f53\u524d\u591a\u8fdb\u7a0b\u67b6\u6784\u80cc\u540e\u7684\u4e3b\u8981\u9a71\u52a8\u529b\u3002</p>"},{"location":"design_motivation_zh/#_8","title":"\u6b21\u8981\u76ee\u6807","text":""},{"location":"design_motivation_zh/#_9","title":"\u5b89\u5168","text":"<p>\u7531\u4e8e s\u014dzu \u53ef\u80fd\u4f1a\u770b\u5230\u6765\u81ea\u5927\u91cf\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u6d41\u91cf\uff0c\u4ee5\u53ca\u5b83\u4eec\u7684 TLS \u8bc1\u4e66\u7684 \u79c1\u94a5\uff0c\u56e0\u6b64\u5b83\u5e94\u8be5\u8db3\u591f\u5b89\u5168\u4ee5\u4fdd\u62a4\u5176\u5185\u5b58\u3002</p> <p>\u4e3a\u6b64\uff0c\u6211\u4eec\u9009\u62e9 Rust \u662f\u56e0\u4e3a\u5b83\u7684\u5185\u5b58\u5b89\u5168\u7279\u6027\u3002</p>"},{"location":"design_motivation_zh/#_10","title":"\u53ef\u9884\u6d4b\u6027","text":"<p>S\u014dzu \u5728\u5176\u5185\u5b58\u4f7f\u7528\u548c\u5ef6\u8fdf\u65b9\u9762\u5e94\u5177\u6709\u975e\u5e38\u53ef\u9884\u6d4b\u7684\u884c\u4e3a\u3002 \u4efb\u4f55\u4e0d\u89c4\u5219\u6027\u90fd\u5e94\u88ab\u89c2\u5bdf\u548c\u6d88\u9664\u3002</p> <p>\u8fd9\u4e00\u7acb\u573a\u63a8\u52a8\u4e86\u5404\u79cd\u51b3\u7b56\uff1a</p> <ul> <li>Rust \u4f7f\u6211\u4eec\u80fd\u591f\u907f\u514d\u5783\u573e\u6536\u96c6\u6682\u505c</li> <li>\u9884\u5206\u914d\u548c\u6c60\u5316\u4ee5\u907f\u514d\u70ed\u8def\u5f84\u4e2d\u7684\u4e00\u4e9b\u5206\u914d</li> <li>\u5355\u7ebf\u7a0b\u3001\u65e0\u5171\u4eab\u67b6\u6784\u4ee5\u907f\u514d\u6838\u5fc3\u4e4b\u95f4\u7684\u540c\u6b65</li> </ul>"},{"location":"design_motivation_zh/#sozu","title":"\u914d\u7f6e\u667a\u80fd\u5e94\u8be5\u5728\u5de5\u5177\u4e2d\uff0c\u800c\u4e0d\u662f\u5728 s\u014dzu \u5185\u90e8","text":"<p>\u867d\u7136 s\u014dzu \u80fd\u591f\u5904\u7406\u7ec6\u7c92\u5ea6\u7684\u914d\u7f6e\u66f4\u6539\uff0c\u4f46\u5b83\u7684\u4f5c\u7528 \u4e0d\u662f\u8fde\u63a5\u5230\u6240\u6709\u73b0\u6709\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff08etcd\u3001kubernetes \u7b49\uff09\u3002 \u76f8\u53cd\uff0c\u6211\u4eec\u5e94\u8be5\u63d0\u4f9b\u7f16\u5199\u8fde\u63a5 s\u014dzu \u548c\u7cfb\u7edf\u5176\u4f59\u90e8\u5206\u7684\u5de5\u5177\u7684\u65b9\u6cd5\u3002</p> <p>\u66f4\u8fdb\u4e00\u6b65\uff0c\u5904\u7406\u914d\u7f6e\u66f4\u6539\u7684\u4ee3\u7801\u5e94\u8be5\u53ef\u4ee5\u5728 s\u014dzu \u4e4b\u5916\u91cd\u7528\u3002 \u7f16\u5199\u4e00\u4e2a\u4ece\u6587\u4ef6\u52a0\u8f7d\u914d\u7f6e\u72b6\u6001\u3001 \u4ece s\u014dzu \u83b7\u53d6\u5f53\u524d\u72b6\u6001\u3001\u751f\u6210\u5dee\u5f02\u7136\u540e\u4e3a\u5dee\u5f02\u5411 s\u014dzu \u53d1\u9001\u914d\u7f6e\u6d88\u606f\u7684\u5de5\u5177\u76ee\u524d\u975e\u5e38\u5bb9\u6613\u3002</p> <p>\u7f16\u5199\u914d\u7f6e\u5de5\u5177\u5e94\u8be5\u8db3\u591f\u5bb9\u6613\uff0c\u5e76\u4e14\u914d\u7f6e\u534f\u8bae\u5e94\u8be5\u53ef\u4ee5 \u4ece\u4efb\u4f55\u8bed\u8a00\u8bbf\u95ee\u3002</p>"},{"location":"getting_started/","title":"Getting started","text":""},{"location":"getting_started/#setting-up-rust","title":"Setting up Rust","text":"<p>Make sure to have the latest stable version of <code>Rust</code> installed. We recommend using rustup for that.</p> <p>After you did that, <code>Rust</code> should be fully installed.</p>"},{"location":"getting_started/#setting-up-sozu","title":"Setting up S\u014dzu","text":""},{"location":"getting_started/#install","title":"Install","text":"<p><code>sozu</code> is published on crates.io.</p> <p>To install them, you only have to do <code>cargo install sozu</code>.</p> <p>They will be built and available in the <code>~/.cargo/bin</code> folder.</p>"},{"location":"getting_started/#build-from-source","title":"Build from source","text":"<p>Build the sozu executable and command line:</p> <p><code>cd bin &amp;&amp; cargo build --release --locked</code></p> <p>The <code>--release</code> parameter inform cargo to compile sozu with optimizations turned on. Only use <code>--release</code> to make a production version.</p> <p>The <code>--locked</code> flag tells cargo to stick to dependencies versions as specified in <code>Cargo.lock</code> and thus prevent dependencie breaks.</p>"},{"location":"getting_started_zh/","title":"\u5165\u95e8","text":""},{"location":"getting_started_zh/#rust","title":"\u8bbe\u7f6e Rust","text":"<p>\u786e\u4fdd\u5df2\u5b89\u88c5\u6700\u65b0\u7a33\u5b9a\u7248\u7684 <code>Rust</code>\u3002 \u6211\u4eec\u5efa\u8bae\u4e3a\u6b64\u4f7f\u7528 rustup\u3002</p> <p>\u5b8c\u6210\u6b64\u64cd\u4f5c\u540e\uff0c<code>Rust</code> \u5e94\u5df2\u5b8c\u5168\u5b89\u88c5\u3002</p>"},{"location":"getting_started_zh/#sozu","title":"\u8bbe\u7f6e S\u014dzu","text":""},{"location":"getting_started_zh/#_2","title":"\u5b89\u88c5","text":"<p><code>sozu</code> \u5df2\u53d1\u5e03\u5728 crates.io \u4e0a\u3002</p> <p>\u8981\u5b89\u88c5\u5b83\u4eec\uff0c\u60a8\u53ea\u9700\u6267\u884c <code>cargo install sozu</code>\u3002</p> <p>\u5b83\u4eec\u5c06\u88ab\u6784\u5efa\u5e76\u653e\u5728 <code>~/.cargo/bin</code> \u6587\u4ef6\u5939\u4e2d\u3002</p>"},{"location":"getting_started_zh/#_3","title":"\u4ece\u6e90\u4ee3\u7801\u6784\u5efa","text":"<p>\u6784\u5efa sozu \u53ef\u6267\u884c\u6587\u4ef6\u548c\u547d\u4ee4\u884c\uff1a</p> <p><code>cd bin &amp;&amp; cargo build --release --locked</code></p> <p><code>--release</code> \u53c2\u6570\u901a\u77e5 cargo \u5728\u7f16\u8bd1 sozu \u65f6\u542f\u7528\u4f18\u5316\u3002 \u4ec5\u4f7f\u7528 <code>--release</code> \u6765\u5236\u4f5c\u751f\u4ea7\u7248\u672c\u3002</p> <p><code>--locked</code> \u6807\u5fd7\u544a\u8bc9 cargo \u9075\u5faa <code>Cargo.lock</code> \u4e2d\u6307\u5b9a\u7684\u4f9d\u8d56\u9879\u7248\u672c \u5e76\u56e0\u6b64\u9632\u6b62\u4f9d\u8d56\u9879\u4e2d\u65ad\u3002</p>"},{"location":"how_to_use/","title":"How to use S\u014dzu","text":"<p>If you didn't take a look at the configure documentation, we advise you to do so because you will need to know what to put in your configuration file.</p>"},{"location":"how_to_use/#run-it","title":"Run it","text":"<p>If you used the <code>cargo install</code> way, <code>sozu</code> is already in your <code>$PATH</code>.</p> <pre><code>sozu start -c &lt;path/to/your/config.toml&gt;\n</code></pre> <p>However, if you built the project from source, <code>sozu</code> is placed in the <code>target</code> directory.</p> <pre><code>./target/release/sozu start -c &lt;path/to/your/config.toml&gt;\n</code></pre> <p><code>cargo build --release --locked</code> puts the resulting binary in <code>target/release</code> instead of <code>target/debug</code>.</p> <p>You can find a working <code>config.toml</code> example here.</p> <p>To start the reverse proxy:</p> <pre><code>sozu start -c config.toml\n</code></pre> <p>You can edit the reverse proxy's configuration with the <code>config.toml</code> file. You can declare new clusters, their frontends and backends through that file.</p> <p>But for more flexibility, you should use the command socket (you can find one end of that unix socket at the path designed by <code>command_socket</code> in the configuration file).</p> <p>You can use the <code>sozu</code> binary as a CLI to interact with the reverse proxy.</p> <p>Check out the command line documentation for more information.</p>"},{"location":"how_to_use/#run-it-with-docker","title":"Run it with Docker","text":"<p>The repository provides a multi-stage Dockerfile image based on <code>alpine:edge</code>.</p> <p>You can build the image by doing:</p> <pre><code>docker build -t sozu .\n</code></pre> <p>There's also the clevercloud/sozu image following the master branch (outdated).</p> <p>Run it with the command:</p> <pre><code>docker run \\\n  --ulimit nofile=262144:262144 \\\n  --name sozu-proxy \\\n  -v /run/sozu:/run/sozu \\\n  -v /path/to/config/file:/etc/sozu \\\n  -v /my/state/:/var/lib/sozu \\\n  -p 8080:80 \\\n  -p 8443:443 \\\n  sozu\n</code></pre> <p>To build an image with a specific version of Alpine:</p> <pre><code>docker build --build-arg ALPINE_VERSION=3.14 -t sozu:main-alpine-3.14 .\n</code></pre>"},{"location":"how_to_use/#using-a-custom-configtoml-configuration-file","title":"Using a custom <code>config.toml</code> configuration file","text":"<p>The default configuration for sozu can be found in <code>../os-build/docker/config.toml</code>. If <code>/my/custom/config.toml</code> is the path and name of your custom configuration file, you can start your sozu container with this in a volume to override the default configuration (note that only the directory path of the custom config file is used in this command):</p> <pre><code>docker run -v /my/custom:/etc/sozu sozu\n</code></pre>"},{"location":"how_to_use/#using-sozu-command-line-with-the-docker-container","title":"Using sozu command line with the docker container","text":"<p>To use <code>sozu</code> CLI from the host with the docker container you have to bind <code>/run/sozu</code> with the host by using a docker volume:</p> <pre><code>docker run -v /run/sozu:/run/sozu sozu\n</code></pre> <p>To change the path of the configuration socket, modify the <code>command_socket</code> option in the configuration file (default value is <code>/var/lib/sozu/sock</code>).</p>"},{"location":"how_to_use/#provide-an-initial-configuration-state","title":"Provide an initial configuration state","text":"<p>S\u014dzu can use a JSON file to load an initial configuration state for its routing. You can mount it by using a volume, you can start your sozu container with this in a volume (note that only the directory path of the custom config file is used in this command):</p> <pre><code>docker run -v /my/state:/var/lib/sozu sozu\n</code></pre> <p>To change the path of the saved state file, modify the <code>saved_state</code> option in the configuration file (default value is <code>/var/lib/sozu/state.json</code>).</p>"},{"location":"how_to_use/#systemd-integration","title":"Systemd integration","text":"<p>The repository provides a unit file here. You can copy it to <code>/etc/systemd/system/</code> and invoke <code>systemctl daemon-reload</code>.</p> <p>This will make systemd take notice of it, and now you can start the service with <code>systemctl start sozu.service</code>. Furthermore, you can enable it, so that it is activated by default on future boots with <code>systemctl enable sozu.service</code>.</p>"},{"location":"how_to_use_zh/","title":"\u5982\u4f55\u4f7f\u7528 S\u014dzu","text":"<p>\u5982\u679c\u60a8\u8fd8\u6ca1\u6709\u770b\u8fc7\u914d\u7f6e\u6587\u6863\uff0c\u6211\u4eec\u5efa\u8bae\u60a8\u5148\u770b\u4e00\u4e0b\uff0c\u56e0\u4e3a\u60a8\u9700\u8981\u77e5\u9053\u5728\u60a8\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u8981\u653e\u4e9b\u4ec0\u4e48\u3002</p>"},{"location":"how_to_use_zh/#_1","title":"\u8fd0\u884c\u5b83","text":"<p>\u5982\u679c\u60a8\u4f7f\u7528\u4e86 <code>cargo install</code> \u7684\u65b9\u5f0f\uff0c<code>sozu</code> \u5df2\u7ecf\u5728\u60a8\u7684 <code>$PATH</code> \u4e2d\u4e86\u3002</p> <pre><code>sozu start -c &lt;path/to/your/config.toml&gt;\n</code></pre> <p>\u4f46\u662f\uff0c\u5982\u679c\u60a8\u4ece\u6e90\u4ee3\u7801\u6784\u5efa\u9879\u76ee\uff0c<code>sozu</code> \u4f1a\u653e\u5728 <code>target</code> \u76ee\u5f55\u4e2d\u3002</p> <pre><code>./target/release/sozu start -c &lt;path/to/your/config.toml&gt;\n</code></pre> <p><code>cargo build --release --locked</code> \u4f1a\u5c06\u751f\u6210\u7684\u53ef\u6267\u884c\u6587\u4ef6\u653e\u5728 <code>target/release</code> \u800c\u4e0d\u662f <code>target/debug</code>\u3002</p> <p>\u60a8\u53ef\u4ee5\u5728\u8fd9\u91cc\u627e\u5230\u4e00\u4e2a\u53ef\u7528\u7684 <code>config.toml</code> \u793a\u4f8b\u3002</p> <p>\u8981\u542f\u52a8\u53cd\u5411\u4ee3\u7406\uff1a</p> <pre><code>sozu start -c config.toml\n</code></pre> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>config.toml</code> \u6587\u4ef6\u7f16\u8f91\u53cd\u5411\u4ee3\u7406\u7684\u914d\u7f6e\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u8be5\u6587\u4ef6\u58f0\u660e\u65b0\u7684\u96c6\u7fa4\u3001\u5b83\u4eec\u7684\u524d\u7aef\u548c\u540e\u7aef\u3002</p> <p>\u4f46\u662f\u4e3a\u4e86\u83b7\u5f97\u66f4\u5927\u7684\u7075\u6d3b\u6027\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528\u547d\u4ee4\u5957\u63a5\u5b57\uff08\u60a8\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u7531 <code>command_socket</code> \u6307\u5b9a\u7684\u8def\u5f84\u5904\u627e\u5230\u8be5 unix \u5957\u63a5\u5b57\u7684\u4e00\u7aef\uff09\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>sozu</code> \u53ef\u6267\u884c\u6587\u4ef6\u4f5c\u4e3a CLI \u4e0e\u53cd\u5411\u4ee3\u7406\u8fdb\u884c\u4ea4\u4e92\u3002</p> <p>\u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u67e5\u770b\u547d\u4ee4\u884c\u6587\u6863\u3002</p>"},{"location":"how_to_use_zh/#docker","title":"\u4f7f\u7528 Docker \u8fd0\u884c\u5b83","text":"<p>\u8be5\u4ed3\u5e93\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e <code>alpine:edge</code> \u7684\u591a\u9636\u6bb5 Dockerfile \u955c\u50cf\u3002</p> <p>\u60a8\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u6784\u5efa\u955c\u50cf\uff1a</p> <pre><code>docker build -t sozu .\n</code></pre> <p>\u8fd8\u6709\u4e00\u4e2a clevercloud/sozu \u955c\u50cf \u8ddf\u968f master \u5206\u652f\uff08\u5df2\u8fc7\u65f6\uff09\u3002</p> <p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8fd0\u884c\u5b83\uff1a</p> <pre><code>docker run \\\n  --ulimit nofile=262144:262144 \\\n  --name sozu-proxy \\\n  -v /run/sozu:/run/sozu \\\n  -v /path/to/config/file:/etc/sozu \\\n  -v /my/state/:/var/lib/sozu \\\n  -p 8080:80 \\\n  -p 8443:443 \\\n  sozu\n</code></pre> <p>\u8981\u6784\u5efa\u5177\u6709\u7279\u5b9a Alpine \u7248\u672c\u7684\u955c\u50cf\uff1a</p> <pre><code>docker build --build-arg ALPINE_VERSION=3.14 -t sozu:main-alpine-3.14 .\n</code></pre>"},{"location":"how_to_use_zh/#configtoml","title":"\u4f7f\u7528\u81ea\u5b9a\u4e49 <code>config.toml</code> \u914d\u7f6e\u6587\u4ef6","text":"<p>sozu \u7684\u9ed8\u8ba4\u914d\u7f6e\u53ef\u4ee5\u5728 <code>../os-build/docker/config.toml</code> \u4e2d\u627e\u5230\u3002 \u5982\u679c <code>/my/custom/config.toml</code> \u662f\u60a8\u7684\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f84\u548c\u540d\u79f0\uff0c\u60a8\u53ef\u4ee5\u5728\u5377\u4e2d\u542f\u52a8\u60a8\u7684 sozu \u5bb9\u5668\u4ee5\u8986\u76d6\u9ed8\u8ba4\u914d\u7f6e\uff08\u8bf7\u6ce8\u610f\uff0c\u6b64\u547d\u4ee4\u4e2d\u4ec5\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u5f55\u8def\u5f84\uff09\uff1a</p> <pre><code>docker run -v /my/custom:/etc/sozu sozu\n</code></pre>"},{"location":"how_to_use_zh/#docker-sozu","title":"\u5728 docker \u5bb9\u5668\u4e2d\u4f7f\u7528 sozu \u547d\u4ee4\u884c","text":"<p>\u8981\u4ece\u4e3b\u673a\u4f7f\u7528 <code>sozu</code> CLI \u4e0e docker \u5bb9\u5668\u4ea4\u4e92\uff0c\u60a8\u5fc5\u987b\u4f7f\u7528 docker \u5377\u5c06 <code>/run/sozu</code> \u4e0e\u4e3b\u673a\u7ed1\u5b9a\uff1a</p> <pre><code>docker run -v /run/sozu:/run/sozu sozu\n</code></pre> <p>\u8981\u66f4\u6539\u914d\u7f6e\u5957\u63a5\u5b57\u7684\u8def\u5f84\uff0c\u8bf7\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 <code>command_socket</code> \u9009\u9879\uff08\u9ed8\u8ba4\u503c\u4e3a <code>/var/lib/sozu/sock</code>\uff09\u3002</p>"},{"location":"how_to_use_zh/#_2","title":"\u63d0\u4f9b\u521d\u59cb\u914d\u7f6e\u72b6\u6001","text":"<p>S\u014dzu \u53ef\u4ee5\u4f7f\u7528 JSON \u6587\u4ef6\u4e3a\u5176\u8def\u7531\u52a0\u8f7d\u521d\u59cb\u914d\u7f6e\u72b6\u6001\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5377\u6765\u6302\u8f7d\u5b83\uff0c\u60a8\u53ef\u4ee5\u5728\u5377\u4e2d\u542f\u52a8\u60a8\u7684 sozu \u5bb9\u5668\uff08\u8bf7\u6ce8\u610f\uff0c\u6b64\u547d\u4ee4\u4e2d\u4ec5\u4f7f\u7528\u81ea\u5b9a\u4e49\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u5f55\u8def\u5f84\uff09\uff1a</p> <pre><code>docker run -v /my/state:/var/lib/sozu sozu\n</code></pre> <p>\u8981\u66f4\u6539\u5df2\u4fdd\u5b58\u72b6\u6001\u6587\u4ef6\u7684\u8def\u5f84\uff0c\u8bf7\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 <code>saved_state</code> \u9009\u9879\uff08\u9ed8\u8ba4\u503c\u4e3a <code>/var/lib/sozu/state.json</code>\uff09\u3002</p>"},{"location":"how_to_use_zh/#systemd","title":"Systemd \u96c6\u6210","text":"<p>\u8be5\u4ed3\u5e93\u5728\u8fd9\u91cc\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5355\u5143\u6587\u4ef6\u3002\u60a8\u53ef\u4ee5\u5c06\u5176\u590d\u5236\u5230 <code>/etc/systemd/system/</code> \u5e76\u8c03\u7528 <code>systemctl daemon-reload</code>\u3002</p> <p>\u8fd9\u5c06\u4f7f systemd \u6ce8\u610f\u5230\u5b83\uff0c\u73b0\u5728\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>systemctl start sozu.service</code> \u542f\u52a8\u670d\u52a1\u3002\u6b64\u5916\uff0c\u60a8\u53ef\u4ee5\u542f\u7528\u5b83\uff0c\u4ee5\u4fbf\u5728\u5c06\u6765\u7684\u542f\u52a8\u4e2d\u9ed8\u8ba4\u6fc0\u6d3b\u5b83\uff0c\u4f7f\u7528 <code>systemctl enable sozu.service</code>\u3002</p>"},{"location":"lexicon/","title":"Lexicon","text":"<p>What terms are used in S\u014dzu.</p>"},{"location":"lexicon/#user-facing","title":"User-facing","text":"<p>backend: a socket address towards which S\u014dzu will redirect traffic.</p> <p>cluster: a set of frontends, routing rules, and backends.</p> <p>frontend: a socket address on which a cluster receives connections. Should be defined with a matching listener.</p> <p>listener: a socket address on which S\u014dzu will accept incoming connections.</p> <p>worker: an instance of S\u014dzu, managed by the main process.</p>"},{"location":"lexicon/#under-the-hood","title":"Under the hood","text":"<p>session: smallest unit to handle the link between a frontend and a backend. There is roughly one session for each incoming request.</p> <p>proxy: a unit that handles all traffic for a given protocol. In each S\u014dzu server there is a TCP proxy, an HTTP proxy and an HTTPS proxy.</p>"},{"location":"lexicon_zh/","title":"\u8bcd\u6c47\u8868","text":"<p>S\u014dzu \u4e2d\u4f7f\u7528\u7684\u672f\u8bed\u3002</p>"},{"location":"lexicon_zh/#_2","title":"\u9762\u5411\u7528\u6237","text":"<p>\u540e\u7aef\uff1aS\u014dzu \u5c06\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u7684\u5957\u63a5\u5b57\u5730\u5740\u3002</p> <p>\u96c6\u7fa4\uff1a\u4e00\u7ec4\u524d\u7aef\u3001\u8def\u7531\u89c4\u5219\u548c\u540e\u7aef\u3002</p> <p>\u524d\u7aef\uff1a\u96c6\u7fa4\u63a5\u6536\u8fde\u63a5\u7684\u5957\u63a5\u5b57\u5730\u5740\u3002\u5e94\u4e0e\u5339\u914d\u7684\u4fa6\u542c\u5668\u4e00\u8d77\u5b9a\u4e49\u3002</p> <p>\u4fa6\u542c\u5668\uff1aS\u014dzu \u5c06\u63a5\u53d7\u4f20\u5165\u8fde\u63a5\u7684\u5957\u63a5\u5b57\u5730\u5740\u3002</p> <p>\u5de5\u4f5c\u8fdb\u7a0b\uff1aS\u014dzu \u7684\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u7531\u4e3b\u8fdb\u7a0b\u7ba1\u7406\u3002</p>"},{"location":"lexicon_zh/#_3","title":"\u5e55\u540e","text":"<p>\u4f1a\u8bdd\uff1a\u5904\u7406\u524d\u7aef\u548c\u540e\u7aef\u4e4b\u95f4\u94fe\u63a5\u7684\u6700\u5c0f\u5355\u4f4d\u3002\u6bcf\u4e2a \u4f20\u5165\u8bf7\u6c42\u5927\u7ea6\u6709\u4e00\u4e2a\u4f1a\u8bdd\u3002</p> <p>\u4ee3\u7406\uff1a\u5904\u7406\u7ed9\u5b9a\u534f\u8bae\u7684\u6240\u6709\u6d41\u91cf\u7684\u5355\u5143\u3002\u6bcf\u4e2a S\u014dzu \u670d\u52a1\u5668\u4e2d\u90fd\u6709\u4e00\u4e2a TCP \u4ee3\u7406\u3001 \u4e00\u4e2a HTTP \u4ee3\u7406\u548c\u4e00\u4e2a HTTPS \u4ee3\u7406\u3002</p>"},{"location":"lifetime_of_a_session/","title":"Lifetime of a session","text":"<p>A session is the core unit of S\u014dzu's business logic: forwarding traffic from a frontend to a backend and vice-versa.</p> <p>In this document, we will explore what happens to a client session, from the creation of the socket, to its shutdown, with all the steps describing how the HTTP request and response can happen</p> <p>Before we dive into the creation, lifetime and death of sessions, we need to understand two concepts that are entirely segregated in S\u014dzu:</p> <ul> <li>the socket handling with the mio crate</li> <li>the <code>SessionManager</code> that keeps track of all sessions</li> </ul>"},{"location":"lifetime_of_a_session/#what-does-mio-do","title":"What does mio do?","text":"<p>Mio allows us to listen on socket events. For instance we may use TCP sockets to wait for connection and mio informs us when that socket is readable or when a socket has data to read, or was closed by the peer, or a timer triggered...</p> <p>Mio provides an abstraction over the linux syscall epoll. This epoll syscall allows us to register file descriptors, so that the kernel notifies us whenever something happens to those file descriptors</p> <p>At the end of the day, sockets are just raw file descriptors. We use the mio <code>TcpListener</code>, <code>TcpStream</code> wrappers around these file descriptors. A <code>TcpListener</code> listens for connections on a specific port. For each new connection it creates a <code>TcpStream</code> on which subsequent traffic will be redirected (both from and to the client).</p> <p>This is all what we use mio for. \"Subscribing\" to file descriptors events.</p>"},{"location":"lifetime_of_a_session/#keep-track-of-sessions-with-the-sessionmanager","title":"Keep track of sessions with the SessionManager","text":"<p>Each subscription in mio is associated with a Token (a u64 identifier). The SessionManager's job is to link a Token to a <code>ProxySession</code> that will make use of the subscription. This is done with a Slab, a key-value data structure which optimizes memory usage:</p> <ul> <li>as a key: the Token provided by mio</li> <li>as a value: a reference to a <code>ProxySession</code></li> </ul> <p>That being said let's dive into the lifetime of a session.</p>"},{"location":"lifetime_of_a_session/#what-are-proxys","title":"What are Proxys?","text":"<p>A S\u014dzu worker internally has 3 proxys, one for each supported protocol:</p> <ul> <li>TCP</li> <li>HTTP</li> <li>HTTPS</li> </ul> <p>A proxy manages listeners, frontends, backends and the business logic associated with each protocol (buffering, parsing, error handling...).</p>"},{"location":"lifetime_of_a_session/#accepting-a-connection","title":"Accepting a connection","text":"<p>S\u014dzu uses TCP listener sockets to get new connections. It will typically listen on ports 80 (HTTP) and 443 (HTTPS), but could have other ports for TCP proxying, or even HTTP/HTTPS proxys on other ports.</p> <p>For each frontend, S\u014dzu:</p> <ol> <li>generate a new Token token</li> <li>uses mio to register a <code>TcpListener</code> as token</li> <li>adds a matching <code>ListenSession</code> in the <code>SessionManager</code> with key token</li> <li>stores the <code>TcpListener</code> in the appropriate Proxy (TCP/HTTP/HTTPS) with key token</li> </ol>"},{"location":"lifetime_of_a_session/#an-event-loop-on-tcp-sockets","title":"An event loop on TCP sockets","text":"<p>S\u014dzu is hot reconfigurable. We can add listeners and frontends at runtime. For each added listener, the SessionManager will store a <code>ListenSession</code> in its Slab.</p> <p>The event loop uses mio to check for any activity, on all sockets. Whenever mio detects activity on a socket, it returns an event that is passed to the <code>SessionManager</code>.</p> <p>Whenever a client connects to a frontend: 1. it reaches a listener 2. S\u014dzu is notified by mio that a <code>readable</code> event was received on a specific Token 3. using the SessionManager, S\u014dzu gets the corresponding <code>ListenSession</code> 4. S\u014dzu determines the protocol that was used 5. the Token is passed down to the appropriate proxy (TCP/HTTP/HTTPS) 6. using the Token, the proxy determines which <code>TcpListener</code> triggered the event 7. the proxy starts accepting new connections from it in a loop (as their might be more than one)</p> <p>Accepting a connection means to store it as a <code>TcpStream</code> in the accept queue, until either:</p> <ul> <li>there are no more connections to accept</li> <li>or the accept queue is full: https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/server.rs#L1204-L1258</li> </ul>"},{"location":"lifetime_of_a_session/#consuming-the-accept-queue","title":"Consuming the accept queue","text":"<p>We create sessions from the accept queue, starting from the most recent session, and dropping sockets that are too old.</p> <p>When we accept a new connection (<code>TcpStream</code>), it might have waited a bit already in the listener queue. The kernel might even already have some data available, like an HTTP request. If we are too slow in handling that request, the client might have dropped the connection (timeout) by the time we forward the request to the backend and the backend responds.</p> <p>If the maximum number of client connections (provided by <code>max_connections</code> in the configuration) is reached, new ones stay in the queue. And if the queue is full, we drop newly accepted connections. By specifying a maximum number of concurrent connections, we make sure that the server does not get overloaded and keep latencies manageable for existing connections.</p>"},{"location":"lifetime_of_a_session/#creating-sessions","title":"Creating sessions","text":"<p>A session's goal is to forward traffic from a frontend to a backend and vice-versa. The <code>Session</code> struct holds the data associated with a session: tokens, current timeout state, protocol state, client address... The created session is wrapped in a <code>Rc&lt;RefCell&lt;...&gt;&gt;</code></p> <p>The proxies create one session for each item of the accept queue, using the <code>TcpStream</code> provided in the item. The <code>TcpStream</code> is registered in mio with a new Token (called frontend_token). The Session is added in the SessionManager with the same Token.</p>"},{"location":"lifetime_of_a_session/#check-for-zombie-sessions","title":"Check for zombie sessions","text":"<p>Because bugs can occur when sessions are created and removed, and some of them could be \"forgotten\", there's a regular task called \"zombie checker\" that checks on the sessions in the list and kills those that are stuck or too old.</p>"},{"location":"lifetime_of_a_session/#how-a-session-reads-data-from-the-front-socket","title":"How a Session reads data from the front socket","text":"<p>When data arrives from the network on the <code>TcpStream</code>, it is stored in a kernel buffer, and the kernel notifies the event loop that the socket is readable.</p> <p>As with listen sockets, the token associated with the TCP socket will get a \"readable\" event, and we will use the token to lookup which session it is associated with. We then call <code>Session::update_readiness</code> to notify it of the new socket state.</p> <p>Then we call <code>Session::ready</code> to let it read data, parse, etc. That method will run in a loop (https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/https_openssl.rs#L548-L692),</p>"},{"location":"lifetime_of_a_session/#bring-in-the-state-machine","title":"Bring in the state machine","text":"<p>The <code>Session::readable</code> method of the session is called. It will then call that same method of the underlying state machine.</p> <p>The state machine is where the protocols are implemented. A session might need to recognize different protocols over its lifetime, depending on its configuration, and upgrade between them. They are all in the protocol directory.</p> <p>Example: - an HTTPS session could start in a state called <code>ExpectProxyProtocol</code> - once the expect protocol has run its course, the session upgrades to the TLS handshake state: <code>HandShake</code> - once the handshake is done, we have a TLS stream, and the session upgrades to the <code>HTTP</code> state - if required by the client, the session can then switch to a WebSocket connection: <code>WebSocket</code></p> <p>Now, let's assume we are currently using the HTTP 1 protocol. The session called the <code>readable()</code> method.</p>"},{"location":"lifetime_of_a_session/#find-the-backend","title":"Find the backend","text":"<p>We need to parse the HTTP request to find out its:</p> <ol> <li>hostname</li> <li>path</li> <li>HTTP verb</li> </ol> <p>We will first try to read data from the socket in the front buffer. If there were no errors (closed socket, etc), we will then handle that data in <code>readable_parse()</code>.</p> <p>The HTTP implementation holds two smaller state machines, <code>RequestState</code> and <code>ResponseState</code>, that indicate where we are in parsing the request or response, and store data about them.</p> <p>When we receive the first byte from the client, both are at the <code>Initial</code> state. We parse data from the front buffer until we reach a request state where the headers are entirely parsed. If there was not enough data, we'll wait for more data to come on the socket and restart parsing.</p> <p>Once we're done parsing the headers, and find what we were looking for, we will return SessionResult::ConnectBackend to notify the session that it should find a backend server to send the data.</p>"},{"location":"lifetime_of_a_session/#connect-to-the-backend-servers","title":"Connect to the backend servers","text":"<p>The Session: 1. finds which cluster to connect to 2. asks the SessionManager for a new valid Token named <code>back_token</code> 3. asks for a connection to the cluster    - the appropriate Proxy finds a backend (add details) 4. registers the new <code>TcpStream</code> in mio with <code>back_token</code> 5. inserts itself in the SessionManager with <code>back_token</code></p> <p>The same session is now stored twice in the SessionManager:</p> <ol> <li>once with the front token as key</li> <li>secondly with the back token as key</li> </ol> <p>If S\u014dzu can't find a cluster it responds with a default HTTP 404 Not Found response to the client. A session can try to connect to a backend 3 times. If all attempts fail, S\u014dzu responds with a default HTTP 503 Service Unavailable response. This happens if S\u014dzu found a cluster, but all corresponding backends are down (or not responding).</p>"},{"location":"lifetime_of_a_session/#keep-a-session-alive","title":"Keep a session alive","text":"<p>In case an HTTP request comes with the Connection header set at Keep-Alive, the underlying TCP connection can be kept after receiving the response, to send more requests. Since S\u014dzu supports routing on the URL along with the hostname, the next request might go to a different cluster. So when we get the cluster id from the request, we check if it is the same as the previous one, and if it is the same, we test if the back socket is still valid. If it is, we can reuse it. Otherwise, we will replace the back socket with a new one.</p>"},{"location":"lifetime_of_a_session/#sticky-session-stick-a-front-to-one-backend-only","title":"Sticky session: stick a front to one backend only","text":"<p>This is a routing mechanism where we look at a cookie in the request. All requests coming with the same id in that cookie will be sent to the same backend server.</p> <p>That look up will return a result depending on which backend server are considered valid (if they're answering properly) and on the load balancing policies configured for the cluster. If a backend was found, we open a TCP connection to the backend server, otherwise we return a HTTP 503 response.</p>"},{"location":"lifetime_of_a_session/#sending-data-to-the-back-socket","title":"Sending data to the back socket","text":"<p>Then we wait for a writable event from the backend connection, then we can start to forward the pending request to it. In case of an error, we retry to connect to another backend server in the same Cluster.</p>"},{"location":"lifetime_of_a_session/#the-big-u-turn-forwarding-from-backend-to-frontend","title":"The big U-turn: forwarding from backend to frontend","text":"<p>As explained above, we have a small state machine called <code>ResponseState</code> in order to parse the traffic from the backend. The whole logic is basically the same.</p> <p>We monitor backend readability and frontend writability, and transfer traffic from one to the other.</p>"},{"location":"lifetime_of_a_session/#the-end-of-a-session","title":"The end of a session","text":"<p>Once the <code>ResponseState</code> reaches a \"completed\" state and every byte has been sent back to the client, the full life cycle of a request ends. The session reaches the <code>CloseSession</code> state and is removed from the <code>SessionManager</code>'s slab and its sockets are deregistered from mio.</p> <p>If the request had a Keep-Alive header, however, the session will be reused and await a new request. This is the \"reset\" of a session.</p>"},{"location":"lifetime_of_a_session_zh/","title":"\u4f1a\u8bdd\u7684\u751f\u547d\u5468\u671f","text":"<p>\u4f1a\u8bdd\u662f S\u014dzu \u4e1a\u52a1\u903b\u8f91\u7684\u6838\u5fc3\u5355\u5143\uff1a\u5c06\u6d41\u91cf\u4ece \u524d\u7aef\u8f6c\u53d1\u5230\u540e\u7aef\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002</p> <p>\u5728\u672c\u6587\u6863\u4e2d\uff0c\u6211\u4eec\u5c06\u63a2\u8ba8\u5ba2\u6237\u7aef\u4f1a\u8bdd\u4ece\u5957\u63a5\u5b57 \u521b\u5efa\u5230\u5173\u95ed\u7684\u6574\u4e2a\u8fc7\u7a0b\uff0c\u4ee5\u53ca\u63cf\u8ff0 HTTP \u8bf7\u6c42\u548c\u54cd\u5e94\u5982\u4f55\u53d1\u751f\u7684\u6240\u6709\u6b65\u9aa4\u3002</p> <p>\u5728\u6df1\u5165\u63a2\u8ba8\u4f1a\u8bdd\u7684\u521b\u5efa\u3001\u751f\u547d\u5468\u671f\u548c\u6d88\u4ea1\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981 \u4e86\u89e3 S\u014dzu \u4e2d\u5b8c\u5168\u5206\u79bb\u7684\u4e24\u4e2a\u6982\u5ff5\uff1a</p> <ul> <li>\u4f7f\u7528 mio crate \u5904\u7406\u5957\u63a5\u5b57</li> <li><code>SessionManager</code> \u8ddf\u8e2a\u6240\u6709\u4f1a\u8bdd</li> </ul>"},{"location":"lifetime_of_a_session_zh/#mio","title":"mio \u505a\u4ec0\u4e48\uff1f","text":"<p>Mio \u5141\u8bb8\u6211\u4eec\u76d1\u542c\u5957\u63a5\u5b57\u4e8b\u4ef6\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 TCP \u5957\u63a5\u5b57 \u7b49\u5f85\u8fde\u63a5\uff0c\u5f53\u8be5\u5957\u63a5\u5b57\u53ef\u8bfb\u6216\u5f53\u5957\u63a5\u5b57\u6709 \u6570\u636e\u8981\u8bfb\u53d6\uff0c\u6216\u88ab\u5bf9\u7b49\u65b9\u5173\u95ed\uff0c\u6216\u8ba1\u65f6\u5668\u89e6\u53d1\u65f6\uff0cmio \u4f1a\u901a\u77e5\u6211\u4eec...</p> <p>Mio \u63d0\u4f9b\u4e86\u5bf9 linux \u7cfb\u7edf\u8c03\u7528 epoll \u7684\u62bd\u8c61\u3002 \u6b64 epoll \u7cfb\u7edf\u8c03\u7528\u5141\u8bb8\u6211\u4eec\u6ce8\u518c\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u4ee5\u4fbf\u5185\u6838\u5728 \u8fd9\u4e9b\u6587\u4ef6\u63cf\u8ff0\u7b26\u53d1\u751f\u4efb\u4f55\u4e8b\u60c5\u65f6\u901a\u77e5\u6211\u4eec\u3002</p> <p>\u5f52\u6839\u7ed3\u5e95\uff0c\u5957\u63a5\u5b57\u53ea\u662f\u539f\u59cb\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u6211\u4eec\u4f7f\u7528 mio <code>TcpListener</code>\u3001<code>TcpStream</code> \u5305\u88c5\u5668\u6765\u5305\u88c5\u8fd9\u4e9b\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002<code>TcpListener</code> \u5728\u7279\u5b9a\u7aef\u53e3\u4e0a\u4fa6\u542c\u8fde\u63a5\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u65b0\u8fde\u63a5\uff0c\u5b83\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a <code>TcpStream</code>\uff0c\u540e\u7eed\u6d41\u91cf\u5c06\u91cd\u5b9a\u5411\u5230\u8be5 <code>TcpStream</code>\uff08\u6765\u81ea\u5ba2\u6237\u7aef\u548c\u5230\u5ba2\u6237\u7aef\uff09\u3002</p> <p>\u8fd9\u5c31\u662f\u6211\u4eec\u4f7f\u7528 mio \u7684\u5168\u90e8\u76ee\u7684\u3002\u201c\u8ba2\u9605\u201d\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e8b\u4ef6\u3002</p>"},{"location":"lifetime_of_a_session_zh/#sessionmanager","title":"\u4f7f\u7528 SessionManager \u8ddf\u8e2a\u4f1a\u8bdd","text":"<p>mio \u4e2d\u7684\u6bcf\u4e2a\u8ba2\u9605\u90fd\u4e0e\u4e00\u4e2a Token\uff08\u4e00\u4e2a u64 \u6807\u8bc6\u7b26\uff09\u76f8\u5173\u8054\u3002SessionManager \u7684 \u5de5\u4f5c\u662f\u5c06 Token \u94fe\u63a5\u5230\u4e00\u4e2a\u5c06\u4f7f\u7528\u8be5\u8ba2\u9605\u7684 <code>ProxySession</code>\u3002 \u8fd9\u662f\u4f7f\u7528 Slab \u5b8c\u6210\u7684\uff0cSlab \u662f\u4e00\u4e2a\u4f18\u5316\u5185\u5b58\u4f7f\u7528\u7684\u952e\u503c\u6570\u636e\u7ed3\u6784\uff1a</p> <ul> <li>\u4f5c\u4e3a\u952e\uff1amio \u63d0\u4f9b\u7684 Token</li> <li>\u4f5c\u4e3a\u503c\uff1a\u5bf9 <code>ProxySession</code> \u7684\u5f15\u7528</li> </ul> <p>\u8bdd\u867d\u5982\u6b64\uff0c\u8ba9\u6211\u4eec\u6df1\u5165\u63a2\u8ba8\u4f1a-\u8bdd\u7684\u751f\u547d\u5468\u671f\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_2","title":"\u4ee3\u7406\u662f\u4ec0\u4e48\uff1f","text":"<p>S\u014dzu\u5de5\u4f5c\u8fdb\u7a0b\u5185\u90e8\u67093\u4e2a\u4ee3\u7406\uff0c\u6bcf\u4e2a\u652f\u6301\u7684\u534f\u8bae\u4e00\u4e2a\uff1a</p> <ul> <li>TCP</li> <li>HTTP</li> <li>HTTPS</li> </ul> <p>\u4ee3\u7406\u7ba1\u7406\u4fa6\u542c\u5668\u3001\u524d\u7aef\u3001\u540e\u7aef\u4ee5\u53ca\u4e0e \u6bcf\u4e2a\u534f\u8bae\u76f8\u5173\u7684\u4e1a\u52a1\u903b\u8f91\uff08\u7f13\u51b2\u3001\u89e3\u6790\u3001\u9519\u8bef\u5904\u7406...\uff09\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_3","title":"\u63a5\u53d7\u8fde\u63a5","text":"<p>S\u014dzu \u4f7f\u7528 TCP \u4fa6\u542c\u5668\u5957\u63a5\u5b57\u6765\u83b7\u53d6\u65b0\u8fde\u63a5\u3002\u5b83\u901a\u5e38\u4f1a\u4fa6\u542c \u7aef\u53e3 80\uff08HTTP\uff09\u548c 443\uff08HTTPS\uff09\uff0c\u4f46\u4e5f\u53ef\u80fd\u6709\u5176\u4ed6\u7528\u4e8e TCP \u4ee3\u7406\u7684\u7aef\u53e3\uff0c \u751a\u81f3\u5728\u5176\u4ed6\u7aef\u53e3\u4e0a\u6709 HTTP/HTTPS \u4ee3\u7406\u3002</p> <p>\u5bf9\u4e8e\u6bcf\u4e2a\u524d\u7aef\uff0cS\u014dzu\uff1a</p> <ol> <li>\u751f\u6210\u4e00\u4e2a\u65b0\u7684 Token token</li> <li>\u4f7f\u7528 mio \u5c06 <code>TcpListener</code> \u6ce8\u518c\u4e3a token</li> <li>\u5728 <code>SessionManager</code> \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u5339\u914d\u7684 <code>ListenSession</code>\uff0c\u952e\u4e3a token</li> <li>\u5c06 <code>TcpListener</code> \u5b58\u50a8\u5728\u9002\u5f53\u7684\u4ee3\u7406\uff08TCP/HTTP/HTTPS\uff09\u4e2d\uff0c\u952e\u4e3a token</li> </ol>"},{"location":"lifetime_of_a_session_zh/#tcp","title":"TCP \u5957\u63a5\u5b57\u4e0a\u7684\u4e8b\u4ef6\u5faa\u73af","text":"<p>S\u014dzu \u53ef\u70ed\u91cd\u65b0\u914d\u7f6e\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u6dfb\u52a0\u4fa6\u542c\u5668\u548c\u524d\u7aef\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u6dfb\u52a0\u7684\u4fa6\u542c\u5668\uff0c SessionManager \u5c06\u5728\u5176 Slab \u4e2d\u5b58\u50a8\u4e00\u4e2a <code>ListenSession</code>\u3002</p> <p>\u4e8b\u4ef6\u5faa\u73af \u4f7f\u7528 mio \u68c0\u67e5\u6240\u6709\u5957\u63a5\u5b57\u4e0a\u7684\u4efb\u4f55\u6d3b\u52a8\u3002 \u6bcf\u5f53 mio \u5728\u5957\u63a5\u5b57\u4e0a\u68c0\u6d4b\u5230\u6d3b\u52a8\u65f6\uff0c\u5b83\u90fd\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4f20\u9012\u7ed9 <code>SessionManager</code> \u7684\u4e8b\u4ef6\u3002</p> <p>\u6bcf\u5f53\u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u524d\u7aef\u65f6\uff1a 1. \u5b83\u5230\u8fbe\u4e00\u4e2a\u4fa6\u542c\u5668 2. S\u014dzu \u6536\u5230 mio \u7684\u901a\u77e5\uff0c\u5373\u5728\u7279\u5b9a Token \u4e0a\u6536\u5230\u4e86\u4e00\u4e2a <code>readable</code> \u4e8b\u4ef6 3. \u4f7f\u7528 SessionManager\uff0cS\u014dzu \u83b7\u53d6\u76f8\u5e94\u7684 <code>ListenSession</code> 4. S\u014dzu \u786e\u5b9a\u4f7f\u7528\u7684\u534f\u8bae 5. Token \u88ab\u4f20\u9012\u7ed9\u9002\u5f53\u7684\u4ee3\u7406\uff08TCP/HTTP/HTTPS\uff09 6. \u4f7f\u7528 Token\uff0c\u4ee3\u7406\u786e\u5b9a\u54ea\u4e2a <code>TcpListener</code> \u89e6\u53d1\u4e86\u4e8b\u4ef6 7. \u4ee3\u7406\u5f00\u59cb\u5728\u4e00\u4e2a\u5faa\u73af\u4e2d\u4ece\u4e2d\u63a5\u53d7\u65b0\u8fde\u63a5\uff08\u56e0\u4e3a\u53ef\u80fd\u4e0d\u6b62\u4e00\u4e2a\uff09</p> <p>\u63a5\u53d7\u8fde\u63a5\u610f\u5473\u7740\u5c06\u5176\u4f5c\u4e3a <code>TcpStream</code> \u5b58\u50a8\u5728\u63a5\u53d7\u961f\u5217\u4e2d\uff0c\u76f4\u5230\uff1a</p> <ul> <li>\u6ca1\u6709\u66f4\u591a\u8fde\u63a5\u8981\u63a5\u53d7</li> <li>\u6216\u8005\u63a5\u53d7\u961f\u5217\u5df2\u6ee1\uff1ahttps://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src/server.rs#L1204-L1258</li> </ul>"},{"location":"lifetime_of_a_session_zh/#_4","title":"\u6d88\u8017\u63a5\u53d7\u961f\u5217","text":"<p>\u6211\u4eec\u4ece\u63a5\u53d7\u961f\u5217\u521b\u5efa\u4f1a\u8bdd\uff0c\u4ece \u6700\u65b0\u4f1a\u8bdd\u5f00\u59cb\uff0c\u5e76\u4e22\u5f03\u592a\u65e7\u7684\u5957\u63a5\u5b57\u3002</p> <p>\u5f53\u6211\u4eec\u63a5\u53d7\u4e00\u4e2a\u65b0\u8fde\u63a5\uff08<code>TcpStream</code>\uff09\u65f6\uff0c\u5b83\u53ef\u80fd\u5df2\u7ecf\u5728 \u4fa6\u542c\u5668\u961f\u5217\u4e2d\u7b49\u5f85\u4e86\u4e00\u6bb5\u65f6\u95f4\u3002\u5185\u6838\u751a\u81f3\u53ef\u80fd\u5df2\u7ecf\u6709\u4e00\u4e9b\u53ef\u7528\u7684\u6570\u636e\uff0c \u4f8b\u5982 HTTP \u8bf7\u6c42\u3002\u5982\u679c\u6211\u4eec\u5904\u7406\u8be5\u8bf7\u6c42\u592a\u6162\uff0c\u5ba2\u6237\u7aef\u53ef\u80fd \u5728\u6211\u4eec\u5c06\u4f1a\u8bdd\u8f6c\u53d1\u5230 \u540e\u7aef\u5e76\u4e14\u540e\u7aef\u54cd\u5e94\u65f6\u5df2\u7ecf\u65ad\u5f00\u8fde\u63a5\uff08\u8d85\u65f6\uff09\u3002</p> <p>\u5982\u679c\u8fbe\u5230\u6700\u5927\u5ba2\u6237\u7aef\u8fde\u63a5\u6570\uff08\u7531\u914d\u7f6e\u4e2d\u7684 <code>max_connections</code> \u63d0\u4f9b\uff09\uff0c \u65b0\u7684\u8fde\u63a5\u5c06\u4fdd\u7559\u5728\u961f\u5217\u4e2d\u3002 \u5982\u679c\u961f\u5217\u5df2\u6ee1\uff0c\u6211\u4eec\u5c06\u4e22\u5f03\u65b0\u63a5\u53d7\u7684\u8fde\u63a5\u3002 \u901a\u8fc7\u6307\u5b9a\u6700\u5927\u5e76\u53d1\u8fde\u63a5\u6570\uff0c\u6211\u4eec\u786e\u4fdd \u670d\u52a1\u5668\u4e0d\u4f1a\u8fc7\u8f7d\u5e76\u4e3a\u73b0\u6709 \u8fde\u63a5\u4fdd\u6301\u53ef\u7ba1\u7406\u7684\u5ef6\u8fdf\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_5","title":"\u521b\u5efa\u4f1a\u8bdd","text":"<p>\u4f1a\u8bdd\u7684\u76ee\u6807\u662f\u5c06\u6d41\u91cf\u4ece\u524d\u7aef\u8f6c\u53d1\u5230\u540e\u7aef\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002 <code>Session</code> \u7ed3\u6784\u4fdd\u5b58\u4e0e \u4f1a\u8bdd\u76f8\u5173\u7684\u6570\u636e\uff1a \u4ee4\u724c\u3001\u5f53\u524d\u8d85\u65f6\u72b6\u6001\u3001\u534f\u8bae\u72b6\u6001\u3001\u5ba2\u6237\u7aef\u5730\u5740... \u521b\u5efa\u7684\u4f1a\u8bdd\u88ab\u5305\u88c5\u5728\u4e00\u4e2a <code>Rc&lt;RefCell&lt;...&gt;&gt;</code> \u4e2d</p> <p>\u4ee3\u7406\u4e3a\u63a5\u53d7\u961f\u5217\u7684\u6bcf\u4e2a\u9879\u76ee\u521b\u5efa\u4e00\u4e2a\u4f1a\u8bdd\uff0c \u4f7f\u7528\u9879\u76ee\u4e2d\u63d0\u4f9b\u7684 <code>TcpStream</code>\u3002 <code>TcpStream</code> \u5728 mio \u4e2d\u6ce8\u518c\u4e00\u4e2a\u65b0\u4ee4\u724c\uff08\u79f0\u4e3a frontend_token\uff09\u3002 \u4f1a\u8bdd\u4ee5\u76f8\u540c\u7684\u4ee4\u724c\u6dfb\u52a0\u5230 SessionManager \u4e2d\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_6","title":"\u68c0\u67e5\u50f5\u5c38\u4f1a\u8bdd","text":"<p>\u56e0\u4e3a\u5728\u521b\u5efa\u548c\u5220\u9664\u4f1a\u8bdd\u65f6\u53ef\u80fd\u4f1a\u53d1\u751f\u9519\u8bef\uff0c\u5e76\u4e14\u5176\u4e2d\u4e00\u4e9b \u53ef\u80fd\u4f1a\u88ab\u201c\u9057\u5fd8\u201d\uff0c\u6240\u4ee5\u6709\u4e00\u4e2a\u540d\u4e3a \u201c\u50f5\u5c38\u68c0\u67e5\u5668\u201d \u7684\u5e38\u89c4\u4efb\u52a1\uff0c\u5b83\u4f1a\u68c0\u67e5\u5217\u8868\u4e2d\u7684\u4f1a\u8bdd\u5e76\u7ec8\u6b62\u90a3\u4e9b\u5361\u4f4f\u6216\u592a\u65e7\u7684\u4f1a\u8bdd\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_7","title":"\u4f1a\u8bdd\u5982\u4f55\u4ece\u524d\u7aef\u5957\u63a5\u5b57\u8bfb\u53d6\u6570\u636e","text":"<p>\u5f53\u6570\u636e\u4ece\u7f51\u7edc\u5230\u8fbe <code>TcpStream</code> \u65f6\uff0c\u5b83\u4f1a\u5b58\u50a8\u5728\u5185\u6838 \u7f13\u51b2\u533a\u4e2d\uff0c\u5e76\u4e14\u5185\u6838\u4f1a\u901a\u77e5\u4e8b\u4ef6\u5faa\u73af\u5957\u63a5\u5b57\u662f\u53ef\u8bfb\u7684\u3002</p> <p>\u4e0e\u4fa6\u542c\u5957\u63a5\u5b57\u4e00\u6837\uff0c\u4e0e TCP \u5957\u63a5\u5b57\u5173\u8054\u7684\u4ee4\u724c\u5c06\u83b7\u5f97\u4e00\u4e2a \u201c\u53ef\u8bfb\u201d\u4e8b\u4ef6\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u8be5\u4ee4\u724c\u67e5\u627e\u5b83\u4e0e\u54ea\u4e2a\u4f1a\u8bdd \u76f8\u5173\u8054\u3002\u7136\u540e\u6211\u4eec\u8c03\u7528 <code>Session::update_readiness</code> \u901a\u77e5\u5b83\u65b0\u7684 \u5957\u63a5\u5b57\u72b6\u6001\u3002</p> <p>\u7136\u540e\u6211\u4eec\u8c03\u7528 <code>Session::ready</code> \u8ba9\u5b83\u8bfb\u53d6\u6570\u636e\u3001\u89e3\u6790\u7b49\u3002 \u8be5\u65b9\u6cd5\u5c06\u5728\u4e00\u4e2a\u5faa\u73af\u4e2d\u8fd0\u884c (https://github.com/sozu-proxy/sozu/blob/e4e7488232ad6523791b94ad201239bcf7eb9b30/lib/src_httpssl.rs#L548-L692),</p>"},{"location":"lifetime_of_a_session_zh/#_8","title":"\u5f15\u5165\u72b6\u6001\u673a","text":"<p>\u4f1a\u8bdd\u7684 <code>Session::readable</code> \u65b9\u6cd5 \u88ab\u8c03\u7528\u3002\u7136\u540e\u5b83\u5c06\u8c03\u7528\u5e95\u5c42 \u72b6\u6001\u673a \u7684\u76f8\u540c\u65b9\u6cd5\u3002</p> <p>\u72b6\u6001\u673a\u662f\u5b9e\u73b0\u534f\u8bae\u7684\u5730\u65b9\u3002\u4f1a\u8bdd\u53ef\u80fd\u9700\u8981 \u5728\u5176\u751f\u547d\u5468\u671f\u5185\u8bc6\u522b\u4e0d\u540c\u7684\u534f\u8bae\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u5176\u914d\u7f6e\uff0c \u5e76\u5728\u5b83\u4eec\u4e4b\u95f4\u8fdb\u884c\u5347\u7ea7\u3002\u5b83\u4eec\u90fd\u5728\u534f\u8bae\u76ee\u5f55\u4e2d\u3002</p> <p>\u793a\u4f8b\uff1a - HTTPS \u4f1a\u8bdd\u53ef\u4ee5\u4ece\u4e00\u4e2a\u540d\u4e3a <code>ExpectProxyProtocol</code> \u7684\u72b6\u6001\u5f00\u59cb - \u4e00\u65e6 expect \u534f\u8bae\u8fd0\u884c\u5b8c\u6bd5\uff0c\u4f1a\u8bdd\u5c31\u4f1a\u5347\u7ea7\u5230 TLS \u63e1\u624b\u72b6\u6001\uff1a<code>HandShake</code> - \u63e1\u624b\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u6709\u4e00\u4e2a TLS \u6d41\uff0c\u5e76\u4e14\u4f1a\u8bdd\u5347\u7ea7\u5230 <code>HTTP</code> \u72b6\u6001 - \u5982\u679c\u5ba2\u6237\u7aef\u8981\u6c42\uff0c\u4f1a\u8bdd\u53ef\u4ee5\u5207\u6362\u5230 WebSocket \u8fde\u63a5\uff1a<code>WebSocket</code></p> <p>\u73b0\u5728\uff0c\u5047\u8bbe\u6211\u4eec\u5f53\u524d\u6b63\u5728\u4f7f\u7528 HTTP 1 \u534f\u8bae\u3002\u4f1a\u8bdd\u8c03\u7528 <code>readable()</code> \u65b9\u6cd5\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_9","title":"\u67e5\u627e\u540e\u7aef","text":"<p>\u6211\u4eec\u9700\u8981\u89e3\u6790 HTTP \u8bf7\u6c42\u4ee5\u627e\u51fa\u5176\uff1a</p> <ol> <li>\u4e3b\u673a\u540d</li> <li>\u8def\u5f84</li> <li>HTTP \u52a8\u8bcd</li> </ol> <p>\u6211\u4eec\u9996\u5148\u4f1a\u5c1d\u8bd5\u4ece\u524d\u7aef\u7f13\u51b2\u533a\u4e2d \u4ece\u5957\u63a5\u5b57\u8bfb\u53d6\u6570\u636e \u3002\u5982\u679c\u6ca1\u6709\u9519\u8bef\uff08\u5957\u63a5\u5b57\u5173\u95ed\u7b49\uff09\uff0c\u6211\u4eec\u5c06\u5728 <code>readable_parse()</code> \u4e2d\u5904\u7406\u8fd9\u4e9b\u6570\u636e\u3002</p> <p>HTTP \u5b9e\u73b0\u5305\u542b \u4e24\u4e2a\u8f83\u5c0f\u7684\u72b6\u6001\u673a\uff0c <code>RequestState</code> \u548c <code>ResponseState</code>\uff0c\u5b83\u4eec\u6307\u793a\u6211\u4eec\u5728\u89e3\u6790 \u8bf7\u6c42\u6216\u54cd\u5e94\u4e2d\u7684\u4f4d\u7f6e\uff0c\u5e76\u5b58\u50a8\u6709\u5173\u5b83\u4eec\u7684\u6570\u636e\u3002</p> <p>\u5f53\u6211\u4eec\u4ece\u5ba2\u6237\u7aef\u6536\u5230\u7b2c\u4e00\u4e2a\u5b57\u8282\u65f6\uff0c\u4e24\u8005\u90fd\u5904\u4e8e <code>Initial</code> \u72b6\u6001\u3002 \u6211\u4eec\u4ece\u524d\u7aef\u7f13\u51b2\u533a\u89e3\u6790\u6570\u636e \u76f4\u5230\u6211\u4eec\u8fbe\u5230\u4e00\u4e2a\u8bf7\u6c42\u72b6\u6001\uff0c\u5176\u4e2d\u5934\u90e8\u5df2\u5b8c\u5168\u89e3\u6790\u3002\u5982\u679c\u6ca1\u6709 \u8db3\u591f\u7684\u6570\u636e\uff0c\u6211\u4eec\u5c06\u7b49\u5f85\u66f4\u591a\u6570\u636e\u5230\u8fbe\u5957\u63a5\u5b57\u5e76\u91cd\u65b0\u5f00\u59cb \u89e3\u6790\u3002</p> <p>\u4e00\u65e6\u6211\u4eec\u5b8c\u6210\u4e86\u89e3\u6790\u5934\u90e8\uff0c\u5e76\u627e\u5230\u6211\u4eec\u6b63\u5728\u5bfb\u627e\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u5c06 \u8fd4\u56de SessionResult::ConnectBackend \u4ee5\u901a\u77e5\u4f1a\u8bdd\u5b83\u5e94\u8be5\u627e\u5230\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u6765\u53d1\u9001\u6570\u636e\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_10","title":"\u8fde\u63a5\u5230\u540e\u7aef\u670d\u52a1\u5668","text":"<p>\u4f1a\u8bdd\uff1a 1. \u67e5\u627e\u8981\u8fde\u63a5\u5230\u54ea\u4e2a\u96c6\u7fa4 2. \u5411 SessionManager \u8bf7\u6c42\u4e00\u4e2a\u540d\u4e3a <code>back_token</code> \u7684\u65b0\u6709\u6548\u4ee4\u724c 3. \u8bf7\u6c42\u8fde\u63a5\u5230\u96c6\u7fa4    - \u9002\u5f53\u7684\u4ee3\u7406\u67e5\u627e\u540e\u7aef\uff08\u6dfb\u52a0\u8be6\u7ec6\u4fe1\u606f\uff09 4. \u4f7f\u7528 <code>back_token</code> \u5728 mio \u4e2d\u6ce8\u518c\u65b0\u7684 <code>TcpStream</code> 5. \u4f7f\u7528 <code>back_token</code> \u5c06\u81ea\u8eab\u63d2\u5165 SessionManager</p> <p>\u540c\u4e00\u4e2a\u4f1a\u8bdd\u73b0\u5728\u5728 SessionManager \u4e2d\u5b58\u50a8\u4e86\u4e24\u6b21\uff1a</p> <ol> <li>\u4e00\u6b21\u4f7f\u7528\u524d\u7aef\u4ee4\u724c\u4f5c\u4e3a\u952e</li> <li>\u5176\u6b21\u4f7f\u7528\u540e\u7aef\u4ee4\u724c\u4f5c\u4e3a\u952e</li> </ol> <p>\u5982\u679c S\u014dzu \u627e\u4e0d\u5230\u96c6\u7fa4\uff0c\u5b83\u4f1a\u5411\u5ba2\u6237\u7aef\u54cd\u5e94\u4e00\u4e2a\u9ed8\u8ba4\u7684 HTTP 404 Not Found \u54cd\u5e94\u3002 \u4e00\u4e2a\u4f1a\u8bdd\u53ef\u4ee5\u5c1d\u8bd5\u8fde\u63a5\u5230\u540e\u7aef 3 \u6b21\u3002\u5982\u679c\u6240\u6709\u5c1d\u8bd5\u90fd\u5931\u8d25\uff0cS\u014dzu \u4f1a\u54cd\u5e94\u4e00\u4e2a\u9ed8\u8ba4\u7684 HTTP 503 Service Unavailable \u54cd\u5e94\u3002\u5982\u679c S\u014dzu \u627e\u5230\u4e86\u4e00\u4e2a\u96c6\u7fa4\uff0c\u4f46\u6240\u6709\u76f8\u5e94\u7684 \u540e\u7aef\u90fd\u5df2\u5173\u95ed\uff08\u6216\u6ca1\u6709\u54cd\u5e94\uff09\uff0c\u5219\u4f1a\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_11","title":"\u4fdd\u6301\u4f1a\u8bdd\u6d3b\u52a8","text":"<p>\u5982\u679c HTTP \u8bf7\u6c42\u9644\u5e26\u4e86 Connection \u6807\u5934\u8bbe\u7f6e\u4e3a Keep-Alive\uff0c \u5219\u5728\u6536\u5230\u54cd\u5e94\u540e\u53ef\u4ee5\u4fdd\u7559\u5e95\u5c42 TCP \u8fde\u63a5\uff0c \u4ee5\u53d1\u9001\u66f4\u591a\u8bf7\u6c42\u3002\u7531\u4e8e S\u014dzu \u652f\u6301\u5728 URL \u548c \u4e3b\u673a\u540d\u4e0a\u8fdb\u884c\u8def\u7531\uff0c\u56e0\u6b64\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u53ef\u80fd\u4f1a\u8f6c\u5230\u4e0d\u540c\u7684\u96c6\u7fa4\u3002 \u56e0\u6b64\uff0c\u5f53\u6211\u4eec\u4ece\u8bf7\u6c42\u4e2d\u83b7\u53d6\u96c6\u7fa4 ID \u65f6\uff0c\u6211\u4eec\u4f1a\u68c0\u67e5\u5b83\u662f\u5426\u4e0e \u4e0a\u4e00\u4e2a\u76f8\u540c\uff0c\u5982\u679c\u76f8\u540c\uff0c\u6211\u4eec\u4f1a\u6d4b\u8bd5\u540e\u5907\u5957\u63a5\u5b57\u662f\u5426\u4ecd\u7136 \u6709\u6548\u3002\u5982\u679c\u662f\uff0c\u6211\u4eec\u53ef\u4ee5\u91cd\u7528\u5b83\u3002\u5426\u5219\uff0c\u6211\u4eec\u5c06\u7528 \u4e00\u4e2a\u65b0\u7684\u5957\u63a5\u5b57\u66ff\u6362\u540e\u5907\u5957\u63a5\u5b57\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_12","title":"\u7c98\u6027\u4f1a\u8bdd\uff1a\u5c06\u524d\u7aef\u4ec5\u56fa\u5b9a\u5230\u4e00\u4e2a\u540e\u7aef","text":"<p>\u8fd9\u662f\u4e00\u79cd\u8def\u7531\u673a\u5236\uff0c\u6211\u4eec\u67e5\u770b\u8bf7\u6c42\u4e2d\u7684 cookie\u3002\u6240\u6709 \u5177\u6709\u76f8\u540c id \u7684 cookie \u7684\u8bf7\u6c42\u90fd\u5c06\u53d1\u9001\u5230\u540c\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u3002</p> <p>\u8be5\u67e5\u627e\u5c06\u6839\u636e\u54ea\u4e9b\u540e\u7aef\u670d\u52a1\u5668\u88ab \u8ba4\u4e3a\u662f\u6709\u6548\u7684\uff08\u5982\u679c\u5b83\u4eec\u6b63\u786e\u54cd\u5e94\uff09\u4ee5\u53ca\u4e3a\u96c6\u7fa4\u914d\u7f6e\u7684\u8d1f\u8f7d\u5e73\u8861 \u7b56\u7565\u8fd4\u56de\u4e00\u4e2a\u7ed3\u679c\u3002 \u5982\u679c\u627e\u5230\u4e86\u540e\u7aef\uff0c\u6211\u4eec\u6253\u5f00\u4e00\u4e2a\u5230\u540e\u7aef\u670d\u52a1\u5668\u7684 TCP \u8fde\u63a5\uff0c \u5426\u5219\u6211\u4eec\u8fd4\u56de\u4e00\u4e2a HTTP 503 \u54cd\u5e94\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_13","title":"\u5c06\u6570\u636e\u53d1\u9001\u5230\u540e\u5907\u5957\u63a5\u5b57","text":"<p>\u7136\u540e\u6211\u4eec\u7b49\u5f85\u6765\u81ea\u540e\u7aef\u8fde\u63a5\u7684\u53ef\u5199\u4e8b\u4ef6\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5f00\u59cb \u5c06\u6302\u8d77\u7684\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u5b83\u3002 \u5982\u679c\u51fa\u73b0\u9519\u8bef\uff0c\u6211\u4eec\u4f1a\u91cd\u8bd5\u8fde\u63a5\u5230\u540c\u4e00\u96c6\u7fa4\u4e2d\u7684\u53e6\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u5668\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_14","title":"\u5927\u8f6c\u5f2f\uff1a\u4ece\u540e\u7aef\u8f6c\u53d1\u5230\u524d\u7aef","text":"<p>\u5982\u4e0a\u6240\u8ff0\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u540d\u4e3a <code>ResponseState</code> \u7684\u5c0f\u72b6\u6001\u673a\uff0c\u7528\u4e8e \u89e3\u6790\u6765\u81ea\u540e\u7aef\u7684\u6d41\u91cf\u3002\u6574\u4e2a\u903b\u8f91\u57fa\u672c\u76f8\u540c\u3002</p> <p>\u6211\u4eec\u76d1\u89c6\u540e\u7aef\u7684\u53ef\u8bfb\u6027\u548c\u524d\u7aef\u7684\u53ef\u5199\u6027\uff0c\u5e76\u5c06\u6d41\u91cf\u4ece \u4e00\u4e2a\u4f20\u8f93\u5230\u53e6\u4e00\u4e2a\u3002</p>"},{"location":"lifetime_of_a_session_zh/#_15","title":"\u4f1a\u8bdd\u7ed3\u675f","text":"<p>\u4e00\u65e6 <code>ResponseState</code> \u8fbe\u5230\u201c\u5b8c\u6210\u201d\u72b6\u6001\u5e76\u4e14\u6bcf\u4e2a\u5b57\u8282\u90fd\u5df2\u53d1\u9001 \u56de\u5ba2\u6237\u7aef\uff0c\u8bf7\u6c42\u7684\u5b8c\u6574\u751f\u547d\u5468\u671f\u5c31\u7ed3\u675f\u4e86\u3002\u4f1a\u8bdd \u8fbe\u5230 <code>CloseSession</code> \u72b6\u6001\u5e76\u4ece <code>SessionManager</code> \u7684 slab \u4e2d\u5220\u9664 \u5e76\u4e14\u5176\u5957\u63a5\u5b57\u4ece mio \u4e2d\u53d6\u6d88\u6ce8\u518c\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u8bf7\u6c42\u5177\u6709 Keep-Alive \u6807\u5934\uff0c\u5219\u4f1a\u8bdd\u5c06\u88ab\u91cd\u7528 \u5e76\u7b49\u5f85\u65b0\u8bf7\u6c42\u3002\u8fd9\u662f\u4f1a\u8bdd\u7684\u201c\u91cd\u7f6e\u201d\u3002</p>"},{"location":"overview/","title":"Sozu Tutorial","text":""},{"location":"overview/#introduction","title":"Introduction","text":"<p>Sozu is a fast, reliable, and programmable HTTP and TCP reverse proxy written in Rust. It supports advanced routing, load balancing, TLS termination, and dynamic configuration.</p>"},{"location":"overview/#1-rust-environment-setup","title":"1. Rust Environment Setup","text":"<p>Before installing Sozu, ensure you have the latest stable version of Rust installed on your system. We recommend using <code>rustup</code> for installation:</p> <ol> <li> <p>Install <code>rustup</code>: Visit the official rustup website or run the following command in your terminal:</p> <p><code>bash curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh</code></p> </li> <li> <p>Configure Environment: Follow the installer's instructions, which typically involve running <code>source $HOME/.cargo/env</code> to add <code>cargo</code> (Rust's package manager) to your PATH.</p> </li> <li> <p>Verify Installation: Run <code>rustc --version</code> and <code>cargo --version</code> to verify that Rust is installed successfully.</p> </li> </ol>"},{"location":"overview/#2-sozu-installation","title":"2. Sozu Installation","text":"<p>You can choose to install Sozu from crates.io via <code>cargo install</code> or build it from the source code.</p>"},{"location":"overview/#21-install-via-cargo-install","title":"2.1 Install via <code>cargo install</code>","text":"<p>Sozu is published on crates.io. Installation is straightforward:</p> <pre><code>car go install sozu\n</code></pre> <p>After installation, the <code>sozu</code> executable will be available in your <code>~/.cargo/bin</code> directory.</p>"},{"location":"overview/#22-build-from-source","title":"2.2 Build from Source","text":"<p>If you want to build Sozu from the source code (for example, for development or to use the latest version), follow these steps:</p> <ol> <li> <p>Clone the Repository: If you haven't already, clone the Sozu repository:</p> <p><code>bash git clone https://github.com/sozu-proxy/sozu.git cd sozu</code></p> </li> <li> <p>Build: Navigate to the <code>bin</code> directory and use the <code>cargo build</code> command. For a production build, be sure to use the <code>--release</code> flag to enable optimizations:</p> <p><code>bash cd bin cargo build --release --locked</code></p> <ul> <li>The <code>--release</code> flag tells Cargo to enable compiler optimizations, generating a more performant binary. Use this only for production builds.</li> <li>The <code>--locked</code> flag forces Cargo to adhere to the dependency versions specified in <code>Cargo.lock</code>, preventing dependency breakage.</li> </ul> </li> </ol> <p>The executable will be located at <code>target/release/sozu</code> after the build is complete.</p>"},{"location":"overview/#3-how-to-use-sozu","title":"3. How to Use Sozu","text":"<p>Sozu can run as a standalone process or be integrated into a Docker container or Systemd service.</p>"},{"location":"overview/#31-running-sozu","title":"3.1 Running Sozu","text":"<ul> <li> <p>If installed via <code>cargo install</code>: The <code>sozu</code> command should already be in your <code>$PATH</code>.</p> <p><code>bash sozu start -c &lt;path/to/your/config.toml&gt;</code></p> </li> <li> <p>If built from source: The executable is in the <code>target/release</code> directory.</p> <p><code>bash ./target/release/sozu start -c &lt;path/to/your/config.toml&gt;</code></p> </li> </ul> <p>You can edit the reverse proxy's configuration in the <code>config.toml</code> file to declare new clusters, frontends, and backends.</p> <p>Tip: You can use the <code>sozu</code> binary as a CLI to interact with the reverse proxy. See the command-line documentation for more information.</p>"},{"location":"overview/#32-running-with-docker","title":"3.2 Running with Docker","text":"<p>The Sozu repository provides a multi-stage <code>Dockerfile</code> based on <code>alpine:edge</code>.</p> <ol> <li> <p>Build the Docker Image:</p> <p><code>bash docker build -t sozu .</code></p> <p>You can also build an image for a specific Alpine version:</p> <p><code>bash docker build --build-arg ALPINE_VERSION=3.14 -t sozu:main-alpine-3.14 .</code></p> </li> <li> <p>Run the Docker Container:</p> <p><code>bash docker run \\   --ulimit nofile=262144:262144 \\   --name sozu-proxy \\   -v /run/sozu:/run/sozu \\   -v /path/to/your/config.toml:/etc/sozu/config.toml \\   -v /my/state/:/var/lib/sozu \\   -p 8080:80 \\   -p 8443:443 \\   sozu start -c /etc/sozu/config.toml</code></p> <ul> <li><code>-v /path/to/your/config.toml:/etc/sozu/config.toml</code>: Mounts your custom <code>config.toml</code> file into the container.</li> <li><code>-v /my/state/:/var/lib/sozu</code>: Mounts your initial configuration state JSON file if you have one.</li> </ul> </li> </ol>"},{"location":"overview/#33-systemd-integration","title":"3.3 Systemd Integration","text":"<p>The Sozu repository provides Systemd unit files for easy integration as a service.</p> <ol> <li> <p>Copy the Unit File: Copy <code>sozu/os-build/systemd/sozu.service</code> to the <code>/etc/systemd/system/</code> directory:</p> <p><code>bash sudo cp sozu/os-build/systemd/sozu.service /etc/systemd/system/</code></p> </li> <li> <p>Reload Systemd:</p> <p><code>bash sudo systemctl daemon-reload</code></p> </li> <li> <p>Start the Service:</p> <p><code>bash sudo systemctl start sozu.service</code></p> </li> <li> <p>Enable on Boot:</p> <p><code>bash sudo systemctl enable sozu.service</code></p> </li> </ol>"},{"location":"overview/#4-sozu-configuration","title":"4. Sozu Configuration","text":"<p>Sozu's core configuration is managed through the <code>config.toml</code> file. It consists of three main sections: <code>global</code> parameters, protocol definitions (like <code>https</code>, <code>http</code>, <code>tcp</code>), and the <code>clusters</code> section.</p>"},{"location":"overview/#41-configuration-file-configtoml-structure-overview","title":"4.1 Configuration File (<code>config.toml</code>) Structure Overview","text":"<p>Here is an example of a Sozu configuration file:</p> <pre><code># Global parameters\ncommand_socket = \"./command_folder/sock\"\nsaved_state = \"./state.json\"\nlog_level = \"info\"\nlog_target = \"stdout\"\nworker_count = 2\nhandle_process_affinity = false\nmax_connections = 500\nbuffer_size = 16384\nactivate_listeners = true\n\n# Listener configuration\n[[listeners]]\nprotocol = \"http\"\naddress = \"0.0.0.0:8080\"\n# public_address = \"1.2.3.4:80\" # For logs and forwarding headers\n# expect_proxy = false # Expect PROXY protocol header\n\n# HTTPS listener example\n[[listeners]]\nprotocol = \"https\"\naddress = \"0.0.0.0:8443\"\ncertificate = \"/path/to/certificate.pem\"\nkey = \"/path/to/key.pem\"\ncertificate_chain = \"/path/to/certificate_chain.pem\"\n# tls_versions = [\"TLS_V12\", \"TLS_V13\"]\n# answer_404 = \"/path/to/my-404-answer.http\" # Custom error page\n\n# Cluster configuration\n[clusters]\n[clusters.MyWebsiteCluster]\nprotocol = \"http\" # https proxy also uses http protocol\n# load_balancing_policy=\"roundrobin\" # Load balancing policy: \"roundrobin\" (default) or \"random\"\n# https_redirect = true # Force redirect of http traffic to https\n# sticky_session = true # Optional, enable sticky sessions\n\nfrontends = [\n  { address = \"0.0.0.0:8080\", hostname = \"your_domain.com\" },\n  # For HTTPS frontends, certificate and key are also required\n  { address = \"0.0.0.0:8443\", hostname = \"your_domain.com\", certificate = \"/path/to/certificate.pem\", key = \"/path/to/key.pem\", certificate_chain = \"/path/to/certificate_chain.pem\" }\n]\nbackends  = [\n  { address = \"127.0.0.1:8000\" }, # Backend server address\n  { address = \"127.0.0.1:8001\" }\n]\n\n# Metrics configuration\n[metrics]\naddress = \"127.0.0.1:8125\"\n# tagged_metrics = false\n# prefix = \"sozu\"\n</code></pre>"},{"location":"overview/#42-global-parameters","title":"4.2 Global Parameters","text":"<p>Global parameters are set in the <code>[global]</code> section and affect both the main and worker processes:</p> Parameter Description Possible Values <code>saved_state</code> Path from which Sozu attempts to load state on startup <code>log_level</code> Logging level <code>debug</code>, <code>trace</code>, <code>error</code>, <code>warn</code>, <code>info</code> <code>log_target</code> Logging output destination <code>stdout</code>, <code>tcp</code>, or <code>udp</code> address <code>access_logs_target</code> Access log output destination (if activated) <code>stdout</code>, <code>tcp</code>, or <code>udp</code> address <code>command_socket</code> Path to the Unix command socket <code>worker_count</code> Number of worker processes <code>handle_process_affinity</code> Bind worker processes to CPU cores <code>true</code>, <code>false</code> <code>max_connections</code> Maximum number of concurrent connections <code>buffer_size</code> Request buffer size used by worker processes (in bytes) <code>activate_listeners</code> Automatically start listeners <code>true</code>, <code>false</code> <code>front_timeout</code> Maximum inactivity time for frontend sockets <code>connect_timeout</code> Maximum inactivity time for connection requests <code>request_timeout</code> Maximum inactivity time for requests <code>zombie_check_interval</code> Interval for checking zombie sessions <code>pid_file_path</code> Path to the file where the PID is stored"},{"location":"overview/#43-listeners","title":"4.3 Listeners","text":"<p>The <code>[[listeners]]</code> section defines a set of listening sockets that accept client connections. You can define any number of listeners.</p> <ul> <li> <p>Common Parameters:     <code>toml     [[listeners]]     protocol = \"http\" # or \"https\", \"tcp\"     address = \"0.0.0.0:8080\"     # public_address = \"1.2.3.4:80\" # Optional, for logs and forwarding headers     # expect_proxy = true # Optional, configure client socket to receive PROXY protocol header</code></p> </li> <li> <p>HTTP and HTTPS Listener Specific Options (Custom Error Pages):     You can define custom responses for HTTP and HTTPS listeners, such as 404 Not Found or 503 Service Unavailable. These responses can be plain text files containing HTML and some template variables (e.g., <code>%REQUEST_ID%</code>).</p> <p>```toml</p> </li> <li> <p>HTTPS Listener Specific Options:     <code>toml     # Supported TLS versions. Possible values: \"SSL_V2\", \"SSL_V3\", \"TLS_V12\", \"TLS_V13\". Defaults to \"TLS_V12\" and \"TLS_V13\".     tls_versions = [\"TLS_V12\", \"TLS_V13\"]     # Defines the name of the sticky session cookie if the cluster has sticky_session activated. Defaults to \"SOZUBALANCEID\".     sticky_name = \"SOZUBALANCEID\"</code></p> <p>Rustls-based HTTPS listener specific options: <code>toml cipher_list = [     # TLS 1.3 cipher suites     \"TLS13_AES_256_GCM_SHA384\",     # ... other cipher suites ]</code></p> </li> </ul>"},{"location":"overview/#send-a-404-response-when-sozu-doesnt-know-the-requested-domain-or-path","title":"Send a 404 response when Sozu doesn't know the requested domain or path","text":"<p>answer_404 = \"/path/to/my-404-answer.http\"</p>"},{"location":"overview/#send-a-503-response-when-no-backend-servers-are-available","title":"Send a 503 response when no backend servers are available","text":"<p>answer_503 = \"/path/to/my-503-answer.http\" ```</p>"},{"location":"overview/#44-clusters","title":"4.4 Clusters","text":"<p>Declare your list of clusters in the <code>[clusters]</code> section:</p> <pre><code>[clusters]\n[clusters.MyWebsiteCluster]\nprotocol = \"http\" # or \"tcp\". HTTPS proxy also uses http protocol\n# load_balancing_policy=\"roundrobin\" # Load balancing policy: \"roundrobin\" (default) or \"random\"\n# https_redirect = true # Force redirect of http traffic to https\n# sticky_session = true # Optional, enable sticky sessions\n\nfrontends = [\n  { address = \"0.0.0.0:8080\", hostname = \"your_domain.com\" },\n  # For HTTPS frontends, certificate and key are also required\n  { address = \"0.0.0.0:8443\", hostname = \"your_domain.com\", certificate = \"/path/to/certificate.pem\", key = \"/path/to/key.pem\", certificate_chain = \"/path/to/certificate_chain.pem\" }\n]\nbacks  = [\n  { address = \"127.0.0.1:8000\" }, # Backend server address\n  { address = \"127.0.0.1:8001\" }\n]\n</code></pre>"},{"location":"overview/#45-metrics","title":"4.5 Metrics","text":"<p>Sozu reports its status to other network components via a UDP socket and implements the <code>statsd</code> protocol.</p> <p>Configuration:</p> <pre><code>[metrics]\naddress = \"127.0.0.1:8125\" # Address and port of the statsd service\n# tagged_metrics = false # Use InfluxDB's statsd protocol to add tags\n# prefix = \"sozu\" # Prefix for metric keys\n</code></pre>"},{"location":"overview/#46-proxy-protocol","title":"4.6 PROXY Protocol","text":"<p>The PROXY protocol is used to pass the client's real IP address and port information through a chain of proxies. Sozu supports PROXY protocol version 2.</p> <ul> <li> <p>Configure Sozu to Expect a PROXY Protocol Header:     <code>toml     [[listeners]]     address = \"0.0.0.0:80\"     expect_proxy = true</code></p> <p>This makes the client connection receive a PROXY protocol header before any other data is read.</p> </li> <li> <p>Configure Sozu to Send a PROXY Protocol Header to the Backend:     ```toml     [[listeners]]     address = \"0.0.0.0:81\"</p> <p>[clusters] [clusters.NameOfYourTcpCluster] send_proxy = true frontends = [   { address = \"0.0.0.0:81\" } ] ``` Note: Only applicable to TCP clusters (HTTP and HTTPS proxies will use forwarding headers).</p> </li> <li> <p>Configure Sozu to Forward a PROXY Protocol Header:     ```toml     [[listeners]]     address = \"0.0.0.0:80\"     expect_proxy = true</p> <p>[clusters] [clusters.NameOfYourCluster] send_proxy = true frontends = [   { address = \"0.0.0.0:80\" } ] ```</p> <p>Sozu will receive the PROXY protocol header from the client connection, validate it, and then forward it to the upstream backend. This allows a proxy chain to work without losing client connection information. Note: Only applicable to TCP clusters.</p> </li> </ul>"},{"location":"overview/#5-dynamic-backend-management-service-discovery","title":"5. Dynamic Backend Management (Service Discovery)","text":"<p>In dynamic environments like Docker, the IP addresses of backend services can change frequently. Although <code>config.toml</code> resolves IP addresses at startup, you can use the Sozu command-line tool (CLI) to dynamically add, update, or remove backends without restarting Sozu.</p> <p>This process requires an external mechanism (such as a simple script, a service discovery tool, or a custom program) to:</p> <ol> <li>Monitor your backend services (e.g., by listening to container start/stop events via the Docker API, or querying Docker's built-in DNS service).</li> <li>Obtain the current IP address and port of the backend services.</li> <li>Use the <code>sozu</code> CLI tool to send commands to the running Sozu instance.</li> </ol> <p>Here is an example of using the <code>sozu</code> CLI to manage backends:</p>"},{"location":"overview/#51-start-sozu-to-accept-commands","title":"5.1 Start Sozu to Accept Commands","text":"<p>Ensure that the <code>command_socket</code> is configured correctly in your <code>config.toml</code> so that the CLI tool can connect to the running Sozu instance. For example:</p> <pre><code>command_socket = \"/var/lib/sozu/command.sock\"\n</code></pre>"},{"location":"overview/#52-find-a-docker-containers-ip-address","title":"5.2 Find a Docker Container's IP Address","text":"<p>Assuming your Docker network is named <code>my-network</code> and your backend service is named <code>my-backend-app</code>, you can use the <code>docker inspect</code> command to get its IP address.</p> <pre><code># Get the IP address of a single running container\ndocker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' my-backend-app\n\n# Assuming your backend service is exposed on port 8080\nexport BACKEND_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' my-backend-app)\nexport BACKEND_PORT=8080\nexport BACKEND_ADDRESS=\"${BACKEND_IP}:${BACKEND_PORT}\"\n</code></pre> <p>In a <code>docker-compose</code> environment, if services are under the same <code>user-defined bridge network</code>, the service name can often be resolved directly as a hostname. However, if Sozu resolves IPs at startup, you still need to get the IP first.</p>"},{"location":"overview/#53-dynamically-add-a-backend","title":"5.3 Dynamically Add a Backend","text":"<p>Use the <code>sozu backend add</code> command to add a new backend to a specified cluster.</p> <pre><code># Assuming your Sozu config path is /etc/sozu/config.toml\n# and the command_socket is set in that file\n# Assuming your cluster ID is 'komo'\nCONFIG_PATH=\"/etc/sozu/config.toml\"\nCLUSTER_ID=\"komo\"\nNEW_BACKEND_ID=\"backend-1\" # Provide a unique ID for the new backend\nNEW_BACKEND_ADDRESS=\"172.17.0.5:9120\" # Replace with your backend's actual IP:port\n\nsozu --config \"${CONFIG_PATH}\" backend add --id \"${CLUSTER_ID}\" --backend-id \"${NEW_BACKEND_ID}\" --address \"${NEW_BACKEND_ADDRESS}\"\n</code></pre> <ul> <li><code>--config</code>: Specifies the path to the Sozu configuration file, which should contain the path to the <code>command_socket</code>.</li> <li><code>backend add</code>: Indicates the action to add a backend.</li> <li><code>--id</code>: Specifies the cluster ID to add the backend to.</li> <li><code>--backend-id</code>: Provides a unique identifier for this backend instance.</li> <li><code>--address</code>: Specifies the IP address and port of the backend server.</li> </ul>"},{"location":"overview/#54-dynamically-remove-a-backend","title":"5.4 Dynamically Remove a Backend","text":"<p>Use the <code>sozu backend remove</code> command to remove a backend from a specified cluster.</p> <pre><code># Assuming your Sozu config path is /etc/sozu/config.toml\nCONFIG_PATH=\"/etc/sozu/config.toml\"\nCLUSTER_ID=\"komo\"\nOLD_BACKEND_ID=\"backend-1\" # The ID of the backend to remove\nOLD_BACKEND_ADDRESS=\"172.17.0.5:9120\" # Replace with the actual IP:port of the backend to remove\n\nsozu --config \"${CONFIG_PATH}\" backend remove --id \"${CLUSTER_ID}\" --backend-id \"${OLD_BACKEND_ID}\" --address \"${OLD_BACKEND_ADDRESS}\"\n</code></pre> <ul> <li><code>--config</code>: Specifies the path to the Sozu configuration file.</li> <li><code>backend remove</code>: Indicates the action to remove a backend.</li> <li><code>--id</code>: Specifies the cluster ID to remove the backend from.</li> <li><code>--backend-id</code>: The ID of the backend to remove.</li> <li><code>--address</code>: The IP address and port of the backend server to remove.</li> </ul>"},{"location":"overview/#55-check-sozu-worker-status","title":"5.5 Check S\u014dzu Worker Status","text":"<p>You can use the <code>sozu status</code> command to check the running status of the S\u014dzu workers.</p> <pre><code># Assuming your Sozu config path is /etc/sozu/config.toml\nCONFIG_PATH=\"/etc/sozu/config.toml\"\nsozu --config \"${CONFIG_PATH}\" status --json\n</code></pre> <p>This will return the current worker status in JSON format. To see detailed cluster, frontend, and backend configurations, see the next section.</p>"},{"location":"overview/#56-automation-script-concept","title":"5.6 Automation Script (Concept)","text":"<p>To achieve true service discovery, you need to write a continuously running script (e.g., using Python, Bash, or Go) that:</p> <ol> <li>Periodically or by event-listening to the Docker API, detects changes in backend containers.</li> <li>Compares the list of backends currently in Sozu with the list of backends actually running in Docker.</li> <li>Executes <code>sozu backend add</code> or <code>sozu backend remove</code> commands to synchronize the two lists.</li> </ol> <p>This script will act as the \"control plane\" in your service discovery solution.</p>"},{"location":"overview/#57-view-dynamically-added-frontends-and-backends","title":"5.7 View Dynamically Added Frontends and Backends","text":"<p>After dynamically adding a <code>frontend</code> or <code>backend</code> via the command line, you might want to verify that they have been loaded successfully. S\u014dzu's routing structure is <code>frontend</code> -&gt; <code>cluster</code> -&gt; <code>backend</code>. You can track and view this dynamically added data in two steps:</p> <ol> <li> <p>Find the <code>cluster ID</code> for a <code>frontend</code></p> <p>Use the <code>sozu frontend list --json</code> command to list all configured frontends. In the returned JSON data, find the <code>frontend</code> you are interested in and note its <code>cluster_id</code>.</p> <p>```bash</p>"},{"location":"overview/#replace-with-your-config-file-path","title":"Replace  with your config file path <p>sozu --config  frontend list --json ```  <li> <p>Find the <code>backends</code> for a <code>cluster ID</code></p> <p>Once you have the <code>cluster ID</code>, use the <code>sozu cluster list --id &lt;CLUSTER_ID&gt;</code> command to view the details of that specific cluster, which includes a list of all its <code>backends</code>.</p> <p>```bash</p>","text":""},{"location":"overview/#replace-and","title":"Replace  and  <p>sozu --config  cluster list --id  --json ```   <p>Through this two-step process, you can clearly see the complete mapping from <code>frontend</code> to <code>backend</code> and confirm that your dynamic configuration has been applied.</p> <p>We hope this tutorial helps you to better understand and use Sozu!</p>","text":""},{"location":"overview_zh/","title":"Sozu \u4e2d\u6587\u4f7f\u7528\u6559\u7a0b","text":""},{"location":"overview_zh/#_1","title":"\u7b80\u4ecb","text":"<p>Sozu \u662f\u4e00\u4e2a\u5feb\u901f\u3001\u53ef\u9760\u4e14\u53ef\u7f16\u7a0b\u7684 HTTP \u548c TCP \u53cd\u5411\u4ee3\u7406\uff0c\u7531 Rust \u7f16\u5199\u3002\u5b83\u652f\u6301\u9ad8\u7ea7\u8def\u7531\u3001\u8d1f\u8f7d\u5747\u8861\u3001TLS \u7ec8\u6b62\u548c\u52a8\u6001\u914d\u7f6e\u3002</p>"},{"location":"overview_zh/#1-rust","title":"1. Rust \u73af\u5883\u8bbe\u7f6e","text":"<p>\u5728\u5b89\u88c5 Sozu \u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u60a8\u7684\u7cfb\u7edf\u4e0a\u5b89\u88c5\u4e86\u6700\u65b0\u7a33\u5b9a\u7248\u7684 Rust\u3002\u6211\u4eec\u63a8\u8350\u4f7f\u7528 <code>rustup</code> \u8fdb\u884c\u5b89\u88c5\uff1a</p> <ul> <li>\u5b89\u88c5 <code>rustup</code>: \u8bbf\u95ee rustup \u5b98\u65b9\u7f51\u7ad9 \u6216\u5728\u7ec8\u7aef\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</li> </ul> <pre><code>curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh\n</code></pre> <ul> <li> <p>\u914d\u7f6e\u73af\u5883: \u6309\u7167\u5b89\u88c5\u7a0b\u5e8f\u7684\u6307\u793a\u64cd\u4f5c\uff0c\u901a\u5e38\u9700\u8981\u6267\u884c <code>source $HOME/.cargo/env</code> \u6765\u5c06 <code>cargo</code> (Rust \u7684\u5305\u7ba1\u7406\u5668) \u6dfb\u52a0\u5230\u60a8\u7684 PATH \u4e2d\u3002</p> </li> <li> <p>\u9a8c\u8bc1\u5b89\u88c5: \u8fd0\u884c <code>rustc --version</code> \u548c <code>cargo --version</code> \u6765\u9a8c\u8bc1 Rust \u662f\u5426\u6210\u529f\u5b89\u88c5\u3002</p> </li> </ul>"},{"location":"overview_zh/#2-sozu","title":"2. Sozu \u5b89\u88c5","text":"<p>\u60a8\u53ef\u4ee5\u9009\u62e9\u901a\u8fc7 <code>cargo install</code> \u4ece crates.io \u5b89\u88c5 Sozu\uff0c\u6216\u8005\u4ece\u6e90\u4ee3\u7801\u6784\u5efa\u3002</p>"},{"location":"overview_zh/#21-cargo-install","title":"2.1 \u901a\u8fc7 <code>cargo install</code> \u5b89\u88c5","text":"<p>Sozu \u53d1\u5e03\u5728 crates.io \u4e0a\u3002\u5b89\u88c5\u975e\u5e38\u7b80\u5355\uff1a</p> <pre><code>cargo install sozu\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c<code>sozu</code> \u53ef\u6267\u884c\u6587\u4ef6\u5c06\u5728\u60a8\u7684 <code>~/.cargo/bin</code> \u76ee\u5f55\u4e2d\u53ef\u7528\u3002</p>"},{"location":"overview_zh/#22","title":"2.2 \u4ece\u6e90\u4ee3\u7801\u6784\u5efa","text":"<p>\u5982\u679c\u60a8\u60f3\u4ece\u6e90\u4ee3\u7801\u6784\u5efa Sozu (\u4f8b\u5982\uff0c\u8fdb\u884c\u5f00\u53d1\u6216\u4f7f\u7528\u6700\u65b0\u7248\u672c)\uff0c\u8bf7\u9075\u5faa\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u514b\u9686\u4ed3\u5e93: \u5982\u679c\u60a8\u5c1a\u672a\u514b\u9686 Sozu \u4ed3\u5e93\uff0c\u8bf7\u5148\u514b\u9686\u5b83\uff1a</li> </ul> <pre><code>git clone https://github.com/sozu-proxy/sozu.git\ncd sozu\n</code></pre> <ul> <li>\u6784\u5efa: \u5bfc\u822a\u5230 <code>bin</code> \u76ee\u5f55\u5e76\u4f7f\u7528 <code>cargo build</code> \u547d\u4ee4\u6784\u5efa\u3002\u4e3a\u4e86\u83b7\u5f97\u751f\u4ea7\u7248\u672c\uff0c\u8bf7\u52a1\u5fc5\u4f7f\u7528 <code>--release</code> \u6807\u5fd7\u4ee5\u542f\u7528\u4f18\u5316\uff1a</li> </ul> <pre><code>cd bin\ncargo build --release --locked\n</code></pre> <ul> <li><code>--release</code> \u53c2\u6570\u4f1a\u544a\u77e5 Cargo \u542f\u7528\u7f16\u8bd1\u4f18\u5316\uff0c\u751f\u6210\u6027\u80fd\u66f4\u597d\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002\u4ec5\u5728\u6784\u5efa\u751f\u4ea7\u7248\u672c\u65f6\u4f7f\u7528\u3002</li> <li><code>--locked</code> \u6807\u5fd7\u4f1a\u5f3a\u5236 Cargo \u9075\u5b88 <code>Cargo.lock</code> \u4e2d\u6307\u5b9a\u7684\u4f9d\u8d56\u7248\u672c\uff0c\u4ece\u800c\u9632\u6b62\u4f9d\u8d56\u4e2d\u65ad\u3002</li> </ul> <p>\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u6267\u884c\u6587\u4ef6\u5c06\u5728 <code>target/release/sozu</code> \u8def\u5f84\u4e0b\u3002</p>"},{"location":"overview_zh/#3-sozu","title":"3. \u5982\u4f55\u4f7f\u7528 Sozu","text":"<p>Sozu \u65e2\u53ef\u4ee5\u4f5c\u4e3a\u72ec\u7acb\u8fdb\u7a0b\u8fd0\u884c\uff0c\u4e5f\u53ef\u4ee5\u96c6\u6210\u5230 Docker \u5bb9\u5668\u6216 Systemd \u670d\u52a1\u4e2d\u3002</p>"},{"location":"overview_zh/#31-sozu","title":"3.1 \u8fd0\u884c Sozu","text":"<ul> <li>\u901a\u8fc7 <code>cargo install</code> \u65b9\u5f0f\u5b89\u88c5: \u5982\u679c\u60a8\u901a\u8fc7 <code>cargo install</code> \u5b89\u88c5\u4e86 Sozu\uff0c\u90a3\u4e48 <code>sozu</code> \u547d\u4ee4\u5e94\u8be5\u5df2\u7ecf\u5728\u60a8\u7684 <code>$PATH</code> \u4e2d\u3002</li> </ul> <pre><code>sozu start -c &lt;\u60a8\u7684/config.toml/\u8def\u5f84&gt;\n</code></pre> <ul> <li>\u4ece\u6e90\u4ee3\u7801\u6784\u5efa: \u5982\u679c\u60a8\u4ece\u6e90\u4ee3\u7801\u6784\u5efa\uff0cSozu \u53ef\u6267\u884c\u6587\u4ef6\u4f4d\u4e8e <code>target/release</code> \u76ee\u5f55\u4e2d\u3002</li> </ul> <pre><code>./target/release/sozu start -c &lt;\u60a8\u7684/config.toml/\u8def\u5f84&gt;\n</code></pre> <p>\u60a8\u53ef\u4ee5\u5728 <code>config.toml</code> \u6587\u4ef6\u4e2d\u7f16\u8f91\u53cd\u5411\u4ee3\u7406\u7684\u914d\u7f6e\uff0c\u58f0\u660e\u65b0\u7684\u96c6\u7fa4\u3001\u524d\u7aef\u548c\u540e\u7aef\u3002</p> <p>\u63d0\u793a: \u60a8\u53ef\u4ee5\u4f7f\u7528 <code>sozu</code> \u4e8c\u8fdb\u5236\u6587\u4ef6\u4f5c\u4e3a CLI \u4e0e\u53cd\u5411\u4ee3\u7406\u8fdb\u884c\u4ea4\u4e92\u3002\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u9605\u547d\u4ee4\u884c\u6587\u6863\u3002</p>"},{"location":"overview_zh/#32-docker","title":"3.2 \u4f7f\u7528 Docker \u8fd0\u884c","text":"<p>Sozu \u4ed3\u5e93\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e <code>alpine:edge</code> \u7684\u591a\u9636\u6bb5 <code>Dockerfile</code> \u955c\u50cf\u3002</p> <ul> <li>\u6784\u5efa Docker \u955c\u50cf:</li> </ul> <pre><code>docker build -t sozu .\n</code></pre> <pre><code>\u60a8\u4e5f\u53ef\u4ee5\u6784\u5efa\u7279\u5b9a Alpine \u7248\u672c\u7684\u955c\u50cf\uff1a\n</code></pre> <pre><code>docker build --build-arg ALPINE_VERSION=3.14 -t sozu:main-alpine-3.14 .\n</code></pre> <ul> <li>\u8fd0\u884c Docker \u5bb9\u5668:</li> </ul> <pre><code>docker run \\\n  --ulimit nofile=262144:262144 \\\n  --name sozu-proxy \\\n  -v /run/sozu:/run/sozu \\\n  -v /path/to/your/config.toml:/etc/sozu/config.toml \\\n  -v /my/state/:/var/lib/sozu \\\n  -p 8080:80 \\\n  -p 8443:443 \\\n  sozu start -c /etc/sozu/config.toml\n</code></pre> <ul> <li><code>-v /path/to/your/config.toml:/etc/sozu/config.toml</code>: \u5c06\u60a8\u7684\u81ea\u5b9a\u4e49 <code>config.toml</code> \u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u3002</li> <li><code>-v /my/state/:/var/lib/sozu</code>: \u5982\u679c\u60a8\u6709\u521d\u59cb\u914d\u7f6e\u72b6\u6001 JSON \u6587\u4ef6\uff0c\u8bf7\u5c06\u5176\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u3002</li> </ul>"},{"location":"overview_zh/#33-systemd","title":"3.3 Systemd \u96c6\u6210","text":"<p>Sozu \u4ed3\u5e93\u63d0\u4f9b\u4e86 Systemd \u5355\u5143\u6587\u4ef6\uff0c\u53ef\u4ee5\u8f7b\u677e\u5730\u5c06\u5176\u4f5c\u4e3a\u670d\u52a1\u8fd0\u884c\u3002</p> <ul> <li>\u590d\u5236\u5355\u5143\u6587\u4ef6: \u5c06 <code>sozu/os-build/systemd/sozu.service</code> \u590d\u5236\u5230 <code>/etc/systemd/system/</code> \u76ee\u5f55\uff1a</li> </ul> <pre><code>sudo cp sozu/os-build/systemd/sozu.service /etc/systemd/system/\n</code></pre> <ul> <li>\u91cd\u65b0\u52a0\u8f7d Systemd:</li> </ul> <pre><code>sudo systemctl daemon-reload\n</code></pre> <ul> <li>\u542f\u52a8\u670d\u52a1:</li> </ul> <pre><code>sudo systemctl start sozu.service\n</code></pre> <ul> <li>\u5f00\u673a\u81ea\u542f:</li> </ul> <pre><code>sudo systemctl enable sozu.service\n</code></pre>"},{"location":"overview_zh/#4-sozu","title":"4. Sozu \u914d\u7f6e","text":"<p>Sozu \u7684\u6838\u5fc3\u914d\u7f6e\u901a\u8fc7 <code>config.toml</code> \u6587\u4ef6\u8fdb\u884c\u3002\u5b83\u5305\u542b\u4e09\u4e2a\u4e3b\u8981\u90e8\u5206\uff1a<code>global</code> \u53c2\u6570\u3001\u534f\u8bae\u5b9a\u4e49 (\u5982 <code>https</code>, <code>http</code>, <code>tcp</code>) \u548c <code>clusters</code> \u90e8\u5206\u3002</p>"},{"location":"overview_zh/#41-configtoml","title":"4.1 \u914d\u7f6e\u6587\u4ef6 (<code>config.toml</code>) \u7ed3\u6784\u6982\u8ff0","text":"<p>Sozu \u914d\u7f6e\u6587\u4ef6\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code># \u5168\u5c40\u53c2\u6570\ncommand_socket = \"./command_folder/sock\"\nsaved_state = \"./state.json\"\nlog_level = \"info\"\nlog_target = \"stdout\"\nworker_count = 2\nhandle_process_affinity = false\nmax_connections = 500\nbuffer_size = 16384\nactivate_listeners = true\n\n# \u76d1\u542c\u5668\u914d\u7f6e\n[[listeners]]\nprotocol = \"http\"\naddress = \"0.0.0.0:8080\"\n# public_address = \"1.2.3.4:80\" # \u7528\u4e8e\u65e5\u5fd7\u548c\u8f6c\u53d1\u5934\n# expect_proxy = false # \u671f\u671b PROXY \u534f\u8bae\u5934\n\n# HTTPS \u76d1\u542c\u5668\u793a\u4f8b\n[[listeners]]\nprotocol = \"https\"\naddress = \"0.0.0.0:8443\"\ncertificate = \"/path/to/certificate.pem\"\nkey = \"/path/to/key.pem\"\ncertificate_chain = \"/path/to/certificate_chain.pem\"\n# tls_versions = [\"TLS_V12\", \"TLS_V13\"]\n# answer_404 = \"/path/to/my-404-answer.http\" # \u81ea\u5b9a\u4e49\u9519\u8bef\u9875\u9762\n\n# \u96c6\u7fa4\u914d\u7f6e\n[clusters]\n[clusters.MyWebsiteCluster]\nprotocol = \"http\" # https \u4ee3\u7406\u4e5f\u4f7f\u7528 http \u534f\u8bae\n# load_balancing_policy=\"roundrobin\" # \u8d1f\u8f7d\u5747\u8861\u7b56\u7565: \"roundrobin\" (\u9ed8\u8ba4) \u6216 \"random\"\n# https_redirect = true # \u5f3a\u5236\u5c06 http \u6d41\u91cf\u91cd\u5b9a\u5411\u5230 https\n\nfrontends = [\n  { address = \"0.0.0.0:8080\", hostname = \"your_domain.com\" },\n  # \u5bf9\u4e8e HTTPS \u524d\u7aef\uff0c\u8fd8\u9700\u8981\u6307\u5b9a\u8bc1\u4e66\u548c\u5bc6\u94a5\n  { address = \"0.0.0.0:8443\", hostname = \"your_domain.com\", certificate = \"/path/to/certificate.pem\", key = \"/path/to/key.pem\", certificate_chain = \"/path/to/certificate_chain.pem\" }\n]\nbackends  = [\n  { address = \"127.0.0.1:8000\" }, # \u540e\u7aef\u670d\u52a1\u5668\u5730\u5740\n  { address = \"127.0.0.1:8001\" }\n]\n\n# \u6307\u6807\u914d\u7f6e\n[metrics]\naddress = \"127.0.0.1:8125\"\n# tagged_metrics = false\n# prefix = \"sozu\"\n</code></pre>"},{"location":"overview_zh/#42","title":"4.2 \u5168\u5c40\u53c2\u6570","text":"<p>\u5168\u5c40\u53c2\u6570\u5728 <code>[global]</code> \u90e8\u5206\u8bbe\u7f6e\uff0c\u5f71\u54cd\u4e3b\u8fdb\u7a0b\u548c\u5de5\u4f5c\u8fdb\u7a0b\uff1a</p> \u53c2\u6570 \u63cf\u8ff0 \u53ef\u9009\u503c <code>saved_state</code> Sozu \u542f\u52a8\u65f6\u5c1d\u8bd5\u52a0\u8f7d\u72b6\u6001\u7684\u8def\u5f84 <code>log_level</code> \u65e5\u5fd7\u7ea7\u522b <code>debug</code>, <code>trace</code>, <code>error</code>, <code>warn</code>, <code>info</code> <code>log_target</code> \u65e5\u5fd7\u8f93\u51fa\u76ee\u6807 <code>stdout</code>, <code>tcp</code> \u6216 <code>udp</code> \u5730\u5740 <code>access_logs_target</code> \u8bbf\u95ee\u65e5\u5fd7\u8f93\u51fa\u76ee\u6807 (\u5982\u679c\u6fc0\u6d3b) <code>stdout</code>, <code>tcp</code> \u6216 <code>udp</code> \u5730\u5740 <code>command_socket</code> Unix \u547d\u4ee4\u5957\u63a5\u5b57\u8def\u5f84 <code>worker_count</code> \u5de5\u4f5c\u8fdb\u7a0b\u6570\u91cf <code>handle_process_affinity</code> \u5c06\u5de5\u4f5c\u8fdb\u7a0b\u7ed1\u5b9a\u5230 CPU \u6838\u5fc3 <code>true</code>, <code>false</code> <code>max_connections</code> \u6700\u5927\u5e76\u53d1\u8fde\u63a5\u6570 <code>buffer_size</code> \u5de5\u4f5c\u8fdb\u7a0b\u4f7f\u7528\u7684\u8bf7\u6c42\u7f13\u51b2\u533a\u5927\u5c0f (\u5b57\u8282) <code>activate_listeners</code> \u81ea\u52a8\u542f\u52a8\u76d1\u542c\u5668 <code>true</code>, <code>false</code> <code>front_timeout</code> \u524d\u7aef socket \u6700\u5927\u975e\u6d3b\u52a8\u65f6\u95f4 <code>connect_timeout</code> \u8fde\u63a5\u8bf7\u6c42\u7684\u6700\u5927\u975e\u6d3b\u52a8\u65f6\u95f4 <code>request_timeout</code> \u8bf7\u6c42\u7684\u6700\u5927\u975e\u6d3b\u52a8\u65f6\u95f4 <code>zombie_check_interval</code> \u68c0\u67e5\u50f5\u5c38\u4f1a\u8bdd\u7684\u95f4\u9694 <code>pid_file_path</code> \u5b58\u50a8 PID \u7684\u6587\u4ef6\u8def\u5f84"},{"location":"overview_zh/#43-listeners","title":"4.3 \u76d1\u542c\u5668 (Listeners)","text":"<p><code>[[listeners]]</code> \u90e8\u5206\u5b9a\u4e49\u4e86\u4e00\u7ec4\u63a5\u53d7\u5ba2\u6237\u7aef\u8fde\u63a5\u7684\u76d1\u542c\u5957\u63a5\u5b57\u3002\u60a8\u53ef\u4ee5\u5b9a\u4e49\u4efb\u610f\u6570\u91cf\u7684\u76d1\u542c\u5668\u3002</p> <ul> <li>\u901a\u7528\u53c2\u6570:</li> </ul> <pre><code>[[listeners]]\nprotocol = \"http\" # \u6216 \"https\", \"tcp\"\naddress = \"0.0.0.0:8080\"\n# public_address = \"1.2.3.4:80\" # \u53ef\u9009\uff0c\u7528\u4e8e\u65e5\u5fd7\u548c\u8f6c\u53d1\u5934\n# expect_proxy = true # \u53ef\u9009\uff0c\u914d\u7f6e\u5ba2\u6237\u7aef\u5957\u63a5\u5b57\u63a5\u6536 PROXY \u534f\u8bae\u5934\n</code></pre> <ul> <li>HTTP \u548c HTTPS \u76d1\u542c\u5668\u7279\u5b9a\u9009\u9879 (\u81ea\u5b9a\u4e49\u9519\u8bef\u9875\u9762):         \u60a8\u53ef\u4ee5\u4e3a HTTP \u548c HTTPS \u76d1\u542c\u5668\u5b9a\u4e49\u81ea\u5b9a\u4e49\u54cd\u5e94\uff0c\u5982 404 Not Found, 503 Service Unavailable \u7b49\u3002\u8fd9\u4e9b\u54cd\u5e94\u53ef\u4ee5\u662f\u7eaf\u6587\u672c\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b HTML \u548c\u4e00\u4e9b\u6a21\u677f\u53d8\u91cf (\u5982 <code>%REQUEST_ID%</code>)\u3002</li> </ul> <pre><code># \u5f53 Sozu \u4e0d\u77e5\u6653\u6240\u8bf7\u6c42\u7684\u57df\u540d\u6216\u8def\u5f84\u65f6\u53d1\u9001 404 \u54cd\u5e94\nanswer_404 = \"/path/to/my-404-answer.http\"\n# \u5f53\u6ca1\u6709\u53ef\u7528\u7684\u540e\u7aef\u670d\u52a1\u5668\u65f6\u53d1\u9001 503 \u54cd\u5e94\nanswer_503 = \"/path/to/my-503-answer.http\"\n</code></pre> <ul> <li>HTTPS \u76d1\u542c\u5668\u7279\u5b9a\u9009\u9879:</li> </ul> <pre><code># \u652f\u6301\u7684 TLS \u7248\u672c\u3002\u53ef\u9009\u503c:\"SSL_V2\", \"SSL_V3\", \"TLS_V12\", \"TLS_V13\"\u3002\u9ed8\u8ba4\u4e3a \"TLS_V12\" \u548c \"TLS_V13\"\u3002\n tls_versions = [\"TLS_V12\", \"TLS_V13\"]\n# \u5b9a\u4e49 sticky session cookie \u7684\u540d\u79f0\uff0c\u5982\u679c\u96c6\u7fa4\u6fc0\u6d3b\u4e86 sticky_session\u3002\u9ed8\u8ba4\u4e3a \"SOZUBALANCEID\"\u3002\nsticky_name = \"SOZUBALANCEID\"\n</code></pre> <p>\u57fa\u4e8e Rustls \u7684 HTTPS \u76d1\u542c\u5668\u7279\u5b9a\u9009\u9879\uff1a</p> <pre><code>cipher_list = [\n    # TLS 1.3 \u5bc6\u7801\u5957\u4ef6\n    \"TLS13_AES_256_GCM_SHA384\",\n    # ... \u5176\u4ed6\u5bc6\u7801\u5957\u4ef6\n]\n</code></pre>"},{"location":"overview_zh/#44-clusters","title":"4.4 \u96c6\u7fa4 (Clusters)","text":"<p>\u5728 <code>[clusters]</code> \u90e8\u5206\u58f0\u660e\u60a8\u7684\u96c6\u7fa4\u5217\u8868\uff1a</p> <pre><code>[clusters]\n[clusters.MyWebsiteCluster]\nprotocol = \"http\" # \u6216 \"tcp\"\u3002HTTPS \u4ee3\u7406\u4e5f\u4f7f\u7528 http \u534f\u8bae\n# load_balancing_policy=\"roundrobin\" # \u8d1f\u8f7d\u5747\u8861\u7b56\u7565: \"roundrobin\" (\u9ed8\u8ba4) \u6216 \"random\"\n# https_redirect = true # \u5f3a\u5236\u5c06 http \u6d41\u91cf\u91cd\u5b9a\u5411\u5230 https\n# sticky_session = true # \u53ef\u9009\uff0c\u542f\u7528 sticky session\n\nfrontends = [\n  { address = \"0.0.0.0:8080\", hostname = \"your_domain.com\" },\n  # \u5bf9\u4e8e HTTPS \u524d\u7aef\uff0c\u8fd8\u9700\u8981\u6307\u5b9a\u8bc1\u4e66\u548c\u5bc6\u94a5\n  { address = \"0.0.0.0:8443\", hostname = \"your_domain.com\", certificate = \"/path/to/certificate.pem\", key = \"/path/to/key.pem\", certificate_chain = \"/path/to/certificate_chain.pem\" }\n]\nbacks  = [\n  { address = \"127.0.0.1:8000\" }, # \u540e\u7aef\u670d\u52a1\u5668\u5730\u5740\n  { address = \"127.0.0.1:8001\" }\n]\n</code></pre>"},{"location":"overview_zh/#45-metrics","title":"4.5 \u6307\u6807 (Metrics)","text":"<p>Sozu \u901a\u8fc7 UDP \u5957\u63a5\u5b57\u5411\u5176\u4ed6\u7f51\u7edc\u7ec4\u4ef6\u62a5\u544a\u5176\u72b6\u6001\uff0c\u5e76\u5b9e\u73b0\u4e86 <code>statsd</code> \u534f\u8bae\u3002</p> <p>\u914d\u7f6e\u65b9\u5f0f\uff1a</p> <pre><code>[metrics]\naddress = \"127.0.0.1:8125\" # statsd \u670d\u52a1\u7684\u5730\u5740\u548c\u7aef\u53e3\n# tagged_metrics = false # \u4f7f\u7528 InfluxDB \u7684 statsd \u534f\u8bae\u4ee5\u6dfb\u52a0\u6807\u7b7e\n# prefix = \"sozu\" # \u6307\u6807\u952e\u524d\u7f00\n</code></pre>"},{"location":"overview_zh/#46-proxy","title":"4.6 PROXY \u534f\u8bae","text":"<p>PROXY \u534f\u8bae\u7528\u4e8e\u5728\u4ee3\u7406\u94fe\u4e2d\u4f20\u9012\u5ba2\u6237\u7aef\u7684\u771f\u5b9e IP \u5730\u5740\u548c\u7aef\u53e3\u4fe1\u606f\u3002Sozu \u652f\u6301 PROXY \u534f\u8bae\u7248\u672c 2\u3002</p> <ul> <li>\u914d\u7f6e Sozu \u671f\u671b PROXY \u534f\u8bae\u5934:</li> </ul> <pre><code>[[listeners]]\naddress = \"0.0.0.0:80\"\nexpect_proxy = true\n</code></pre> <p>\u8fd9\u4f7f\u5f97\u5ba2\u6237\u7aef\u8fde\u63a5\u5728\u8bfb\u53d6\u4efb\u4f55\u6570\u636e\u4e4b\u524d\u5148\u63a5\u6536 PROXY \u534f\u8bae\u5934\u3002</p> <ul> <li>\u914d\u7f6e Sozu \u5411\u540e\u7aef\u53d1\u9001 PROXY \u534f\u8bae\u5934:</li> </ul> <pre><code>[[listeners]]\naddress = \"0.0.0.0:81\"\n\n[clusters]\n[clusters.NameOfYourTcpCluster]\nsend_proxy = true\nfrontends = [\n  { address = \"0.0.0.0:81\" }\n]\n</code></pre> <p>\u6ce8\u610f: \u4ec5\u9002\u7528\u4e8e TCP \u96c6\u7fa4 (HTTP \u548c HTTPS \u4ee3\u7406\u5c06\u4f7f\u7528\u8f6c\u53d1\u5934)\u3002</p> <ul> <li>\u914d\u7f6e Sozu \u8f6c\u53d1 PROXY \u534f\u8bae\u5934:</li> </ul> <pre><code>[[listeners]]\naddress = \"0.0.0.0:80\"\nexpect_proxy = true\n\n[clusters]\n[clusters.NameOfYourCluster]\nsend_proxy = true\nfrontends = [\n  { address = \"0.0.0.0:80\" }\n]\n</code></pre> <p>Sozu \u5c06\u63a5\u6536\u5ba2\u6237\u7aef\u8fde\u63a5\u7684 PROXY \u534f\u8bae\u5934\uff0c\u9a8c\u8bc1\u5176\u6709\u6548\u6027\uff0c\u7136\u540e\u5c06\u5176\u8f6c\u53d1\u7ed9\u4e0a\u6e38\u540e\u7aef\u3002\u8fd9\u5141\u8bb8\u4ee3\u7406\u94fe\u5728\u4e0d\u4e22\u5931\u5ba2\u6237\u7aef\u8fde\u63a5\u4fe1\u606f\u7684\u60c5\u51b5\u4e0b\u5de5\u4f5c\u3002</p> <p>\u6ce8\u610f: \u4ec5\u9002\u7528\u4e8e TCP \u96c6\u7fa4\u3002</p>"},{"location":"overview_zh/#5","title":"5. \u52a8\u6001\u540e\u7aef\u7ba1\u7406\uff08\u670d\u52a1\u53d1\u73b0\uff09","text":"<p>\u5728 Docker \u7b49\u52a8\u6001\u73af\u5883\u4e2d\uff0c\u540e\u7aef\u670d\u52a1\u7684 IP \u5730\u5740\u53ef\u80fd\u4f1a\u9891\u7e41\u53d8\u5316\u3002\u5c3d\u7ba1 <code>config.toml</code> \u5728 Sozu \u542f\u52a8\u65f6\u89e3\u6790 IP \u5730\u5740\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528 Sozu \u63d0\u4f9b\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff08CLI\uff09\u6765\u52a8\u6001\u5730\u6dfb\u52a0\u3001\u66f4\u65b0\u6216\u79fb\u9664\u540e\u7aef\uff0c\u800c\u65e0\u9700\u91cd\u542f Sozu\u3002</p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u9700\u8981\u4e00\u4e2a\u5916\u90e8\u673a\u5236\uff08\u4f8b\u5982\u4e00\u4e2a\u7b80\u5355\u7684\u811a\u672c\u3001\u670d\u52a1\u53d1\u73b0\u5de5\u5177\u6216\u81ea\u5b9a\u4e49\u7a0b\u5e8f\uff09\u6765\uff1a</p> <ul> <li>\u76d1\u63a7\u60a8\u7684\u540e\u7aef\u670d\u52a1\uff08\u4f8b\u5982\uff0c\u901a\u8fc7 Docker API \u76d1\u542c\u5bb9\u5668\u7684\u542f\u52a8/\u505c\u6b62\u4e8b\u4ef6\uff0c\u6216\u8005\u67e5\u8be2 Docker \u7684\u5185\u7f6e DNS \u670d\u52a1\uff09\u3002</li> <li>\u83b7\u53d6\u540e\u7aef\u670d\u52a1\u7684\u5f53\u524d IP \u5730\u5740\u548c\u7aef\u53e3\u3002</li> <li>\u4f7f\u7528 <code>sozu</code> CLI \u5de5\u5177\u5411\u8fd0\u884c\u4e2d\u7684 Sozu \u5b9e\u4f8b\u53d1\u9001\u547d\u4ee4\u3002</li> </ul> <p>\u4ee5\u4e0b\u662f\u4f7f\u7528 <code>sozu</code> CLI \u7ba1\u7406\u540e\u7aef\u7684\u793a\u4f8b\uff1a</p>"},{"location":"overview_zh/#51-sozu","title":"5.1 \u542f\u52a8 Sozu \u4ee5\u63a5\u53d7\u547d\u4ee4","text":"<p>\u786e\u4fdd\u60a8\u7684 <code>config.toml</code> \u4e2d <code>command_socket</code> \u914d\u7f6e\u6b63\u786e\uff0c\u4ee5\u4fbf CLI \u5de5\u5177\u53ef\u4ee5\u8fde\u63a5\u5230\u8fd0\u884c\u4e2d\u7684 Sozu \u5b9e\u4f8b\u3002\u4f8b\u5982\uff1a</p> <pre><code>command_socket = \"/var/lib/sozu/command.sock\"\n</code></pre>"},{"location":"overview_zh/#52-docker-ip","title":"5.2 \u67e5\u627e Docker \u5bb9\u5668\u7684 IP \u5730\u5740","text":"<p>\u5047\u8bbe\u60a8\u7684 Docker \u7f51\u7edc\u540d\u4e3a <code>my-network</code>\uff0c\u540e\u7aef\u670d\u52a1\u540d\u4e3a <code>my-backend-app</code>\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>docker inspect</code> \u547d\u4ee4\u6765\u83b7\u53d6\u5176 IP \u5730\u5740\u3002</p> <pre><code># \u83b7\u53d6\u5355\u4e2a\u8fd0\u884c\u4e2d\u5bb9\u5668\u7684 IP \u5730\u5740\ndocker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' my-backend-app\n\n# \u5047\u8bbe\u60a8\u7684\u540e\u7aef\u670d\u52a1\u66b4\u9732\u5728 8080 \u7aef\u53e3\nexport BACKEND_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' my-backend-app)\nexport BACKEND_PORT=8080\nexport BACKEND_ADDRESS=\"${BACKEND_IP}:${BACKEND_PORT}\"\n</code></pre> <p>\u5728 <code>docker-compose</code> \u73af\u5883\u4e2d\uff0c\u5982\u679c\u670d\u52a1\u5728\u540c\u4e00\u4e2a <code>user-defined bridge network</code> \u4e0b\uff0c\u670d\u52a1\u540d\u901a\u5e38\u53ef\u4ee5\u76f4\u63a5\u4f5c\u4e3a\u4e3b\u673a\u540d\u89e3\u6790\u3002\u4f46\u5728 sozu \u542f\u52a8\u65f6\u89e3\u6790 IP \u7684\u60c5\u51b5\u4e0b\uff0c\u60a8\u4ecd\u7136\u9700\u8981\u5148\u83b7\u53d6 IP\u3002</p>"},{"location":"overview_zh/#53","title":"5.3 \u52a8\u6001\u6dfb\u52a0\u540e\u7aef","text":"<p>\u4f7f\u7528 <code>sozu backend add</code> \u547d\u4ee4\u5c06\u65b0\u7684\u540e\u7aef\u6dfb\u52a0\u5230\u6307\u5b9a\u7684\u96c6\u7fa4\u3002</p> <pre><code># \u5047\u8bbe\u60a8\u7684 Sozu \u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u662f /etc/sozu/config.toml\n# \u5e76\u4e14\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u5df2\u7ecf\u8bbe\u7f6e\u4e86 command_socket\n# \u5047\u8bbe\u60a8\u7684\u96c6\u7fa4 ID \u662f 'komo'\nCONFIG_PATH=\"/etc/sozu/config.toml\"\nCLUSTER_ID=\"komo\"\nNEW_BACKEND_ID=\"backend-1\" # \u4e3a\u65b0\u540e\u7aef\u63d0\u4f9b\u4e00\u4e2a\u552f\u4e00\u7684ID\nNEW_BACKEND_ADDRESS=\"172.17.0.5:9120\" # \u66ff\u6362\u4e3a\u60a8\u7684\u540e\u7aef\u5b9e\u9645 IP:\u7aef\u53e3\n\nsozu --config \"${CONFIG_PATH}\" backend add --id \"${CLUSTER_ID}\" --backend-id \"${NEW_BACKEND_ID}\" --address \"${NEW_BACKEND_ADDRESS}\"\n</code></pre> <ul> <li><code>--config</code>: \u6307\u5b9a Sozu \u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f84\uff0c\u5176\u4e2d\u5e94\u5305\u542b <code>command_socket</code> \u7684\u8def\u5f84\u3002</li> <li><code>backend add</code>: \u8868\u793a\u8981\u6267\u884c\u6dfb\u52a0\u540e\u7aef\u7684\u64cd\u4f5c\u3002</li> <li><code>--id</code>: \u6307\u5b9a\u8981\u6dfb\u52a0\u540e\u7aef\u7684\u96c6\u7fa4 ID\u3002</li> <li><code>--backend-id</code>: \u4e3a\u6b64\u540e\u7aef\u5b9e\u4f8b\u63d0\u4f9b\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u7b26\u3002</li> <li><code>--address</code>: \u6307\u5b9a\u540e\u7aef\u670d\u52a1\u5668\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u3002</li> </ul>"},{"location":"overview_zh/#54","title":"5.4 \u52a8\u6001\u79fb\u9664\u540e\u7aef","text":"<p>\u4f7f\u7528 <code>sozu backend remove</code> \u547d\u4ee4\u4ece\u6307\u5b9a\u7684\u96c6\u7fa4\u4e2d\u79fb\u9664\u540e\u7aef\u3002</p> <pre><code># \u5047\u8bbe\u60a8\u7684 Sozu \u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u662f /etc/sozu/config.toml\nCONFIG_PATH=\"/etc/sozu/config.toml\"\nCLUSTER_ID=\"komo\"\nOLD_BACKEND_ID=\"backend-1\" # \u8981\u79fb\u9664\u7684\u540e\u7aef\u7684ID\nOLD_BACKEND_ADDRESS=\"172.17.0.5:9120\" # \u66ff\u6362\u4e3a\u8981\u79fb\u9664\u7684\u540e\u7aef\u5b9e\u9645 IP:\u7aef\u53e3\n\nsozu --config \"${CONFIG_PATH}\" backend remove --id \"${CLUSTER_ID}\" --backend-id \"${OLD_BACKEND_ID}\" --address \"${OLD_BACKEND_ADDRESS}\"\n</code></pre> <ul> <li><code>--config</code>: \u6307\u5b9a Sozu \u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f84\u3002</li> <li><code>backend remove</code>: \u8868\u793a\u8981\u6267\u884c\u79fb\u9664\u540e\u7aef\u7684\u64cd\u4f5c\u3002</li> <li><code>--id</code>: \u6307\u5b9a\u8981\u79fb\u9664\u540e\u7aef\u7684\u96c6\u7fa4 ID\u3002</li> <li><code>--backend-id</code>: \u8981\u79fb\u9664\u7684\u540e\u7aef\u7684ID\u3002</li> <li><code>--address</code>: \u8981\u79fb\u9664\u7684\u540e\u7aef\u670d\u52a1\u5668\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u3002</li> </ul>"},{"location":"overview_zh/#55-sozu","title":"5.5 \u67e5\u770b S\u014dzu \u5de5\u4f5c\u8fdb\u7a0b\u72b6\u6001","text":"<p>\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>sozu status</code> \u547d\u4ee4\u6765\u67e5\u770b S\u014dzu \u5de5\u4f5c\u8fdb\u7a0b\uff08workers\uff09\u7684\u8fd0\u884c\u72b6\u6001\u3002</p> <pre><code># \u5047\u8bbe\u60a8\u7684 Sozu \u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u662f /etc/sozu/config.toml\nCONFIG_PATH=\"/etc/sozu/config.toml\"\nsozu --config \"${CONFIG_PATH}\" status --json\n</code></pre> <p>\u8fd9\u5c06\u8fd4\u56de\u4e00\u4e2a JSON \u683c\u5f0f\u7684\u5f53\u524d\u5de5\u4f5c\u8fdb\u7a0b\u72b6\u6001\u3002\u8981\u67e5\u770b\u8be6\u7ec6\u7684\u96c6\u7fa4\u3001\u524d\u7aef\u548c\u540e\u7aef\u914d\u7f6e\uff0c\u8bf7\u53c2\u9605\u4e0b\u4e00\u8282\u3002</p>"},{"location":"overview_zh/#56","title":"5.6 \u81ea\u52a8\u5316\u811a\u672c\uff08\u6982\u5ff5\uff09","text":"<p>\u8981\u5b9e\u73b0\u771f\u6b63\u7684\u670d\u52a1\u53d1\u73b0\uff0c\u60a8\u9700\u8981\u7f16\u5199\u4e00\u4e2a\u6301\u7eed\u8fd0\u884c\u7684\u811a\u672c\uff08\u4f8b\u5982\u4f7f\u7528 Python\u3001Bash \u6216 Go\uff09\uff0c\u8be5\u811a\u672c\uff1a</p> <ul> <li>\u5468\u671f\u6027\u5730\u6216\u901a\u8fc7 \u4e8b\u4ef6\u76d1\u542c Docker API \u6765\u68c0\u6d4b\u540e\u7aef\u5bb9\u5668\u7684\u53d8\u5316\u3002</li> <li>\u6bd4\u8f83\u5f53\u524d Sozu \u4e2d\u7684\u540e\u7aef\u5217\u8868\u4e0e Docker \u4e2d\u5b9e\u9645\u8fd0\u884c\u7684\u540e\u7aef\u5217\u8868\u3002</li> <li>\u6267\u884c <code>sozu backend add</code> \u6216 <code>sozu backend remove</code> \u547d\u4ee4\u6765\u540c\u6b65\u8fd9\u4e24\u4e2a\u5217\u8868\u3002</li> </ul> <p>\u8fd9\u4e2a\u811a\u672c\u5c06\u4f5c\u4e3a\u60a8\u670d\u52a1\u53d1\u73b0\u65b9\u6848\u4e2d\u7684\u201c\u63a7\u5236\u5e73\u9762\u201d\u3002</p>"},{"location":"overview_zh/#57","title":"5.7 \u67e5\u770b\u52a8\u6001\u6dfb\u52a0\u7684\u524d\u7aef\u548c\u540e\u7aef","text":"<p>\u5f53\u60a8\u901a\u8fc7\u547d\u4ee4\u884c\u52a8\u6001\u6dfb\u52a0\u4e86 <code>frontend</code> \u6216 <code>backend</code> \u540e\uff0c\u60a8\u53ef\u80fd\u60f3\u9a8c\u8bc1\u5b83\u4eec\u662f\u5426\u5df2\u6210\u529f\u52a0\u8f7d\u3002S\u014dzu \u7684\u8def\u7531\u7ed3\u6784\u662f <code>frontend</code> -&gt; <code>cluster</code> -&gt; <code>backend</code>\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u4e24\u6b65\u6765\u8ffd\u8e2a\u548c\u67e5\u770b\u8fd9\u4e9b\u52a8\u6001\u6dfb\u52a0\u7684\u6570\u636e\uff1a</p> <ul> <li> <p>\u67e5\u627e <code>frontend</code> \u5bf9\u5e94\u7684 <code>cluster ID</code></p> <p>\u4f7f\u7528 <code>sozu frontend list --json</code> \u547d\u4ee4\u53ef\u4ee5\u5217\u51fa\u6240\u6709\u5df2\u914d\u7f6e\u7684\u524d\u7aef\u3002\u5728\u8fd4\u56de\u7684 JSON \u6570\u636e\u4e2d\uff0c\u627e\u5230\u60a8\u5173\u5fc3\u7684 <code>frontend</code>\uff0c\u5e76\u8bb0\u4e0b\u5176\u6240\u5c5e\u7684 <code>cluster_id</code>\u3002</p> </li> </ul> <pre><code># \u5c06 &lt;\u60a8\u7684/config.toml/\u8def\u5f84&gt; \u66ff\u6362\u4e3a\u60a8\u7684\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\nsozu --config &lt;\u60a8\u7684/config.toml/\u8def\u5f84&gt; frontend list --json\n</code></pre> <ul> <li> <p>\u6839\u636e <code>cluster ID</code> \u67e5\u627e\u5176\u5305\u542b\u7684 <code>backend</code></p> <p>\u83b7\u53d6\u5230 <code>cluster ID</code> \u540e\uff0c\u4f7f\u7528 <code>sozu cluster list --id &lt;CLUSTER_ID&gt; --json</code> \u547d\u4ee4\u6765\u67e5\u770b\u8be5\u7279\u5b9a\u96c6\u7fa4\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5176\u4e2d\u5305\u62ec\u4e86\u5b83\u6240\u5305\u542b\u7684\u6240\u6709 <code>backend</code> \u5217\u8868\u3002</p> </li> </ul> <pre><code># \u66ff\u6362 &lt;\u60a8\u7684/config.toml/\u8def\u5f84&gt; \u548c &lt;\u60a8\u7684_CLUSTER_ID&gt;\nsozu --config &lt;\u60a8\u7684/config.toml/\u8def\u5f84&gt; cluster list --id &lt;\u60a8\u7684_CLUSTER_ID&gt; --json\n</code></pre> <p>\u901a\u8fc7\u8fd9\u4e2a\u4e24\u6b65\u6d41\u7a0b\uff0c\u60a8\u53ef\u4ee5\u6e05\u6670\u5730\u770b\u5230\u4ece <code>frontend</code> \u5230 <code>backend</code> \u7684\u5b8c\u6574\u6620\u5c04\u5173\u7cfb\uff0c\u5e76\u786e\u8ba4\u60a8\u7684\u52a8\u6001\u914d\u7f6e\u5df2\u751f\u6548\u3002</p> <p>\u5e0c\u671b\u8fd9\u4efd\u6559\u7a0b\u80fd\u5e2e\u52a9\u60a8\u66f4\u597d\u5730\u7406\u89e3\u548c\u4f7f\u7528 Sozu\uff01</p>"},{"location":"recipes/","title":"Recipes: solutions for common problems, tips and tricks","text":"<ul> <li>Recipes: solutions for common problems, tips and tricks</li> <li>Using port 80 or 443 as non root user</li> <li>Capabilities</li> <li>iptables</li> <li>High availability architecture</li> </ul>"},{"location":"recipes/#using-port-80-or-443-as-non-root-user","title":"Using port 80 or 443 as non root user","text":"<p>Port numbers under 1024 are usually not accessible to non root users. With s\u014dzu, we often need to listen on ports 80 (HTTP) and 443 (HTTPS). To avoid running s\u014dzu as root, here are some solutions to access those ports.</p>"},{"location":"recipes/#capabilities","title":"Capabilities","text":"<p>Recent linux versions (&gt; 2.2) come with a feature called capabilities, that can be activated depending on the context. To create a listen socket on reserved ports, we need the <code>CAP_NET_BIND_SERVICE</code> capability.</p> <p>We can set it up by creating an unprivileged <code>sozu</code> user, and writing the following systemd unit file:</p> <pre><code>[Unit]\nDescription=Sozu - A HTTP reverse proxy, configurable at runtime, fast and safe, built in Rust.\nDocumentation=https://docs.rs/sozu/\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nExecStart=/usr/bin/sozu start --config /etc/sozu/config.toml\nExecReload=/usr/bin/sozu --config /etc/sozu/config.toml reload\nRestart=on-failure\nUser=sozu\nAmbientCapabilities=CAP_NET_BIND_SERVICE\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>It is also possible to give the capability directly to the sozu binary with <code>setcap 'cap_net_bind_service=+eip' /usr/bin/sozu</code>, but then reserved ports would be accessible by any user than can execute s\u014dzu (so they could setup of TCP proxy for SSH, SMTP etc to their own software). The unit file is the recommended way.</p>"},{"location":"recipes/#using-unprivileged-ports","title":"Using unprivileged ports","text":"<p>Different firewalls can be used to route connections from reserved ports to other unprivileged ports. Most common redirections follow 80 -&gt; 8080 and 443 -&gt; 8443.</p>"},{"location":"recipes/#iptables","title":"iptables","text":"<p>iptables can be utilized, using a simple nat.</p> <pre><code>iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080\niptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 8443\n</code></pre>"},{"location":"recipes/#firewalld","title":"firewalld","text":"<p>firewalld's syntax is very similiar to iptables. It can be made permanent using <code>--permanent</code>.</p> <pre><code>firewall-cmd --direct --add-rule ipv4 nat PREROUTING 0 -p tcp --dport 80 -j REDIRECT --to-port 8080\nfirewall-cmd --direct --add-rule ipv4 nat PREROUTING 0 -p tcp --dport 443 -j REDIRECT --to-port 8443\n</code></pre> <p>Note that any software running under the same uid as s\u014dzu will be able to listen on the 8080 and 8443 ports, because those ports are unprivileged and s\u014dzu sets up listen socket with the <code>SO_REUSEPORT</code> option.</p>"},{"location":"recipes/#high-availability-architecture","title":"High availability architecture","text":"<p>TODO</p>"},{"location":"recipes_zh/","title":"\u914d\u65b9\uff1a\u5e38\u89c1\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\u3001\u63d0\u793a\u548c\u6280\u5de7","text":"<ul> <li>\u914d\u65b9\uff1a\u5e38\u89c1\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\u3001\u63d0\u793a\u548c\u6280\u5de7</li> <li>\u4ee5\u975e root \u7528\u6237\u8eab\u4efd\u4f7f\u7528\u7aef\u53e3 80 \u6216 443</li> <li>\u529f\u80fd</li> <li>iptables</li> <li>\u9ad8\u53ef\u7528\u6027\u67b6\u6784</li> </ul>"},{"location":"recipes_zh/#root-80-443","title":"\u4ee5\u975e root \u7528\u6237\u8eab\u4efd\u4f7f\u7528\u7aef\u53e3 80 \u6216 443","text":"<p>\u4f4e\u4e8e 1024 \u7684\u7aef\u53e3\u53f7\u901a\u5e38\u5bf9\u975e root \u7528\u6237\u4e0d\u53ef\u7528\u3002\u5bf9\u4e8e s\u014dzu\uff0c \u6211\u4eec\u7ecf\u5e38\u9700\u8981\u5728\u7aef\u53e3 80 (HTTP) \u548c 443 (HTTPS) \u4e0a\u8fdb\u884c\u4fa6\u542c\u3002\u4e3a\u4e86\u907f\u514d\u4ee5 root \u8eab\u4efd\u8fd0\u884c s\u014dzu\uff0c\u4ee5\u4e0b\u662f\u4e00\u4e9b\u8bbf\u95ee\u8fd9\u4e9b\u7aef\u53e3\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"recipes_zh/#_2","title":"\u529f\u80fd","text":"<p>\u8f83\u65b0\u7684 linux \u7248\u672c (&gt; 2.2) \u5177\u6709\u79f0\u4e3a\u529f\u80fd\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u6839\u636e \u4e0a\u4e0b\u6587\u6fc0\u6d3b\u3002\u8981\u5728\u4fdd\u7559\u7aef\u53e3\u4e0a\u521b\u5efa\u4fa6\u542c\u5957\u63a5\u5b57\uff0c \u6211\u4eec\u9700\u8981 <code>CAP_NET_BIND_SERVICE</code> \u529f\u80fd\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u975e\u7279\u6743\u7684 <code>sozu</code> \u7528\u6237\uff0c\u5e76\u7f16\u5199\u4ee5\u4e0b systemd \u5355\u5143\u6587\u4ef6\u6765\u8bbe\u7f6e\u5b83\uff1a</p> <pre><code>[Unit]\nDescription=Sozu - \u4e00\u4e2a HTTP \u53cd\u5411\u4ee3\u7406\uff0c\u53ef\u5728\u8fd0\u884c\u65f6\u914d\u7f6e\uff0c\u5feb\u901f\u4e14\u5b89\u5168\uff0c\u7528 Rust \u6784\u5efa\u3002\nDocumentation=https://docs.rs/sozu/\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nExecStart=/usr/bin/sozu start --config /etc/sozu/config.toml\nExecReload=/usr/bin/sozu --config /etc/sozu/config.toml reload\nRestart=on-failure\nUser=sozu\nAmbientCapabilities=CAP_NET_BIND_SERVICE\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>setcap 'cap_net_bind_service=+eip' /usr/bin/sozu</code> \u76f4\u63a5\u4e3a sozu \u4e8c\u8fdb\u5236\u6587\u4ef6\u63d0\u4f9b\u529f\u80fd\uff0c \u4f46\u8fd9\u6837\u4efb\u4f55\u53ef\u4ee5\u6267\u884c s\u014dzu \u7684\u7528\u6237\u90fd\u53ef\u4ee5\u8bbf\u95ee\u4fdd\u7559\u7aef\u53e3\uff08\u56e0\u6b64\u4ed6\u4eec \u53ef\u4ee5\u4e3a SSH\u3001SMTP \u7b49\u8bbe\u7f6e\u81ea\u5df1\u7684\u8f6f\u4ef6\u7684 TCP \u4ee3\u7406\uff09\u3002 \u5efa\u8bae\u4f7f\u7528\u5355\u5143\u6587\u4ef6\u7684\u65b9\u5f0f\u3002</p>"},{"location":"recipes_zh/#_3","title":"\u4f7f\u7528\u975e\u7279\u6743\u7aef\u53e3","text":"<p>\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684\u9632\u706b\u5899\u5c06\u8fde\u63a5\u4ece\u4fdd\u7559\u7aef\u53e3\u8def\u7531\u5230\u5176\u4ed6\u975e\u7279\u6743\u7aef\u53e3\u3002 \u6700\u5e38\u89c1\u7684\u91cd\u5b9a\u5411\u9075\u5faa 80 -&gt; 8080 \u548c 443 -&gt; 8443\u3002</p>"},{"location":"recipes_zh/#iptables","title":"iptables","text":"<p>\u53ef\u4ee5\u4f7f\u7528 iptables\uff0c\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 nat\u3002</p> <pre><code>iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080\niptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-ports 8443\n</code></pre>"},{"location":"recipes_zh/#firewalld","title":"firewalld","text":"<p>firewalld \u7684\u8bed\u6cd5\u4e0e iptables \u975e\u5e38\u76f8\u4f3c\u3002\u53ef\u4ee5\u4f7f\u7528 <code>--permanent</code> \u4f7f\u5176\u6c38\u4e45\u5316\u3002</p> <pre><code>firewall-cmd --direct --add-rule ipv4 nat PREROUTING 0 -p tcp --dport 80 -j REDIRECT --to-port 8080\nfirewall-cmd --direct --add-rule ipv4 nat PREROUTING 0 -p tcp --dport 443 -j REDIRECT --to-port 8443\n</code></pre> <p>\u8bf7\u6ce8\u610f\uff0c\u4efb\u4f55\u4e0e s\u014dzu \u5177\u6709\u76f8\u540c uid \u7684\u8f6f\u4ef6\u90fd\u5c06\u80fd\u591f\u5728 8080 \u548c 8443 \u7aef\u53e3\u4e0a\u8fdb\u884c\u4fa6\u542c\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u7aef\u53e3\u662f\u975e\u7279\u6743\u7684\uff0c\u5e76\u4e14 s\u014dzu \u4f7f\u7528 <code>SO_REUSEPORT</code> \u9009\u9879\u8bbe\u7f6e\u4fa6\u542c\u5957\u63a5\u5b57\u3002</p>"},{"location":"recipes_zh/#_4","title":"\u9ad8\u53ef\u7528\u6027\u67b6\u6784","text":"<p>\u5f85\u529e\u4e8b\u9879</p>"},{"location":"tools_libraries/","title":"Tools &amp; Libraries","text":""},{"location":"tools_libraries/#client-in-other-languages","title":"Client in other languages","text":"<ul> <li>Elixir - exsozu</li> </ul>"},{"location":"tools_libraries_zh/","title":"\u5de5\u5177\u548c\u5e93","text":""},{"location":"tools_libraries_zh/#_2","title":"\u5176\u4ed6\u8bed\u8a00\u7684\u5ba2\u6237\u7aef","text":"<ul> <li>Elixir - exsozu</li> </ul>"},{"location":"why_you_should_use/","title":"Why you should use S\u014dzu","text":"<ul> <li>Hot configurable: Sozu can receive configuration changes at runtime through secure unix sockets.</li> <li>Upgrades without restarting: Sozu is always-up, meaning it upgrades itself while still processing requests.</li> </ul>"},{"location":"why_you_should_use_zh/","title":"\u4e3a\u4ec0\u4e48\u4f60\u5e94\u8be5\u4f7f\u7528 S\u014dzu","text":"<ul> <li>\u70ed\u914d\u7f6e\uff1a Sozu \u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u901a\u8fc7\u5b89\u5168\u7684 unix \u5957\u63a5\u5b57\u63a5\u6536\u914d\u7f6e\u66f4\u6539\u3002</li> <li>\u65e0\u9700\u91cd\u542f\u5373\u53ef\u5347\u7ea7\uff1a Sozu \u59cb\u7ec8\u5728\u7ebf\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u53ef\u4ee5\u5728\u4ecd\u5728\u5904\u7406\u8bf7\u6c42\u7684\u540c\u65f6\u81ea\u884c\u5347\u7ea7\u3002</li> </ul>"}]}