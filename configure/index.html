
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Configure Sōzu - Sozu Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#configure-sozu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Sozu Documentation" class="md-header__button md-logo" aria-label="Sozu Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sozu Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Configure Sōzu
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/forkdo/sozu.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    forkdo/sozu
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Sozu Documentation" class="md-nav__button md-logo" aria-label="Sozu Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Sozu Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/forkdo/sozu.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    forkdo/sozu
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    English Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    English Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to use
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configure_cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_configuration_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration Example
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design_motivation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Motivation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging_strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging Strategies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexicon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lexicon
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifetime_of_a_session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifetime of a session
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recipes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools_libraries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tools and Libraries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_you_should_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why you should use Sozu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Main README
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Chinese Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Chinese Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概述
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    入门
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何使用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configure_cli_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI 配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_configuration_example_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI 配置示例
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    架构
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design_motivation_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    设计动机
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基准测试
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging_strategies_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    调试策略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexicon_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    词汇表
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifetime_of_a_session_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    会话生命周期
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    配方
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools_libraries_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    工具和库
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_you_should_use_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    为何使用 Sozu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../README_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    主 README
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration file
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration file">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#listeners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Listeners
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Listeners">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#options-specific-to-http-and-https-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Options specific to HTTP and HTTPS listeners
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#options-specific-to-https-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Options specific to HTTPS listeners
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#options-specific-to-rustls-based-https-listeners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Options specific to Rustls based HTTPS listeners
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clusters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clusters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Metrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configure metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-of-externals-services" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example of externals services
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proxy-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      
        PROXY Protocol
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PROXY Protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-sozu-to-expect-a-proxy-protocol-header" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuring Sōzu to expect a PROXY Protocol header
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-sozu-to-send-a-proxy-protocol-header-to-an-upstream-backend" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuring Sōzu to send a PROXY Protocol header to an upstream backend
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-sozu-to-relay-a-proxy-protocol-header-to-an-upstream" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuring Sōzu to relay a PROXY Protocol header to an upstream
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="configure-sozu">Configure Sōzu</h1>
<blockquote>
<p>Before a deep dive in the configuration part of the proxy, you should take a look at the <a href="../getting_started/">getting started documentation</a> if you haven't yet.</p>
</blockquote>
<h2 id="configuration-file">Configuration file</h2>
<blockquote>
<p>The configuration file uses the <a href="https://github.com/toml-lang/toml">.toml</a> format.</p>
</blockquote>
<p>Sōzu configuration process involves 3 major sources of parameters:</p>
<ul>
<li>The <code>global</code> section, which sets process-wide parameters.</li>
<li>The definition of the protocols like <code>https</code>, <code>http</code>, <code>tcp</code>.</li>
<li>The clusters sections under: <code>[clusters]</code>.</li>
</ul>
<h3 id="global-parameters">Global parameters</h3>
<p>Parameters in the global section allow you to define the global settings shared by the main process and workers (like the log level):</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th style="text-align: left;">description</th>
<th>possible values</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>saved_state</code></td>
<td style="text-align: left;">path from which sozu tries to load its state at startup</td>
<td></td>
</tr>
<tr>
<td><code>log_level</code></td>
<td style="text-align: left;">possible values are</td>
<td><code>debug</code>, <code>trace</code>, <code>error</code>, <code>warn</code>, <code>info</code></td>
</tr>
<tr>
<td><code>log_target</code></td>
<td style="text-align: left;">possible values are</td>
<td><code>stdout, tcp or udp address</code></td>
</tr>
<tr>
<td><code>access_logs_target</code></td>
<td style="text-align: left;">possible values are (if activated, sends access logs to a separate target)</td>
<td><code>stdout</code>, <code>tcp</code> or <code>udp address</code></td>
</tr>
<tr>
<td><code>command_socket</code></td>
<td style="text-align: left;">path to the unix socket command</td>
<td></td>
</tr>
<tr>
<td><code>command_buffer_size</code></td>
<td style="text-align: left;">size, in bytes, of the buffer used by the main process to handle commands.</td>
<td></td>
</tr>
<tr>
<td><code>max_command_buffer_size</code></td>
<td style="text-align: left;">maximum size of the buffer used by the main process to handle commands.</td>
<td></td>
</tr>
<tr>
<td><code>worker_count</code></td>
<td style="text-align: left;">number of workers</td>
<td></td>
</tr>
<tr>
<td><code>worker_automatic_restart</code></td>
<td style="text-align: left;">if activated, workers that panicked or crashed are restarted (activated by default)</td>
<td></td>
</tr>
<tr>
<td><code>handle_process_affinity</code></td>
<td style="text-align: left;">bind workers to cpu cores.</td>
<td></td>
</tr>
<tr>
<td><code>max_connections</code></td>
<td style="text-align: left;">maximum number of simultaneous / opened connections</td>
<td></td>
</tr>
<tr>
<td><code>max_buffers</code></td>
<td style="text-align: left;">maximum number of buffers use to proxying</td>
<td></td>
</tr>
<tr>
<td><code>min_buffers</code></td>
<td style="text-align: left;">minimum number of buffers preallocated for proxying</td>
<td></td>
</tr>
<tr>
<td><code>buffer_size</code></td>
<td style="text-align: left;">size, in bytes, of requests buffer use by the workers</td>
<td></td>
</tr>
<tr>
<td><code>ctl_command_timeout</code></td>
<td style="text-align: left;">maximum time the command line will wait for a command to complete</td>
<td></td>
</tr>
<tr>
<td><code>pid_file_path</code></td>
<td style="text-align: left;">stores the pid in a specific file location</td>
<td></td>
</tr>
<tr>
<td><code>front_timeout</code></td>
<td style="text-align: left;">maximum time of inactivity for a front socket</td>
<td></td>
</tr>
<tr>
<td><code>connect_timeout</code></td>
<td style="text-align: left;">maximum time of inactivity for a request to connect</td>
<td></td>
</tr>
<tr>
<td><code>request_timeout</code></td>
<td style="text-align: left;">maximum time of inactivity for a request</td>
<td></td>
</tr>
<tr>
<td><code>zombie_check_interval</code></td>
<td style="text-align: left;">duration between checks for zombie sessions</td>
<td></td>
</tr>
<tr>
<td><code>activate_listeners</code></td>
<td style="text-align: left;">automatically start listeners</td>
<td></td>
</tr>
</tbody>
</table>
<p><em>Example:</em></p>
<pre><code class="language-toml">command_socket = &quot;./command_folder/sock&quot;
saved_state = &quot;./state.json&quot;
log_level = &quot;info&quot;
log_target = &quot;stdout&quot;
command_buffer_size = 16384
worker_count = 2
handle_process_affinity = false
max_connections = 500
max_buffers = 500
buffer_size = 16384
activate_listeners = true
</code></pre>
<h3 id="listeners">Listeners</h3>
<p>The <em>listener</em> section describes a set of listening sockets accepting client connections.
You can define as many listeners as you want.
They follow the format:</p>
<p><em>General parameters:</em></p>
<pre><code class="language-toml">[[listeners]]
# possible values are http, https or tcp
protocol = &quot;http&quot;
# listening address
address = &quot;0.0.0.0:8080&quot;
# address = &quot;[::]:8080&quot;

# specify a different IP than the one the socket sees, for logs and forwarded headers
# public_address = &quot;1.2.3.4:80

# Configures the client socket to receive a PROXY protocol header
# expect_proxy = false
</code></pre>
<h4 id="options-specific-to-http-and-https-listeners">Options specific to HTTP and HTTPS listeners</h4>
<p>Since version 1.0.0, Sōzu allows custom HTTP answers defined for HTTP and HTTPS listeners.</p>
<p>These answers are customizable:</p>
<ul>
<li>301 Moved Permanently</li>
<li>400 Bad Request</li>
<li>401 Unauthorized</li>
<li>404 Not Found</li>
<li>408 Request Timeout</li>
<li>413 Payload Too Large</li>
<li>502 Bad Gateway</li>
<li>503 Service Unavailable</li>
<li>504 Gateway Timeout</li>
<li>507 Insufficient Storage</li>
</ul>
<p>These answers are to be provided in plain text files of whichever extension (we recommend <code>.http</code>
for clarity) and may look like this:</p>
<pre><code class="language-html">HTTP/1.1 404 Not Found
Cache-Control: no-cache
Connection: close
Sozu-Id: %REQUEST_ID

&lt;style&gt;pre{background:#EEE;padding:10px;border:1px solid #AAA;border-radius: 5px;}&lt;/style&gt;
&lt;h1&gt;404 Not Found&lt;/h1&gt;

&lt;p&gt;insert your custom text here, in fact, all HTML is changeable, including the CSS.&lt;/p&gt;

&lt;pre&gt;
{
    \&quot;route\&quot;: \&quot;%ROUTE\&quot;,
    \&quot;request_id\&quot;: \&quot;%REQUEST_ID\&quot;,
}
&lt;/pre&gt;
&lt;footer&gt;This is an automatic answer by Sozu.&lt;/footer&gt;&quot;,
</code></pre>
<p>There are a number of available template variables, like <code>REQUEST_ID</code> or <code>CLUSTER_ID</code>, that will be replaced
by the proxying logic when producing the error.</p>
<p>To create your own custom HTTP answers, we highly suggest you first copy the default answers present
in <code>lib/src/protocol/kawa_h1/answers.rs</code>, and then change them to your liking. Feel free to remove the
<code>\r</code> newlines of the default strings for clarity.
Sōzu will parse your file and replace whatever newline symbol(s) you use.</p>
<p>Then, for each listener, provide the absolute paths of each custom answer.</p>
<pre><code class="language-toml"># a 404 response is sent when sozu does not know about the requested domain or path
answer_404 = &quot;/path/to/my-404-answer.http&quot;
# a 503 response is sent if there are no backend servers available
answer_503 = &quot;/path/to/my-503-answer.http&quot;
# answer_507 = ...
</code></pre>
<p>If a frontend has a <code>sticky_session</code>, the sticky name is defined at the listener level.</p>
<pre><code class="language-toml"># defines the sticky session cookie's name, if `sticky_session` is activated format
# a cluster. Defaults to &quot;SOZUBALANCEID&quot;
sticky_name = &quot;SOZUBALANCEID&quot;
</code></pre>
<h4 id="options-specific-to-https-listeners">Options specific to HTTPS listeners</h4>
<pre><code class="language-toml"># supported TLS versions. Possible values are &quot;SSL_V2&quot;, &quot;SSL_V3&quot;,
# &quot;TLS_V12&quot;, &quot;TLS_V13&quot;. Defaults to &quot;TLS_V12&quot; and &quot;TLS_V13&quot;
tls_versions = [&quot;TLS_V12&quot;, &quot;TLS_V13&quot;]
</code></pre>
<h4 id="options-specific-to-rustls-based-https-listeners">Options specific to Rustls based HTTPS listeners</h4>
<pre><code class="language-toml"># option specific to rustls based HTTPS listeners
cipher_list = [
    # TLS 1.3 cipher suites
    &quot;TLS13_AES_256_GCM_SHA384&quot;,
    &quot;TLS13_AES_128_GCM_SHA256&quot;,
    &quot;TLS13_CHACHA20_POLY1305_SHA256&quot;,
    # TLS 1.2 cipher suites
    &quot;TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384&quot;,
    &quot;TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256&quot;,
    &quot;TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256&quot;,
    &quot;TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384&quot;,
    &quot;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&quot;,
    &quot;TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256&quot;,
]
</code></pre>
<h3 id="clusters">Clusters</h3>
<p>You can declare the list of your <em>clusters</em> under the <code>[clusters]</code> section.
They follow the format:</p>
<p><em>Mandatories parameters:</em></p>
<pre><code class="language-toml">[clusters]

[clusters.NameOfYourCluster]
# possible values are http or tcp
# https proxies will use http here
protocol = &quot;http&quot;

# per cluster load balancing algorithm. The possible values are
# &quot;roundrobin&quot; and &quot;random&quot;. Defaults to &quot;roundrobin&quot;
# load_balancing_policy=&quot;roundrobin&quot;

# force cluster to redirect http traffic to https
# https_redirect = true

frontends = [
  { address = &quot;0.0.0.0:8080&quot;, hostname = &quot;lolcatho.st&quot; },
  { address = &quot;0.0.0.0:8443&quot;, hostname = &quot;lolcatho.st&quot;, certificate = &quot;../lib/assets/certificate.pem&quot;, key = &quot;../lib/assets/key.pem&quot;, certificate_chain = &quot;../lib/assets/certificate_chain.pem&quot; }
]
# additional options for frontends: sticky_session (boolean)

backends  = [
  { address = &quot;127.0.0.1:1026&quot; }
]
</code></pre>
<h2 id="metrics">Metrics</h2>
<p>Sōzu reports its own state to another network component through a <code>UDP</code> socket.
The main process and the workers are responsible to send their states.
We implement the <a href="https://github.com/b/statsd_spec">statsd</a> protocol to send statistics.
Any service that understands the <code>statsd</code> protocol can then gather metrics from Sōzu.</p>
<h3 id="configure-metrics">Configure metrics</h3>
<p>In your <code>config.toml</code>, you can define the address and port of your external service by adding:</p>
<pre><code class="language-toml">[metrics]
address = &quot;127.0.0.1:8125&quot;
# use InfluxDB's statsd protocol flavor to add tags
# tagged_metrics = false
# metrics key prefix
# prefix = &quot;sozu&quot;
</code></pre>
<p>Currently, we can't change the frequency of sending messages.</p>
<h3 id="example-of-externals-services">Example of externals services</h3>
<ul>
<li><a href="https://github.com/etsy/statsd">statsd</a></li>
<li><a href="https://github.com/geal/grad">grad</a></li>
</ul>
<h2 id="proxy-protocol">PROXY Protocol</h2>
<p>When a network stream goes through a proxy, the backend server will only see the IP address and port used by the proxy as client address.
The real source IP address and port will only be seen by the proxy.
Since this information is useful for logging, security, etc,
the <a href="https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt">PROXY protocol</a> was developed to transmit it to backend servers.
With this protocol, after connecting to the backend server, the proxy will first send a small header indicating the client IP address and port,
and the proxy's receiving IP address and port, and will then send the stream from the client.</p>
<p>Sōzu support the <em>version 2</em> of the <code>PROXY protocol</code> in three configurations:</p>
<ul>
<li>"send" protocol: Sōzu, in TCP proxy mode, will send the header to the backend server</li>
<li>"expect" protocol: Sōzu receives the header from a proxy, interprets it for its own logging and metrics, and uses it in HTTP forwarding headers</li>
<li>"relay" protocol: Sōzu, in TCP proxy mode, can receive the header, and transmit it to a backend server</li>
</ul>
<p>More information here: <a href="https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt">proxy-protocol spec</a></p>
<h3 id="configuring-sozu-to-expect-a-proxy-protocol-header">Configuring Sōzu to <em>expect</em> a PROXY Protocol header</h3>
<p>Configures the client-facing connection to receive a PROXY protocol header before any byte sent by the client is read from the socket.</p>
<pre><code class="language-txt">                           send PROXY                    expect PROXY
                           protocol header               protocol header
    +--------+
    | client |             +---------+                   +------------+      +-----------+
    |        |             | proxy   |                   | Sozu       |      | upstream  |
    +--------+  ---------&gt; | server  |  ---------------&gt; |            |------| server    |
   /        /              |         |                   |            |      |           |
  /________/               +---------+                   +------------+      +-----------+
</code></pre>
<p>It is supported by HTTP, HTTPS and TCP proxies.</p>
<p><em>Configuration:</em></p>
<pre><code class="language-toml">[[listeners]]
address = &quot;0.0.0.0:80&quot;
expect_proxy = true
</code></pre>
<h3 id="configuring-sozu-to-send-a-proxy-protocol-header-to-an-upstream-backend">Configuring Sōzu to <em>send</em> a PROXY Protocol header to an upstream backend</h3>
<p>Send a PROXY protocol header over any connection established to the backends declared in the cluster.</p>
<pre><code class="language-txt">                           send PROXY
    +--------+             protocol header
    | client |             +---------+                +-----------------+
    |        |             | Sozu    |                | proxy/upstream  |
    +--------+  ---------&gt; |         |  ------------&gt; | server          |
   /        /              |         |                |                 |
  /________/               +---------+                +-----------------+
</code></pre>
<p><em>Configuration:</em></p>
<pre><code class="language-toml">[[listeners]]
address = &quot;0.0.0.0:81&quot;

[clusters]
[clusters.NameOfYourTcpCluster]
send_proxy = true
frontends = [
  { address = &quot;0.0.0.0:81&quot; }
]
</code></pre>
<p>NOTE: Only for TCP clusters (HTTP and HTTPS proxies will use the forwarding headers).</p>
<h3 id="configuring-sozu-to-relay-a-proxy-protocol-header-to-an-upstream">Configuring Sōzu to <em>relay</em> a PROXY Protocol header to an upstream</h3>
<p>Sōzu will receive a PROXY protocol header from the client connection, check its validity and then forward it to an upstream backend. This allows for chains of reverse-proxies without losing the client connection information.</p>
<pre><code class="language-txt">                           send PROXY                       expect PROXY               send PROXY
                           protocol header                  protocol header            protocol header
    +--------+
    | client |             +---------+                      +------------+             +-------------------+
    |        |             | proxy   |                      | Sozu       |             | proxy/upstream    |
    +--------+  +--------&gt; | server  |  +-----------------&gt; |            | +---------&gt; | server            |
   /        /              |         |                      |            |             |                   |
  /________/               +---------+                      +------------+             +-------------------+
</code></pre>
<p><em>Configuration:</em></p>
<p>This only concerns TCP clusters (HTTP and HTTPS proxies can work directly in expect mode, and will use the forwarding headers).</p>
<pre><code class="language-toml">[[listeners]]
address = &quot;0.0.0.0:80&quot;
expect_proxy = true

[clusters]

[clusters.NameOfYourCluster]
send_proxy = true
frontends = [
  { address = &quot;0.0.0.0:80&quot; }
]
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>