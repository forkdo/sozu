
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../benchmark/">
      
      
        <link rel="next" href="../lexicon/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Debugging Strategies - Sozu Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-debug-sozu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Sozu Documentation" class="md-header__button md-logo" aria-label="Sozu Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Sozu Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Debugging Strategies
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/forkdo/sozu.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    forkdo/sozu
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Sozu Documentation" class="md-nav__button md-logo" aria-label="Sozu Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Sozu Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/forkdo/sozu.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    forkdo/sozu
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    English Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    English Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How to use
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configure_cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_configuration_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Configuration Example
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design_motivation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Motivation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmark
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Debugging Strategies
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging Strategies
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gathering-information" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gathering information
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gathering information">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dumping-the-state-through-sozu-command-line" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dumping the state through sozu command line
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#graphs-and-metrics-to-follow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graphs and metrics to follow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Graphs and metrics to follow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracking-valid-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking valid traffic
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracking valid traffic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-status-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP status metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-transmitted" class="md-nav__link">
    <span class="md-ellipsis">
      
        data transmitted
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        Response time
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocols
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracking-failed-requests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking failed requests
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scalability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tls-specific-information" class="md-nav__link">
    <span class="md-ellipsis">
      
        TLS specific information
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classic-error-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classic error scenarios
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classic error scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routing-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Routing issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-server-unavailable" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend server unavailable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zombies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zombies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invalid-session-close" class="md-nav__link">
    <span class="md-ellipsis">
      
        Invalid session close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accept-queue-filling-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        accept queue filling up
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#during-development" class="md-nav__link">
    <span class="md-ellipsis">
      
        During development
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="During development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracking-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexicon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lexicon
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifetime_of_a_session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifetime of a session
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recipes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools_libraries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tools and Libraries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_you_should_use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Why you should use Sozu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Main README
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Chinese Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Chinese Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    概述
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    入门
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how_to_use_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    如何使用
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../configure_cli_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI 配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli_configuration_example_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI 配置示例
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    架构
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design_motivation_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    设计动机
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基准测试
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging_strategies_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    调试策略
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lexicon_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    词汇表
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifetime_of_a_session_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    会话生命周期
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recipes_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    配方
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tools_libraries_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    工具和库
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why_you_should_use_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    为何使用 Sozu
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../README_zh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    主 README
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gathering-information" class="md-nav__link">
    <span class="md-ellipsis">
      
        Gathering information
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Gathering information">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dumping-the-state-through-sozu-command-line" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dumping the state through sozu command line
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Logging
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#graphs-and-metrics-to-follow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graphs and metrics to follow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Graphs and metrics to follow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracking-valid-traffic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking valid traffic
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracking valid traffic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access logs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http-status-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTTP status metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-transmitted" class="md-nav__link">
    <span class="md-ellipsis">
      
        data transmitted
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#response-time" class="md-nav__link">
    <span class="md-ellipsis">
      
        Response time
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocols
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracking-failed-requests" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking failed requests
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scalability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scalability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tls-specific-information" class="md-nav__link">
    <span class="md-ellipsis">
      
        TLS specific information
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#classic-error-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Classic error scenarios
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Classic error scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#routing-issues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Routing issues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backend-server-unavailable" class="md-nav__link">
    <span class="md-ellipsis">
      
        Backend server unavailable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zombies" class="md-nav__link">
    <span class="md-ellipsis">
      
        Zombies
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invalid-session-close" class="md-nav__link">
    <span class="md-ellipsis">
      
        Invalid session close
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accept-queue-filling-up" class="md-nav__link">
    <span class="md-ellipsis">
      
        accept queue filling up
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#during-development" class="md-nav__link">
    <span class="md-ellipsis">
      
        During development
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="During development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracking-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracking metrics
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="how-to-debug-sozu">How to debug sozu</h1>
<p>Sozu provides logs and metrics allowing detection of most production issues.</p>
<h2 id="gathering-information">Gathering information</h2>
<h3 id="dumping-the-state-through-sozu-command-line">Dumping the state through sozu command line</h3>
<p>It is useful to gather information on the configuration state in a production system.
Here are some commands you can use to take a snapshot of the current state:</p>
<pre><code class="language-bash">sozu -c /etc/config.toml status&quot;
sozu -c /etc/config.toml metrics get&quot;
sozu -c /etc/config.toml clusters list&quot;
sozu -c /etc/config.toml state save -f &quot;sozu-state-$(date -Iseconds).txt&quot;
</code></pre>
<h3 id="logging">Logging</h3>
<p>There are three configuration options related to logging:</p>
<ul>
<li><code>log_level</code>: sets logging verbosity</li>
<li><code>log_target</code>: where logs are sent. It can have the following formats:</li>
<li><code>stdout</code></li>
<li><code>udp://127.0.0.1:9876</code></li>
<li><code>tcp://127.0.0.1:9876</code></li>
<li><code>unix:///var/sozu/logs</code></li>
<li><code>file:///var/logs/sozu.log</code></li>
<li><code>access_logs_target</code>: if activated, sends the access logs to a separate destination</li>
</ul>
<p><code>log_level</code> follows <a href="https://docs.rs/env_logger/0.5.13/env_logger/">env_logger's level directives</a>.
Moreover, the <code>RUST_LOG</code> environment variable can be used to override the log level.</p>
<p>If sozu is built in release mode, the <code>DEBUG</code> and <code>TRACE</code> log levels are not compiled in,
unless you set the compilation features <code>logs-debug</code> and <code>logs-trace</code>.</p>
<h3 id="metrics">Metrics</h3>
<p>Various metrics are generated while sozu is running. They can be accessed in two ways:</p>
<ul>
<li>through <code>sozu metrics get</code>, which will display metrics for the main process and workers. Counters are refreshed between each call</li>
<li>by UDP, following the statsd protocol (optionally with support for InfluxDB's tags)</li>
</ul>
<p>Here is how you can set up metrics with statsd in the configuration file:</p>
<pre><code class="language-toml">[metrics]
address = &quot;127.0.0.1:8125&quot;
# use InfluxDB's statsd protocol flavor to add tags (default: false)
tagged_metrics = true
# metrics key prefix (default: sozu)
# prefix = &quot;sozu&quot;
</code></pre>
<h2 id="graphs-and-metrics-to-follow">Graphs and metrics to follow</h2>
<p>(assuming we set <code>sozu</code> as metric prefix)</p>
<h3 id="tracking-valid-traffic">Tracking valid traffic</h3>
<h4 id="access-logs">Access logs</h4>
<p>Access logs have the following format:</p>
<pre><code class="language-txt">2018-09-21T14:01:51Z 821136800672570 71013 WRK-00 INFO  450b071a-53b8-4fd7-b2f2-1213f03ef032 MyCluster      127.0.0.1:52323 -&gt; 127.0.0.1:1027       241ms 855μs 560 33084   200 OK lolcatho.st:8080 GET /
</code></pre>
<p>From left to right:</p>
<ul>
<li>date in ISO8601 format, UTC timezone</li>
<li>monotonic clock (in case some messages appear in the wrong order)</li>
<li>PID</li>
<li>worker name ("MAIN" for the main process)</li>
<li>log level</li>
<li>request id (UUID, generated randomly for each request, changes on the same connection if doing multiple requests in keep-alive)</li>
<li>cluster id</li>
<li>client's source IP and port</li>
<li>backend server's destination IP and port</li>
<li>response time (from first byte received from the client, to last byte sent to the client)</li>
<li>service time (time spent by sozu handling the session)</li>
<li>uploaded bytes</li>
<li>downloaded bytes</li>
</ul>
<h4 id="http-status-metrics">HTTP status metrics</h4>
<p>The following metrics track requests that are correctly sent to the backend servers:</p>
<ul>
<li><code>sozu.http.status.1xx</code>: counts requests with 100 to 199 status</li>
<li><code>sozu.http.status.2xx</code>: counts requests with 200 to 299 status</li>
<li><code>sozu.http.status.3xx</code>: counts requests with 300 to 399 status</li>
<li><code>sozu.http.status.4xx</code>: counts requests with 400 to 499 status</li>
<li><code>sozu.http.status.5xx</code>: counts requests with 500 to 599 status</li>
<li><code>sozu.http.requests</code>: incremented at each request (sum of above counters)</li>
</ul>
<h4 id="data-transmitted">data transmitted</h4>
<p>There are global <code>sozu.bytes_in</code> and <code>sozu.bytes_out</code> metrics counting the front traffic
for sozu.
These metrics can also have a backend ID and cluster ID. They would then indicate
bytes in and out from the point of view of the backend server.</p>
<h4 id="response-time">Response time</h4>
<p>?</p>
<h4 id="protocols">Protocols</h4>
<p>Client sessions can be at various state of their network protocols. As an example, a connection
could go from "Expect proxy protocol" (assuming there's a TCP proxy in front) to TLS handshake,
to HTTPS, to WSS (websockets over TLS).</p>
<p>You can track the following gauges indicating the current protocol usage:</p>
<ul>
<li><code>sozu.protocol.proxy.expect</code></li>
<li><code>sozu.protocol.proxy.send</code></li>
<li><code>sozu.protocol.proxy.relay</code></li>
<li><code>sozu.protocol.tcp</code></li>
<li><code>sozu.protocol.tls.handshake</code></li>
<li><code>sozu.protocol.http</code></li>
<li><code>sozu.protocol.https</code></li>
<li><code>sozu.protocol.ws</code></li>
<li><code>sozu.protocol.wss</code></li>
</ul>
<h3 id="tracking-failed-requests">Tracking failed requests</h3>
<p>Sozu has a way of answering to invalid traffic with minimal resource usage, sending predefined answers.
It does that for invalid traffic (not standard compliant) and routing issues (unknown host and/or path,
unresponsive backend server).</p>
<p>The <code>sozu.http.errors</code> counter is the sum of failed requests. It contains the following:</p>
<ul>
<li><code>sozu.http.frontend_parse_errors</code>: sozu received some invalid traffic</li>
<li><code>sozu.http.400.errors</code>: cannot parse hostname</li>
<li><code>sozu.http.404.errors</code>: unknown hostname and/or path</li>
<li><code>sozu.http.413.errors</code>: request too large</li>
<li><code>sozu.http.503.errors</code>: could not connect to backend server, or no backend server available for the corresponding cluster</li>
</ul>
<p>Going further, backend connections issues are tracked by the following metrics:</p>
<ul>
<li><code>sozu.backend.connections.error</code>: could not connect to a backend server</li>
<li><code>sozu.backend.down</code>: the retry policy triggered and marked the backend server as down</li>
</ul>
<p>The <code>sozu.http.503.errors</code> metric is incremented after a request sent back a 503 error, and a 503 error is sent
after the circuit breaker triggered (we wait for 3 failed connections to the backend server).</p>
<p>A backend connection error would result in the following log message:</p>
<pre><code class="language-txt">2018-09-21T14:36:08Z 823194694977734 71501 WRK-00 ERROR 839f592b-a194-4c3b-848b-8ef024129969    MyCluster    error connecting to backend, trying again
</code></pre>
<p>The circuit breaker triggering will write this to the logs:</p>
<pre><code class="language-txt">2018-09-21T14:36:57Z 823243245414405 71524 WRK-00 ERROR 7029d66e-57a8-406e-ae61-e4bf9ff7b6b8    MyCluster    max connection attempt reached
</code></pre>
<p>The retry policy marking a backend server as down will write the following log message:</p>
<pre><code class="language-txt">2018-09-21T14:37:31Z 823277868708804 71524 WRK-00 ERROR no more available backends for cluster MyCluster
</code></pre>
<h3 id="scalability">Scalability</h3>
<p>Sozu handles its resource usage finely, and puts hard limits on the number of requests
or memory usage.</p>
<p>To track connections, follow these gauges:</p>
<ul>
<li><code>sozu.client.connections</code> for frontend connections</li>
<li><code>sozu.backend.connections</code> for backend connections</li>
<li><code>sozu.http.active_requests</code> for currently active connections (a keep alive connection that's waiting
for the next request is marked as not active)</li>
</ul>
<p>Client connections should always be higher than backend connections, and backend connections should be higher than
active requests (an inactive session can keep a backend connection around).</p>
<p>These metrics are closely linked to resource usage, which is tracked by the following:</p>
<ul>
<li><code>sozu.slab.entries</code>: number of slots used in the slab allocator. Typically, there's one slot per listener socket,
one for the connection to the main process, one for the metrics socket, then one per frontend connection and
one per backend connection. So the number of connections should always be close to (but lower than) the slab count.</li>
<li><code>sozu.buffer.number</code>: number of buffers used in the buffer pool. Inactive sessions and requests for which we send
a default answer (400, 404, 413, 503 HTTP errors) do not use buffers. Active HTTP sessions use one buffer (except
in pipelining mode), WebSocket sessions use two buffers. So the number of buffers should always be lower than the
slab count, and lower than the number of connections.</li>
<li><code>sozu.zombies</code>: sozu integrates a zombie session checker. If some session did not do anything for a while, there's
probably a bug in the event loop or the protocol implementations, so its internal state is logged. This counter
is incremented for each zombie session that gets deleted.</li>
</ul>
<p>New connections are put into a queue, and wait until the session is created (if we have available resources),
or until a configurable timeout has elapsed. The following metrics observe the accept queue usage:</p>
<ul>
<li><code>sozu.accept_queue.connections</code>: number of sockets in the accept queue</li>
<li><code>sozu.accept_queue.timeout</code>: incremented every time a socket stayed too long in the queue and is closed</li>
<li><code>sozu.accept_queue.wait_time</code>: every time a session is created, this metric records how long the socket had to wait in the accept queue</li>
</ul>
<h3 id="tls-specific-information">TLS specific information</h3>
<p>TLS version counter:</p>
<ul>
<li><code>sozu.tls.version.SSLv2</code></li>
<li><code>sozu.tls.version.SSLv3</code></li>
<li><code>sozu.tls.version.TLSv1_0</code></li>
<li><code>sozu.tls.version.TLSv1_1</code></li>
<li><code>sozu.tls.version.TLSv1_2</code></li>
<li><code>sozu.tls.version.TLSv1_3</code></li>
<li><code>sozu.tls.version.Unknown</code></li>
</ul>
<p>Rustls specific, negotiated ciphersuite:</p>
<ul>
<li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256</code></li>
<li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</code></li>
<li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</code></li>
<li><code>sozu.tls.cipher.TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</code></li>
<li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</code></li>
<li><code>sozu.tls.cipher.TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</code></li>
<li><code>sozu.tls.cipher.TLS13_CHACHA20_POLY1305_SHA256</code></li>
<li><code>sozu.tls.cipher.TLS13_AES_256_GCM_SHA384</code></li>
<li><code>sozu.tls.cipher.TLS13_AES_128_GCM_SHA256</code></li>
<li><code>sozu.tls.cipher.Unsupported</code></li>
</ul>
<h2 id="classic-error-scenarios">Classic error scenarios</h2>
<h3 id="routing-issues">Routing issues</h3>
<p>Normal traffic (<code>sozu.http.requests</code>) drops while 404 (<code>sozu.http.404.errors</code>) and
503 (<code>sozu.http.503.errors</code>), that means sozu's configuration is probably invalid.
Check the configuration state with;</p>
<pre><code class="language-bash">sozu -c /etc/config.toml clusters list
</code></pre>
<p>And, for the complete configuration for a specific cluster id:</p>
<pre><code class="language-bash">sozu -c /etc/config.toml clusters list -i cluster_id
</code></pre>
<h3 id="backend-server-unavailable">Backend server unavailable</h3>
<p><code>sozu.http.503.errors</code> increases, lots of <code>sozu.backend.connections.error</code> and a
<code>sozu.backend.down</code> record: a backend server is down.
Check the logs for <code>error connecting to backend, trying again</code> and <code>no more available backends for cluster &lt;cluster_id&gt;</code>
to find out which cluster is affected</p>
<h3 id="zombies">Zombies</h3>
<p>if the <code>sozu.zombies</code> metric triggers, this means there's an event loop or protocol implementation
bug. The logs should contain the internal state of the sessions that were killed. Please copy those
logs and open an issue to sozu.</p>
<p>It usually comes with the <code>sozu.slab.entries</code> increasing while the number of connections or active requests stays
the same. The slab count will then drop when the zombie checker activates.</p>
<h3 id="invalid-session-close">Invalid session close</h3>
<p>if the slab count and active requests stay the same but <code>sozu.client.connections</code> and/or <code>sozu.backend.connections</code>
are increasing, it means sessions are not properly closed by sozu, please open an issue for this.
(if the slab count stays constant, sockets should still be closed properly, though)</p>
<h3 id="accept-queue-filling-up">accept queue filling up</h3>
<p>if <code>sozu.accept_queue.connections</code> is increasing, that means the accept queue is filling up because sozu is under
heavy load (in a healthy load, this queue is almost always empty). <code>sozu.accept_queue.wait_time</code> should increase
as well. If <code>sozu.accept_queue.timeout</code> is higher than zero, sozu cannot accept sessions fast enough and
is rejecting traffic.</p>
<h2 id="during-development">During development</h2>
<p>In the config.toml file:</p>
<ul>
<li>if the bug only affects one of the protocols (HTTP, HTTPS or TCP), deactivate the other ones</li>
<li>set <code>worker_count</code> to 1 to avoid duplicates in the log</li>
<li>to debug panics:</li>
<li>start sozu with <code>RUST_BACKTRACE=1</code></li>
<li>set <code>worker_automatic_restart</code> to false (so sozu can stop immediately)</li>
</ul>
<h3 id="tracking-metrics">Tracking metrics</h3>
<p>The <a href="https://github.com/geal/grad">grad metrics tool</a> was developed to easily aggregate statsd
metric and display them.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>